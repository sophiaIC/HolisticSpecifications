%% For double-blind review submission, w/o CCS and ACM Reference (max submission space)
\documentclass[acmsmall,review,anonymous]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For double-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review,anonymous]{acmart}\settopmatter{printfolios=true}
%% For single-blind review submission, w/o CCS and ACM Reference (max submission space)
%\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For single-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true}
%% For final camera-ready submission, w/ required CCS and ACM Reference
%\documentclass[acmsmall]{acmart}\settopmatter{}


%% Journal information
%% Supplied to authors by publisher for camera-ready submission;
%% use defaults for review submission.
\acmJournal{PACMPL}
\acmVolume{1}
\acmNumber{CONF} % CONF = POPL or ICFP or OOPSLA
\acmArticle{1}
\acmYear{2022}
\acmMonth{1}
\acmDOI{} % \acmDOI{10.1145/nnnnnnn.nnnnnnn}
\startPage{1}

%% Copyright information
%% Supplied to authors (based on authors' rights management selection;
%% see authors.acm.org) by publisher for camera-ready submission;
%% use 'none' for review submission.
\setcopyright{none}
%\setcopyright{acmcopyright}
%\setcopyright{acmlicensed}
%\setcopyright{rightsretained}
%\copyrightyear{2018}           %% If different from \acmYear

%% Bibliography style
\bibliographystyle{ACM-Reference-Format}
%% Citation style
%% Note: author/year citations are required for papers published as an
%% issue of PACMPL.
\citestyle{acmauthoryear}   %% For author/year citations


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Note: Authors migrating a paper from PACMPL format to traditional
%% SIGPLAN proceedings format must update the '\documentclass' and
%% topmatter commands above; see 'acmart-sigplanproc-template.tex'.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%% Some recommended packages.
\usepackage{booktabs}   %% For formal tables:
                        %% http://ctan.org/pkg/booktabs
\usepackage{subcaption} %% For complex figures with subfigures/subcaptions
                        %% http://ctan.org/pkg/subcaption
                        

\usepackage{relsize}
\usepackage{mathpartir}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{listings}
\usepackage{tcolorbox}
\usepackage{xspace}

\newtcolorbox{proofBox}[3][]
{
  colframe = #3,
  colback  = #2,
  #1,
}


%constrained reduction
\newcommand{\constrained}{\mathrel{\leadsto\ \!\!\!\!{\raisebox{1pt}{$\mathsmaller{\mathsmaller{\mathsmaller{\mathsmaller\rvert}}}$}}}}
\newcommand{\reduction}[4]{#1\ \fcmp\ #2\ \bullet\ #3\ \leadsto\ #4}
\newcommand{\reductions}[4]{#1\ \fcmp\ #2\ \bullet\ #3\ \leadsto^*\ #4}
\newcommand{\constrainedReduction}[4]{#1\ \fcmp\ #2\ \bullet\ #3\ \constrained\ #4}
\newcommand{\constrainedReductions}[4]{#1\ \fcmp\ #2\ \bullet\ #3\ \constrained^*\ #4}
\newcommand{\satisfies}[4]{#1\ \fcmp\ #2,\ #3 \vDash\ #4}

\newcommand\trans{\mathlarger{\mathlarger \leadsto}}
\newcommand\intstep{\hspace{1.5mm}{\raisebox{3pt}{$\bullet$}}\hspace{-1.5mm}{\hookrightarrow}}
\newcommand\en{\hspace{1.5mm}{\raisebox{0pt}{$\bullet$}}\hspace{-4mm}{\hookrightarrow}}
\newcommand\oi{\hspace{1mm}{\raisebox{1pt}{$\bullet$}}\hspace{-1mm}{\trans}}
\newcommand\ot{\hspace{2mm}{\raisebox{1pt}{$\bullet$}}\hspace{-3mm}{\trans}}
\newcommand\otAlt{\hspace{2mm}{\raisebox{0.5pt}{$\bullet$}}\hspace{-2.75mm}{\trans}}
\newcommand\mut[3]{\langle #1\ \texttt{mut}\ #2.#3 \rangle}
\newcommand\gives[3]{\langle #1\ \texttt{gives}\ #2\ \texttt{to}\ #3 \rangle}
\newcommand\exposes[2]{#1\ \texttt{exposes}\ #2}
\newcommand\univ{U}
\newcommand\onlyIf[3]{#1\ {\color{blue}\texttt{to}}\ #2\ {\color{blue}\texttt{onlyIf}}\ #3}
\newcommand\oiInternal[4]{#1\ {\color{blue}\texttt{to}}\ #2\ {\color{blue}\texttt{via}}\ #3\ {\color{blue}if}\ #4}
\newcommand\ensures[3]{#1,\ #2\ \en\ #3}
\newcommand\onlyThrough[3]{#1\ {\color{blue}\texttt{to}}\ #2\ {\color{blue}\texttt{onlyThough}}\ #3}
\newcommand\onlyIfProof[4]{#1\ \vdash\ #2,\ #3\ \texttt{only if}\ #4}
\newcommand\onlyThroughProof[4]{#1\ \vdash\ #2,\ #3\ \texttt{only if}\ #4}
\newcommand\hoare[3]{\{#1\}\ #2\ \{#3\}}
\newcommand\hoareIf[4]{#1,\ #2,\ \{#3\}\ \intstep\ #4}
\newcommand\rtrns[3]{\{#1\}\ #2\ \texttt{returns}\ #3}

\newcommand\encapsulated[1]{\langle {\color{blue}\texttt{encapsulated}}\ #1 \rangle}
\newcommand\encapsulates[2]{\langle #1\ {\color{blue}\texttt{encapsulates}}\ #2 \rangle}
\newcommand\bencapsulated[1]{\langle {\color{blue}\texttt{encapsulated}_{\mathcal{B}}}\ #1 \rangle}
\newcommand\bencapsulates[2]{\langle #1\ {\color{blue}\texttt{encapsulates}_{\mathcal{B}}}\ #2 \rangle}
\newcommand\encapsulatesStrong[2]{\langle #1\ \texttt{encapsulates}_\texttt{strong}\ #2 \rangle}
\newcommand\encapsulatesMdl[1]{\langle \texttt{encapsulating}_\texttt{int}\ #1 \rangle}
\newcommand\calls[4]{\langle #1\ {\color{blue}\texttt{calls}}\ #2.#3(#4) \rangle}
\newcommand\changes[2]{\langle #1\ {\color{blue}\texttt{changes}}\ #2 \rangle}
\newcommand\access[2]{\langle #1\ {\color{blue}\texttt{access}}\ #2 \rangle}
\newcommand\internal[1]{\langle #1\ {\color{blue}\texttt{internal}}\rangle}
\newcommand\external[1]{\langle #1\ {\color{blue}\texttt{external}}\rangle}
\newcommand\comprehension[2]{\{#1 | #2\}}
\newcommand\internalStep{\langle \texttt{internal step}\rangle}
\newcommand\I{\textit{Int}\xspace}

\lstset{ % General setup for the package
	language=Java,
	basicstyle=\scriptsize\sffamily,
 	numberstyle=\tiny,
 	frame = bottomline,
	tabsize=4,
	columns=fixed,
	showstringspaces=false,
	showtabs=false,
	keepspaces,
	morekeywords={field, method, module, calls, presumes, achieves, external, internal, access, requires, ensures, PRE, POST, onlyThrough, onlyIf, to},
	commentstyle=\color{red},
	keywordstyle=\color{blue}
}


\begin{document}

%% Title information
\title[An Inference System for Holisic Specifications]{An Inference System for Holisic Specifications}         %% [Short Title] is optional;
                                        %% when present, will be used in
                                        %% header instead of Full Title.
%\titlenote{with title note}             %% \titlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'
%\subtitle{Subtitle}                     %% \subtitle is optional
%\subtitlenote{with subtitle note}       %% \subtitlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'


%% Author information
%% Contents and number of authors suppressed with 'anonymous'.
%% Each author should be introduced by \author, followed by
%% \authornote (optional), \orcid (optional), \affiliation, and
%% \email.
%% An author may have multiple affiliations and/or emails; repeat the
%% appropriate command.
%% Many elements are not rendered, but should be provided for metadata
%% extraction tools.

%% Author with single affiliation.
\author{First1 Last1}
\authornote{with author1 note}          %% \authornote is optional;
                                        %% can be repeated if necessary
\orcid{nnnn-nnnn-nnnn-nnnn}             %% \orcid is optional
\affiliation{
  \position{Position1}
  \department{Department1}              %% \department is recommended
  \institution{Institution1}            %% \institution is required
  \streetaddress{Street1 Address1}
  \city{City1}
  \state{State1}
  \postcode{Post-Code1}
  \country{Country1}                    %% \country is recommended
}
\email{first1.last1@inst1.edu}          %% \email is recommended

%% Author with two affiliations and emails.
\author{First2 Last2}
\authornote{with author2 note}          %% \authornote is optional;
                                        %% can be repeated if necessary
\orcid{nnnn-nnnn-nnnn-nnnn}             %% \orcid is optional
\affiliation{
  \position{Position2a}
  \department{Department2a}             %% \department is recommended
  \institution{Institution2a}           %% \institution is required
  \streetaddress{Street2a Address2a}
  \city{City2a}
  \state{State2a}
  \postcode{Post-Code2a}
  \country{Country2a}                   %% \country is recommended
}
\email{first2.last2@inst2a.com}         %% \email is recommended
\affiliation{
  \position{Position2b}
  \department{Department2b}             %% \department is recommended
  \institution{Institution2b}           %% \institution is required
  \streetaddress{Street3b Address2b}
  \city{City2b}
  \state{State2b}
  \postcode{Post-Code2b}
  \country{Country2b}                   %% \country is recommended
}
\email{first2.last2@inst2b.org}         %% \email is recommended


%% Abstract
%% Note: \begin{abstract}...\end{abstract} environment must come
%% before \maketitle command
\begin{abstract}
Text of abstract \ldots.
\end{abstract}


%% 2012 ACM Computing Classification System (CSS) concepts
%% Generate at 'http://dl.acm.org/ccs/ccs.cfm'.
\begin{CCSXML}
<ccs2012>
<concept>
<concept_id>10011007.10011006.10011008</concept_id>
<concept_desc>Software and its engineering~General programming languages</concept_desc>
<concept_significance>500</concept_significance>
</concept>
<concept>
<concept_id>10003456.10003457.10003521.10003525</concept_id>
<concept_desc>Social and professional topics~History of programming languages</concept_desc>
<concept_significance>300</concept_significance>
</concept>
</ccs2012>
\end{CCSXML}

\ccsdesc[500]{Software and its engineering~General programming languages}
\ccsdesc[300]{Social and professional topics~History of programming languages}
%% End of generated code


%% Keywords
%% comma separated list
\keywords{keyword1, keyword2, keyword3}  %% \keywords are mandatory in final camera-ready submission


%% \maketitle
%% Note: \maketitle command must come after title commands, author
%% commands, abstract environment, Computing Classification System
%% environment and commands, and keywords command.
\maketitle

\section{Encapsulation}
We define two forms of encapsulation: (1) encapsulation of sets of objects by sets of objects (topological encapsulation), and (2) encapsulation of assertions by sets of objects (behavioral encapsulation).

The first form of encapsulation is easiest to define, is topological in nature, and refers to which 
objects refer to which other objects in the heap. We use the syntax $\encapsulates{B}{I}$
for topological encapsulation. We define this form of encapsulation as a Chainmail predicate in Def. \ref{def:tencap}.
\begin{definition}[Topological Encapsulation]
\label{def:tencap}
$$\encapsulates{B}{I}\ \equiv\ \forall x,\ y.[y\ \in\ I\ \wedge\ 
														(x\ \in\ B \cup I\ \vee\ 
 														\neg\access{x}{y})]\ \wedge\ 
										\texttt{this}\ \not\in\ B \cup I$$
\end{definition}
That is, for any program state where the current 
computation is occurring externally to the subset of the heap defined by $B \cup I$, 
we say $\encapsulates{B}{I}$ if all objects external to $B$ and $I$ do not have access
to any objects in $I$.
We can use Def. \ref{def:tencap} to extend our notion of topological
encapsulation to include objects and field accesses. We do this in Def. \ref{def:oencap} and \ref{def:fencap}.
\begin{definition}[Topological Object Encapsulation]
\label{def:oencap}
$$\encapsulates{B}{x}\ \equiv\ \exists I.[\encapsulates{B}{I}\ \wedge\ x \in I]$$
\end{definition}
\begin{definition}[Topological Field Encapsulation]
\label{def:fencap}
$$\encapsulates{B}{x.f}\ \equiv\ \encapsulates{B}{x}\ \vee\ x \in B$$
\end{definition}

The second form of encapsulation refers to a behavioral property, and has the form 
$\bencapsulates{B}{A}$, and informally means that any computation that results in a 
change to $A$ requires a prior interaction with an object in $B$. Formally we define 
the semantics in Definition Def. \ref{def:bencap}.
\begin{definition}[Behavioral Encapsulation]
\label{def:bencap}
$\forall$ $M$, $M'$, $\sigma$, $B$, and $A$, \\
$M;\ M',\ \sigma\ \vDash\ \bencapsulates{B}{A}$ iff
$\forall$ $\sigma'$ such that
\begin{itemize}
\item
$\sigma = \sigma'$ or $M;\ M',\ \sigma\ \leadsto^*\ \sigma'$ and
\item
$M;\ M',\ \sigma'\ \vDash\ \changes{\_}{A}$
\end{itemize}
then it follows that $\exists$ $\sigma''$ such that
\begin{itemize}
\item
either
\begin{itemize}
\item
$\sigma = \sigma''$ or 
\item
$M \circ M',\ \sigma\ \leadsto^*\ \sigma''$ and
$M \circ M',\ \sigma''\ \leadsto^*\ \sigma'$
\end{itemize}
and
\item
either
\begin{itemize}
\item
$\sigma''$.(\texttt{contn}) = \texttt{\_ := b.m(...)} and $\texttt{b}\ \in\ B$ or
\item
$\sigma''$.(\texttt{contn}) = \texttt{\_ := b.f} and $\texttt{b}\ \in\ B$ or
\item
$\sigma''$.(\texttt{contn}) = \texttt{b.f := \_} and $\texttt{b}\ \in\ B$
\end{itemize}
\end{itemize}
\end{definition}


The connection between our topological and behavioral definitions of encapsulation is
interesting. The assertions that might be behaviorally encapsulated by a set $B$ include
those assertions that are dependent on objects that are either in $B$, or encapsulated 
by $B$. More specifically, $\bencapsulates{B}{A}$ if satisfaction of $A$ is dependent 
on either a read or a write of data that is topologically encapsulated by $B$.
We now formalize this relationship between Behavioral Encapsulation and Topological Encapsulation in Lemma \ref{lem:behaveToTop}.
\begin{lemma}[Topological Encapsulation implies Behavioral Encapsulation]
\label{lem:behaveToTop}
For modules $M$ and $M'$, program configuration $\sigma$, set $B$, and assertion $A$ we have
\begin{itemize}
\item
(\textsc{Read}):
$\forall\ x,\ y$ if $M;\ M,'\ \sigma \vDash\ \changes{\_}{\neg\access{x}{y}}\ \longrightarrow\ \changes{\_}{A}$ then
$$M;\ M,'\ \sigma \vDash\ \encapsulates{B}{y}\ \longrightarrow\ \bencapsulates{B}{A}$$ and
\item
(\textsc{Write}):
$\forall\ x,\ f,\ y$ if $M;\ M',\ \sigma \vDash\ \changes{\_}{x.f = y}\ \longrightarrow\ \changes{\_}{A}$ 
$$M;\ M',\ \sigma \vDash\ \encapsulates{B}{x.f}\ \longrightarrow \bencapsulates{B}{A}$$
\end{itemize}
%or put as a single Chainmail assertion
%$$M;\ M',\ \sigma\ \vDash\ (\encapsulates{B}{x.f} \wedge (x.f = y \longrightarrow A))\ \vee\ 
%(\encapsulates{B}{y} \wedge (\neg \access{x}{y} \longrightarrow A))
%\longrightarrow \bencapsulates{B}{A}$$
\end{lemma}
%\begin{lemma}[Topological Encapsulation implies Behavioral Encapsulation]
%\label{lem:behaveToTop}
%For modules $M$ and $M'$, program configuration $\sigma$, set $B$, and assertion $A$ we have
%\begin{itemize}
%\item
%(\textsc{Read}):
%$\forall\ x,\ y$ $M;\ M,'\ \sigma \vDash\ \encapsulates{B}{y}\ \longleftrightarrow\ \bencapsulates{B}{\neg \access{x}{y}}$ and
%\item
%(\textsc{Write}):
%$\forall\ x,\ f,\ y$ $M;\ M',\ \sigma \vDash\ \encapsulates{B}{x.f}\ \longleftrightarrow \bencapsulates{B}{x.f = y}$
%\end{itemize}
%%or put as a single Chainmail assertion
%%$$M;\ M',\ \sigma\ \vDash\ (\encapsulates{B}{x.f} \wedge (x.f = y \longrightarrow A))\ \vee\ 
%%(\encapsulates{B}{y} \wedge (\neg \access{x}{y} \longrightarrow A))
%%\longrightarrow \bencapsulates{B}{A}$$
%\end{lemma}
That is any write to fields/read from objects encapsulated by 
$B$ implies that any assertion $A$ dependent on that write/read is behaviorally 
encapsulated by $B$, i.e. $\bencapsulates{B}{A}$.
It is important to note that there are assertions that are behaviorally encapsulated
by some set $B$ that are not related to either reads or writes (i.e. the calling of some private but pure method might be dependent on some external call to $B$).

It is also useful to note that if $\encapsulates{B}{I}$, then while we know that 
any operation that reads from/writes to $I$ necessitates an interaction with $B$,
it does not necessarily require computation by an object in $B$. Specifically, 
in $\mathcal{L}_\text{oo}$ this refers to a broader set that includes any objects
that share a class with an object in $B$. Thus, for any boundary set $B$, we are 
able to define a modifying set of objects of which some element of is required to 
perform some computation to read from/write to any object/field encapsulated by 
$B$. In $\mathcal{L}_\text{oo}$ that set is defined in Def. \ref{def:modSet}
\begin{definition}[Modifying Set]
\label{def:modSet}
For set $B$, we define the modifying set of $B$ as
$$X_B \equiv\ \{x\ |\ \exists y,\ C.[y\ \in\ B\ \wedge\ y : C\ \wedge\ x : C]\}$$
\end{definition}
Def \ref{def:modSet} is language dependent. In $\mathcal{L}_\text{oo}$ $X_B$ refers to
those objects that share a class with a member of $B$, 
but other languages, this might refer some other set of objects.

We also define the set of all internal objects in Def. \ref{def:intSet} along with 
the subset relation in Def. \ref{def:subset}
\begin{definition}[Internal Set]
\label{def:intSet}
We define the set of all internal objects as
$$\I \equiv\ \{x\ |\ \internal{x} \}$$
\end{definition}
\begin{definition}[Subset]
\label{def:subset}
We define the subset relation in Chainmail as
$$S_1\ \subseteq\ S_2\ \equiv\ \forall x.[x\ \in\ S_1\ \longrightarrow\ x\ \in\ S_2]$$
\end{definition}


We note in Lemma \ref{lem:setModSet} that any set is a 
subset of it's modifying set, in Lemma \ref{lem:modSetInternal} that 
any modifying set of an internal set, is itself an internal set, 
in Lemma \ref{lem:modInt} that the modifying set of \I is \I,
and in Lemma \ref{lem:subsetTrans} that the subset relation is transitive.
\begin{lemma}[Set $\subseteq$ Modifying Set]
\label{lem:setModSet}
For all modules $M$ and $M'$, program configurations $\sigma$, and object sets $S$, 
if $M;\ M,\ \sigma\ \vDash S\ \subseteq\ X_S$
\end{lemma}
\begin{lemma}[Internal Modifying Set]
\label{lem:modSetInternal}
For all modules $M$ and $M'$, program configurations $\sigma$, and object sets $S$, 
if $M;\ M,\ \sigma\ \vDash S\ \subseteq\ \I\ \longrightarrow X_S\ \subseteq\ \I$
\end{lemma}
\begin{lemma}[\I = $X_{\I}$]
\label{lem:modInt}
For all modules $M$ and $M'$, and program configurations $\sigma$, 
$M;\ M,\ \sigma\ \vDash \I = X_{\I}$
\end{lemma}
\begin{lemma}[$\subseteq$ Transitivity]
\label{lem:subsetTrans}
For all modules $M$ and $M'$, program configurations $\sigma$, and object sets $S_1$, $S_2$, 
and $S_3$, if $M;\ M,\ \sigma\ \vDash S_1\ \subseteq\ S_2\ \wedge\ S_2\ \subseteq\ S_3\ \longrightarrow\ S_1\ \subseteq\ S_3$
\end{lemma}

Finally, for simplicity, we introduce some notation for encapsulation by the 
internal set in Def. \ref{def:intEncap}
\begin{definition}[Internal Encapsulation]
\label{def:intEncap}
$$\encapsulated{S}\ \equiv\ \encapsulates{\I}{S}$$
$$\encapsulated{x}\ \equiv\ \encapsulates{\I}{x}$$
$$\encapsulated{x.f}\ \equiv\ \encapsulates{\I}{x.f}$$
$$\bencapsulated{A}\ \equiv\ \bencapsulates{\I}{A}$$
\end{definition}

\section{Inference System}

\begin{figure}[t]
\footnotesize
\begin{mathpar}
\infer
		{M\ \vdash\ \calls{x}{y}{m}{args}}
		{
		M\ \vdash\ \access{x}{y}
		}
		\quad(\textsc{Calls-Recv})
		\and
\infer
		{M\ \vdash\ \calls{x}{y}{m}{\ldots,z,\ldots}}
		{
		M\ \vdash\ \access{x}{z}
		}
		\quad(\textsc{Calls-Args})
%		\and
%\infer
%		{C\ \in\ M}
%		{M\ \vdash\ x : C \longrightarrow\ \internal{x}}
%		\quad(\textsc{Class-Int})
		\and
\infer
		{M\ \vdash\ \changes{\_}{A}}
		{M\ \vdash\ A}
		\quad(\textsc{Changes}\longrightarrow)
		\and
\infer
		{M\ \vdash\ \encapsulates{B}{I}}
		{M\ \vdash\ \encapsulates{B \cup S}{I}}
		\quad(\textsc{Encap}-\cup)
		\and
\infer
		{
		\oiInternal{A}{\neg A}{M}{A'}
		}
		{
		M\ \vdash\ \changes{\I}{A}\ \longrightarrow\ A'
		}
		\quad(\textsc{Int-Changes})
		\and
\infer
		{M\ \vdash\ x \in B}
		{M\ \vdash\ \encapsulates{B}{x.f}}
		\quad(\textsc{Encap-f})
		\and
\infer
		{M\ \vdash\ \changes{\_}{\encapsulated{x.f}}\ \wedge\ \internal{x}}
		{M\ \vdash\ \texttt{false}}
		\quad(\textsc{Change-Encap-Int-f})
		\and
\infer
		{M\ \vdash\ \changes{\_}{\encapsulated{x.f}}\ \wedge\ \external{x}}
		{M\ \vdash\ \changes{\I}{\encapsulated{x}}}
		\quad(\textsc{Change-Encap-Ext-f}_1)
		\and
\infer
		{M\ \vdash\ \changes{\I}{\encapsulated{x}}}
		{M\ \vdash\ \changes{\_}{\encapsulated{x.f\ =\ \_}}\ \wedge\ \external{x}}
		\quad(\textsc{Change-Encap-Ext-f}_2)
%		\and
%\infer
%		{
%		M\ \vdash\ \encapsulates{B}{y}\\
%		M\ \vdash\ \changes{\_}{\neg\access{x}{y}}\ \longrightarrow\ \changes{\_}{A}
%		}
%		{
%		M\ \vdash\ \bencapsulates{B}{A}
%		}
%		\quad(\textsc{Encap-Read}_1)
%		\and
%\infer
%		{
%		M\ \vdash\ \bencapsulates{B}{y}\\
%		M\ \vdash\ \changes{\_}{\neg\access{x}{y}}\ \longrightarrow\ \changes{\_}{A}
%		}
%		{
%		M\ \vdash\ \encapsulates{B}{A}
%		}
%		\quad(\textsc{Encap-Read}_2)
%		\and
%\infer
%		{
%		M\ \vdash\ \encapsulates{B}{x.f}\\
%		M\ \vdash\ \changes{\_}{x.f = y}\ \longrightarrow\ \changes{\_}{A}
%		}
%		{
%		M\ \vdash\ \bencapsulates{B}{A}
%		}
%		\quad(\textsc{Encap-Write}_1)
%		\and
%\infer
%		{
%		M\ \vdash\ \bencapsulates{B}{x.f}\\
%		M\ \vdash\ \changes{\_}{x.f = y}\ \longrightarrow\ \changes{\_}{A}
%		}
%		{
%		M\ \vdash\ \encapsulates{B}{A}
%		}
%		\quad(\textsc{Encap-Write}_2)
%		\and
%\infer
%		{}
%		{
%		M\ \vdash\ 
%			\changes {\_}{x.f = y}\ \wedge\ 
%			\encapsulates{S}{x.f} \longrightarrow\ \\\\
%			\exists\ S.[\changes{S}{x.f = y}\ \wedge\ \forall\ z.[z \not\in S\ \vee\ \internal{z}]]
%		}
%		\quad(\textsc{Int-Mut})
%		\and
%\infer
%		{
%		A_\texttt{encap} = \encapsulates{S_1}{S_2}\\
%		S_C = \{x\ |\ x : C\}
%		}
%		{M\ \vdash\ A_\texttt{encap}\ \wedge\ x\ \in\ S_2\ \wedge \changes {\_}{x.f = y}\ \longrightarrow\ \\\\ 
%		\exists\ z,\ C.[z\ :\ C\ \wedge\ z\ \in\ S_1\ \wedge\ \changes{S_C}{x.f = y}]}
%		\quad(\textsc{Mut})
%		\and
%\infer
%		{
%		A_\texttt{encap} = \encapsulates{S_1}{S_2}\\
%		S_C = \{x\ |\ x : C\}
%		}
%		{
%		M\ \vdash\ A_\texttt{encap}\ \wedge\ y\ \in\ S_2\ \wedge\ x\ \not\in\ S_1\ \cup\ S_2\ \vee\ \changes {\_}{\access{x}{y}} \longrightarrow\ \\\\
%		\exists\ x',\ z,\ C.[x'\ \not\in\ S_1\ \cup\ S_2\ \wedge\ z : C\ \wedge\ z\ \in\ S_1\ \wedge\ \changes{S_C}{\access {x'}{z}}]
%		}
%		\quad(\textsc{Gives})
\end{mathpar}
\caption{Chainmail Consequence Proof Rules}
\label{f:consequence}
\end{figure}


\subsection{Only If/Only Through}
\begin{figure}[t]
\footnotesize
\begin{mathpar}
\infer
	{}
	{M\ \vdash\ \onlyThrough{A_1}{A_2}{\texttt{true}}}
	\quad(\textsc{True})
	\and
\infer
	{}
	{
	M\ \vdash\ \onlyThrough{A}{\neg A}{\changes{\_}{A}}
	}
	\quad(\textsc{Changes})
%	\and
%\infer
%	{}
%	{
%	M\ \vdash\ \onlyThrough{\bencapsulates{B}{A}}{\changes{\_}{A}}{\changes{X_B}{A}\ \vee\ \changes{X_B}{\bencapsulates{B}{A}}}
%	}
%	\quad(\textsc{Encap})
	\and
\infer
	{
	A = \encapsulates{B}{y}
	}
	{
	M\ \vdash\ \onlyThrough{A_1}{\changes{\_}{\neg\access{x}{y}}}{\changes{X_B}{\neg\access{x}{y}}\ \vee\ \changes{X_B}{A_1}}
	}
	\quad(\textsc{Encap-Read})
	\and
\infer
	{
	A = \encapsulates{B}{x.f}
	}
	{
	M\ \vdash\ \onlyThrough{A}{\changes{\_}{x.f=y}}{\changes{X_B}{x.f=y}\ \vee\ \changes{X_B}{A}}
	}
	\quad(\textsc{Encap-Write})
%	\and
%\infer
%	{
%	M\ \vdash\ \onlyThrough{A_1}{A_2}{\exists x.[A_3]}\\
%	y\ \not\in A_1,\ A_2,\ A_3
%	}
%	{
%	M\ \vdash\ \onlyThrough{A_1}{A_2}{[y/x]A_3}
%	}
%	\quad(\exists_3)
	\and
\infer
	{
	M\ \vdash\ A_1 \longrightarrow A_1'\\
	M\ \vdash\ A_2 \longrightarrow A_2'\\
	M\ \vdash\ A_3' \longrightarrow A_3\\
	M\ \vdash\ \onlyThrough{A_1'}{A_2'}{A_3'}
	}
	{M\ \vdash\ \onlyThrough{A_1}{A_2}{A_3}}
	\quad(\textsc{$\longrightarrow$})
	\and
\infer
	{
	M\ \vdash\ \onlyThrough{A_1}{A_2}{A} \\\\
	M\ \vdash\ \onlyThrough{A_1'}{A_2}{A'}
	}
	{M\ \vdash\ \onlyThrough{A_1\ \vee\ A_1'}{A_2}{A\ \vee\ A'}}
	\quad(\textsc{$\vee$I$_1$})
	\and
\infer
	{
	M\ \vdash\ \onlyThrough{A_1}{A_2}{A} \\\\
	M\ \vdash\ \onlyThrough{A_1}{A_2'}{A'}
	}
	{M\ \vdash\ \onlyThrough{A_1}{A_2\ \vee\ A_2'}{A\ \vee\ A'}}
	\quad(\textsc{$\vee$I$_2$})
	\and
\infer
	{
	M\ \vdash\ \onlyThrough{A_1}{A'}{\texttt{false}} \\\\
	M\ \vdash\ \onlyThrough{A_1}{A_2}{A\ \vee\ A'}
	}
	{M\ \vdash\ \onlyThrough{A_1}{A_2}{A}}
	\quad(\textsc{$\vee$E$_1$})
	\and
\infer
	{
	M\ \vdash\ \onlyThrough{A_1}{A'}{\texttt{false}} \\\\
	M\ \vdash\ \onlyThrough{A_1}{A_2}{A\ \vee\ A'}
	}
	{M\ \vdash\ \onlyThrough{A_1}{A_2}{A}}
	\quad(\textsc{$\vee$E$_2$})
	\and
\infer
	{
	M\ \vdash\ \onlyThrough{A_1}{A_2}{A_3} \\\\
	M\ \vdash\ \onlyThrough{A_1}{A_3}{A}
	}
	{M\ \vdash\ \onlyThrough{A_1}{A_2}{A}}
	\quad(\textsc{Trans$_1$})
	\and
\infer
	{
	M\ \vdash\ \onlyThrough{A_1}{A_2}{A_3} \\\\
	M\ \vdash\ \onlyThrough{A_3}{A_2}{A}
	}
	{M\ \vdash\ \onlyThrough{A_1}{A_2}{A}}
	\quad(\textsc{Trans$_2$})
	\and
\infer
	{
	M\ \vdash\ \onlyIf{A_1}{A_2}{A}
	}
	{M\ \vdash\ \onlyThrough{A_1}{A_2}{A}}
	\quad(\textsc{If})
\end{mathpar}
\caption{\emph{Only Through}}
\label{f:only_through}
\footnotesize
\begin{mathpar}
\infer
	{}
	{M\ \vdash\ \onlyIf{A_1}{A_2}{\texttt{true}}}
	\quad(\textsc{If-True})
	\and
\infer
	{}
	{M\ \vdash\ \onlyIf{A_1}{A_2}{A_1}}
	\quad(\textsc{If-Start})
	\and
\infer
	{
	M\ \vdash\ A_1 \longrightarrow A_1'\\
	M\ \vdash\ A_2 \longrightarrow A_2'\\
	M\ \vdash\ A_3' \longrightarrow A_3\\
	M\ \vdash\ \onlyIf{A_1'}{A_2'}{A_3'}
	}
	{M\ \vdash\ \onlyIf{A_1}{A_2}{A_3}}
	\quad(\textsc{If-$\longrightarrow$})
	\and
\infer
	{
	M\ \vdash\ \onlyIf{A_1}{A_2}{A} \\\\
	M\ \vdash\ \onlyIf{A_1'}{A_2}{A'}
	}
	{M\ \vdash\ \onlyIf{A_1\ \vee\ A_	1'}{A_2}{A\ \vee\ A'}}
	\quad(\textsc{If-$\vee$I$_1$})
	\and
\infer
	{
	M\ \vdash\ \onlyIf{A_1}{A_2}{A} \\\\
	M\ \vdash\ \onlyIf{A_1}{A_2'}{A'}
	}
	{M\ \vdash\ \onlyIf{A_1}{A_2\ \vee\ A_2'}{A\ \vee\ A'}}
	\quad(\textsc{If-$\vee$I$_2$})
	\and
\infer
	{
	M\ \vdash\ \onlyIf{A_1}{A_2}{A\ \vee\ A'} \\\\
	M\ \vdash\ \onlyThrough{A_1}{A'}{\texttt{false}}
	}
	{M\ \vdash\ \onlyIf{A_1}{A_2}{A}}
	\quad(\textsc{If-$\vee$E$_1$})
	\and
\infer
	{
	M\ \vdash\ \onlyIf{A_1}{A_2}{A\ \vee\ A'} \\\\
	M\ \vdash\ \onlyThrough{A'}{A_2}{\texttt{false}}
	}
	{M\ \vdash\ \onlyIf{A_1}{A_2}{A}}
	\quad(\textsc{If-$\vee$E$_2$})
	\and
\infer
	{
	M\ \vdash\ \onlyThrough{A_1}{A_2}{A_3} \\
	M\ \vdash\ \onlyIf{A_1}{A_3}{A}
	}
	{M\ \vdash\ \onlyIf{A_1}{A_2}{A}}
	\quad(\textsc{If-Trans)}
%	\and
%\infer
%	{
%	M\ \vdash\ \onlyThrough{A_1}{A_2}{A_2}
%	}
%	{M\ \vdash\ \onlyIf{A_1}{A_2}{A_2}}
%	\quad(\textsc{If-Ind)}
\end{mathpar}
\caption{\emph{Only if}}
\label{f:only_if}
\end{figure}

\subsection{Internal/External Boundary}

\newpage

\section{Examples}

\subsection{Bank Account (Old)}
\begin{lstlisting}[mathescape=true]
BankSpec $\triangleq$  a : Account $\wedge$ a.balance = b to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ only if $\neg\ \bencapsulated{\texttt{a}}$
\end{lstlisting}
We assume that the method \texttt{deposit} conforms to the following 
specification
\begin{lstlisting}[mathescape=true]
DepositSpec $\triangleq$  {a'.balance = b $\wedge$ a' $\neq$ a $\wedge$ a' $\neq$ from}
					a.deposit(from, amt) 
			   {a'.balance = b}
\end{lstlisting}
And all other methods \texttt{m} in \texttt{Account} conform to the 
following spec
\begin{lstlisting}[mathescape=true]
AccountMethSpec $\triangleq$  {a : Account $\wedge$ a.balance = b}
					  a.m(...) 
			       {a.balance = b}
\end{lstlisting}
From \texttt{DepositSpec}, \texttt{AccountMethSpec}, and Definition \ref{def:module_necessary} we can derive \texttt{BASafety}
\begin{lstlisting}[mathescape=true]
BASafety $\triangleq$  a : Account $\wedge$ $\changes{\_}{\texttt{a.balance = b}}$
            onlyIf $\exists$ a'. [a' : Account $\wedge$ $\calls{\_}{\texttt{a'}}{\texttt{deposit}}{\texttt{a, \_}}$ $\vee$ $\calls{\_}{\texttt{a}}{\texttt{deposit}}{\texttt{a'},\_}$
\end{lstlisting}
Then we assume that all methods $m$ in \texttt{Account} observe the following specification:
\begin{lstlisting}[mathescape=true]
AccountEncapsulation $\triangleq$ {a : Account $\wedge$ $\bencapsulated{\texttt{a}}$}
				          a.m(...)
				       {$\bencapsulated{\texttt{a}}$}
\end{lstlisting}
And thus from \texttt{AccoutnEncapsulation} and Definition \ref{def:module_necessary} we can derive \texttt{BAEncapsulation}
\begin{lstlisting}[mathescape=true]
BAEncapsulation $\triangleq$  a : Account $\wedge$ $\changes{\I}{\bencapsulated{\texttt{a}}}$
                 onlyIf false
\end{lstlisting}
%\begin{figure}[p]
\begin{minipage}{\linewidth}
\begin{proofBox}{white}{black}
\footnotesize
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[mathescape=true, frame = single]
a : Account $\wedge$ a.balance = b 
  to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ 
  onlyThrough $\changes{\texttt{\_}}{\texttt{a.balance = b}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Changes}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[mathescape=true]
a : Account $\wedge$ a.balance = b $\wedge$ $\encapsulated{\texttt{a.balance}}$ 
  to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ 
  onlyThrough $\changes{\texttt{\_}}{\texttt{a.balance = b}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by $\longrightarrow$ and \textsc{Encap-f}
\end{minipage}
%\begin{minipage}{0.75\textwidth}
%\begin{lstlisting}[mathescape=true]
%a : Account $\wedge$ a.balance = b $\wedge$ $\bencapsulated{\texttt{a.balance = b}}$ 
%  to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ 
%  onlyThrough $\changes{\texttt{\_}}{\texttt{a.balance = b}}$
%\end{lstlisting}
%\end{minipage}
%\begin{minipage}{0.24\textwidth}
%\scriptsize
%\hfill by $\longrightarrow$ and Lemma \ref{lem:behaveToTop}(\textsc{Read})
%\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[mathescape=true]
a : Account $\wedge$ a.balance = b $\wedge$ $\encapsulated{\texttt{a.balance = b}}$ 
  to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ 
  onlyThrough $\changes{\I}{\texttt{a.balance = b}}$ $\vee$ $\changes{\I}{\encapsulated{\text{a.balance = b}}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Encap-Write} and \textsc{Trans}$_1$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[mathescape=true]
a : Account $\wedge$ a.balance = b $\wedge$ $\encapsulated{\texttt{a.balance = b}}$ 
  to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ 
  onlyThrough $\changes{I}{\texttt{a.balance = b}}$ $\vee$ false
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Encap-Int-f} and \textsc{Trans}$_3$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\scriptsize
\begin{lstlisting}[mathescape=true]
a : Account $\wedge$ a.balance = b $\wedge$ $\encapsulated{\texttt{a.balance = b}}$ 
  to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ 
  onlyThrough $\changes{I}{\texttt{a.balance = b}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by $\vee$\textsc{E}$_1$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[mathescape=true]
a : Account $\wedge$ a.balance = b $\wedge$ $\encapsulated{\texttt{a.balance = b}}$ 
  to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ 
  onlyThrough $\exists$ o.[$\access{\texttt{o}}{\texttt{a}}$ $\wedge$ $\external{\texttt{o}}$]
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Int-Changes}, \textsc{BASafety}, and $\longrightarrow$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[mathescape=true, frame = none]
ResultA $\triangleq$ a : Account $\wedge$ a.balance = b  
            to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ 
            onlyThrough $\neg\encapsulated{\texttt{a}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by $\longrightarrow$
\end{minipage}
\end{proofBox}

\begin{proofBox}{white}{black}
\footnotesize
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[mathescape=true, frame=single]
a : Account $\wedge$ $\encapsulated{\texttt{a}}$ 
  to $\neg\encapsulated{\texttt{a}}$
  onlyThrough $\changes{\_}{\encapsulated{\texttt{a}}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Changes}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[mathescape=true]
a : Account $\wedge$ $\encapsulated{\texttt{a}}$ 
  to $\neg\encapsulated{\texttt{a}}$
  onlyThrough $\changes{I}{\encapsulated{\texttt{a}}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Encap}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[mathescape=true, frame=none]
ResultB $\triangleq$ a : Account $\wedge$ $\encapsulated{\texttt{a}}$ 
  to $\neg\encapsulated{\texttt{a}}$ 
  onlyThrough false
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Int-Changes}, \textsc{BAEncapsulation}, and $\longrightarrow$
\end{minipage}
\end{proofBox}

\begin{proofBox}{white}{black}
\footnotesize
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[mathescape=true, frame=single]
a : Account $\wedge$ a.balance = b $\wedge$ 
  to $\neg\encapsulated{\texttt{a}}$ 
  onlyIf $\encapsulated{\texttt{a}}$ $\vee$ $\neg\encapsulated{\texttt{a}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{If-True}, \textsc{Excluded Middle}, and \textsc{If}-$\longrightarrow$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[mathescape=true]
a : Account $\wedge$ a.balance = b $\wedge$ 
  to $\neg\encapsulated{\texttt{a}}$  
  onlyIf $\neg \encapsulated{\texttt{a}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{If}-$\vee$\textsc{E}$_1$ and \texttt{ResultB}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[mathescape=true, frame=none]
Result $\triangleq$ a : Account $\wedge$ a.balance = b $\wedge$ 
           to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ 
           onlyIf $\neg \encapsulated{\texttt{a}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \texttt{ResultA} and \textsc{If-Trans}
\end{minipage}
%\begin{minipage}{0.75\textwidth}
%\begin{lstlisting}[mathescape=true, frame=none]
%Result $\triangleq$ a : Account $\wedge$ a.balance = b $\wedge$ 
%           to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ 
%           onlyIf $\neg \bencapsulated{\texttt{a}}$
%\end{lstlisting}
%\end{minipage}
%\begin{minipage}{0.24\textwidth}
%\scriptsize
%\hfill by Lemma \ref{lem:behaveToTop}(\textsc{Read}) and $\longrightarrow$
%\end{minipage}
\end{proofBox}

\end{minipage}
%\end{figure}



%% Acknowledgments
\begin{acks}                            %% acks environment is optional
                                        %% contents suppressed with 'anonymous'
  %% Commands \grantsponsor{<sponsorID>}{<name>}{<url>} and
  %% \grantnum[<url>]{<sponsorID>}{<number>} should be used to
  %% acknowledge financial support and will be used by metadata
  %% extraction tools.
  This material is based upon work supported by the
  \grantsponsor{GS100000001}{National Science
    Foundation}{http://dx.doi.org/10.13039/100000001} under Grant
  No.~\grantnum{GS100000001}{nnnnnnn} and Grant
  No.~\grantnum{GS100000001}{mmmmmmm}.  Any opinions, findings, and
  conclusions or recommendations expressed in this material are those
  of the author and do not necessarily reflect the views of the
  National Science Foundation.
\end{acks}


%% Bibliography
\bibliography{Case}


%% Appendix
\appendix
\section{Appendix}

Text of appendix \ldots

\end{document}
