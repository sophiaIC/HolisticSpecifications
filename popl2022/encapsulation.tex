%% For double-blind review submission, w/o CCS and ACM Reference (max submission space)
\documentclass[acmsmall,review,anonymous]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For double-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review,anonymous]{acmart}\settopmatter{printfolios=true}
%% For single-blind review submission, w/o CCS and ACM Reference (max submission space)
%\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For single-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true}
%% For final camera-ready submission, w/ required CCS and ACM Reference
%\documentclass[acmsmall]{acmart}\settopmatter{}


%% Journal information
%% Supplied to authors by publisher for camera-ready submission;
%% use defaults for review submission.
\acmJournal{PACMPL}
\acmVolume{1}
\acmNumber{CONF} % CONF = POPL or ICFP or OOPSLA
\acmArticle{1}
\acmYear{2022}
\acmMonth{1}
\acmDOI{} % \acmDOI{10.1145/nnnnnnn.nnnnnnn}
\startPage{1}

%% Copyright information
%% Supplied to authors (based on authors' rights management selection;
%% see authors.acm.org) by publisher for camera-ready submission;
%% use 'none' for review submission.
\setcopyright{none}
%\setcopyright{acmcopyright}
%\setcopyright{acmlicensed}
%\setcopyright{rightsretained}
%\copyrightyear{2018}           %% If different from \acmYear

%% Bibliography style
\bibliographystyle{ACM-Reference-Format}
%% Citation style
%% Note: author/year citations are required for papers published as an
%% issue of PACMPL.
\citestyle{acmauthoryear}   %% For author/year citations


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Note: Authors migrating a paper from PACMPL format to traditional
%% SIGPLAN proceedings format must update the '\documentclass' and
%% topmatter commands above; see 'acmart-sigplanproc-template.tex'.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%% Some recommended packages.
\usepackage{booktabs}   %% For formal tables:
                        %% http://ctan.org/pkg/booktabs
\usepackage{subcaption} %% For complex figures with subfigures/subcaptions
                        %% http://ctan.org/pkg/subcaption
                        

\usepackage{relsize}
\usepackage{mathpartir}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{listings}
\usepackage{tcolorbox}


%constrained reduction
\newcommand{\constrained}{\mathrel{\leadsto\ \!\!\!\!{\raisebox{1pt}{$\mathsmaller{\mathsmaller{\mathsmaller{\mathsmaller\rvert}}}$}}}}
\newcommand{\reduction}[4]{#1\ \fcmp\ #2\ \bullet\ #3\ \leadsto\ #4}
\newcommand{\reductions}[4]{#1\ \fcmp\ #2\ \bullet\ #3\ \leadsto^*\ #4}
\newcommand{\constrainedReduction}[4]{#1\ \fcmp\ #2\ \bullet\ #3\ \constrained\ #4}
\newcommand{\constrainedReductions}[4]{#1\ \fcmp\ #2\ \bullet\ #3\ \constrained^*\ #4}
\newcommand{\satisfies}[4]{#1\ \fcmp\ #2,\ #3 \vDash\ #4}

\newcommand\trans{\mathlarger{\mathlarger \leadsto}}
\newcommand\intstep{\hspace{1.5mm}{\raisebox{3pt}{$\bullet$}}\hspace{-1.5mm}{\hookrightarrow}}
\newcommand\en{\hspace{1.5mm}{\raisebox{0pt}{$\bullet$}}\hspace{-4mm}{\hookrightarrow}}
\newcommand\oi{\hspace{1mm}{\raisebox{1pt}{$\bullet$}}\hspace{-1mm}{\trans}}
\newcommand\ot{\hspace{2mm}{\raisebox{1pt}{$\bullet$}}\hspace{-3mm}{\trans}}
\newcommand\otAlt{\hspace{2mm}{\raisebox{0.5pt}{$\bullet$}}\hspace{-2.75mm}{\trans}}
\newcommand\mut[3]{\langle #1\ \texttt{mut}\ #2.#3 \rangle}
\newcommand\gives[3]{\langle #1\ \texttt{gives}\ #2\ \texttt{to}\ #3 \rangle}
\newcommand\exposes[2]{#1\ \texttt{exposes}\ #2}
\newcommand\univ{U}
\newcommand\onlyIf[3]{#1\ {\color{blue}\texttt{to}}\ #2\ {\color{blue}\texttt{onlyIf}}\ #3}
\newcommand\oiInternal[4]{#1\ {\color{blue}\texttt{to}}\ #2\ {\color{blue}\texttt{via}}\ #3\ {\color{blue}if}\ #4}
\newcommand\ensures[3]{#1,\ #2\ \en\ #3}
\newcommand\onlyThrough[3]{#1\ {\color{blue}\texttt{to}}\ #2\ {\color{blue}\texttt{onlyThough}}\ #3}
\newcommand\onlyIfProof[4]{#1\ \vdash\ #2,\ #3\ \texttt{only if}\ #4}
\newcommand\onlyThroughProof[4]{#1\ \vdash\ #2,\ #3\ \texttt{only if}\ #4}
\newcommand\hoare[3]{\{#1\}\ #2\ \{#3\}}
\newcommand\hoareIf[4]{#1,\ #2,\ \{#3\}\ \intstep\ #4}
\newcommand\rtrns[3]{\{#1\}\ #2\ \texttt{returns}\ #3}

\newcommand\encapsulated[1]{\langle \texttt{encapsulated}\ #1 \rangle}
\newcommand\encapsulates[2]{\langle #1\ \texttt{encapsulates}\ #2 \rangle}
\newcommand\encapsulatesStrong[2]{\langle #1\ \texttt{encapsulates}_\texttt{strong}\ #2 \rangle}
\newcommand\encapsulatesMdl[1]{\langle \texttt{encapsulating}_\texttt{int}\ #1 \rangle}
\newcommand\calls[4]{\langle #1\ \texttt{calls}\ #2.#3(#4) \rangle}
\newcommand\changes[2]{\langle #1\ \texttt{changes}\ #2 \rangle}
\newcommand\access[2]{\langle #1\ \texttt{access}\ #2 \rangle}
\newcommand\internal[1]{\langle #1\ \texttt{internal}\rangle}
\newcommand\external[1]{\langle #1\ \texttt{external}\rangle}
\newcommand\comprehension[2]{\{#1 | #2\}}
\newcommand\internalStep{\langle \texttt{internal step}\rangle}

\lstset{ % General setup for the package
	language=Java,
	basicstyle=\scriptsize\sffamily,
 	numberstyle=\tiny,
 	frame = bottomline,
	tabsize=4,
	columns=fixed,
	showstringspaces=false,
	showtabs=false,
	keepspaces,
	morekeywords={field, method, module, calls, presumes, achieves, external, internal, access, requires, ensures, PRE, POST, onlyThrough, onlyIf, to},
	commentstyle=\color{red},
	keywordstyle=\color{blue}
}


\begin{document}

%% Title information
\title[An Inference System for Holisic Specifications]{An Inference System for Holisic Specifications}         %% [Short Title] is optional;
                                        %% when present, will be used in
                                        %% header instead of Full Title.
%\titlenote{with title note}             %% \titlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'
%\subtitle{Subtitle}                     %% \subtitle is optional
%\subtitlenote{with subtitle note}       %% \subtitlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'


%% Author information
%% Contents and number of authors suppressed with 'anonymous'.
%% Each author should be introduced by \author, followed by
%% \authornote (optional), \orcid (optional), \affiliation, and
%% \email.
%% An author may have multiple affiliations and/or emails; repeat the
%% appropriate command.
%% Many elements are not rendered, but should be provided for metadata
%% extraction tools.

%% Author with single affiliation.
\author{First1 Last1}
\authornote{with author1 note}          %% \authornote is optional;
                                        %% can be repeated if necessary
\orcid{nnnn-nnnn-nnnn-nnnn}             %% \orcid is optional
\affiliation{
  \position{Position1}
  \department{Department1}              %% \department is recommended
  \institution{Institution1}            %% \institution is required
  \streetaddress{Street1 Address1}
  \city{City1}
  \state{State1}
  \postcode{Post-Code1}
  \country{Country1}                    %% \country is recommended
}
\email{first1.last1@inst1.edu}          %% \email is recommended

%% Author with two affiliations and emails.
\author{First2 Last2}
\authornote{with author2 note}          %% \authornote is optional;
                                        %% can be repeated if necessary
\orcid{nnnn-nnnn-nnnn-nnnn}             %% \orcid is optional
\affiliation{
  \position{Position2a}
  \department{Department2a}             %% \department is recommended
  \institution{Institution2a}           %% \institution is required
  \streetaddress{Street2a Address2a}
  \city{City2a}
  \state{State2a}
  \postcode{Post-Code2a}
  \country{Country2a}                   %% \country is recommended
}
\email{first2.last2@inst2a.com}         %% \email is recommended
\affiliation{
  \position{Position2b}
  \department{Department2b}             %% \department is recommended
  \institution{Institution2b}           %% \institution is required
  \streetaddress{Street3b Address2b}
  \city{City2b}
  \state{State2b}
  \postcode{Post-Code2b}
  \country{Country2b}                   %% \country is recommended
}
\email{first2.last2@inst2b.org}         %% \email is recommended


%% Abstract
%% Note: \begin{abstract}...\end{abstract} environment must come
%% before \maketitle command
\begin{abstract}
Text of abstract \ldots.
\end{abstract}


%% 2012 ACM Computing Classification System (CSS) concepts
%% Generate at 'http://dl.acm.org/ccs/ccs.cfm'.
\begin{CCSXML}
<ccs2012>
<concept>
<concept_id>10011007.10011006.10011008</concept_id>
<concept_desc>Software and its engineering~General programming languages</concept_desc>
<concept_significance>500</concept_significance>
</concept>
<concept>
<concept_id>10003456.10003457.10003521.10003525</concept_id>
<concept_desc>Social and professional topics~History of programming languages</concept_desc>
<concept_significance>300</concept_significance>
</concept>
</ccs2012>
\end{CCSXML}

\ccsdesc[500]{Software and its engineering~General programming languages}
\ccsdesc[300]{Social and professional topics~History of programming languages}
%% End of generated code


%% Keywords
%% comma separated list
\keywords{keyword1, keyword2, keyword3}  %% \keywords are mandatory in final camera-ready submission


%% \maketitle
%% Note: \maketitle command must come after title commands, author
%% commands, abstract environment, Computing Classification System
%% environment and commands, and keywords command.
\maketitle

\section{Inference System}


\begin{definition}[Encapsulation]
For modules $M$ and $M'$, program configuration $\sigma$, set $S$, and assertion $A$ $M;\ M',\ \sigma\ \vDash\ \encapsulates{S}{A}$ iff
\begin{itemize}
\item
$\exists\ x,\ f,\ y$ such that $M\ \vDash\ \encapsulates{S}{x.f}$ and $M\ \vDash\ x.f\ =\ y\ \longrightarrow\ A$ or
\item
$\exists\ x,\ y$ such that $M\ \vDash\ \encapsulates{S}{y}$ and $M\ \vDash \neg \access{x}{y}\ \longrightarrow\ A$
\end{itemize}
\end{definition}

%\begin{definition}[Class Set]
%For set $S$, we define the class set of $S$ as
%$$\texttt{C}_S \equiv\ \{x\ |\ \exists y.[y\ \in\ S\ \wedge\ y : C\ \wedge\ x : C]\}$$
%\end{definition}

\begin{definition}[Internal Set]
We define the set of all internal objects as
$$I \equiv\ \{x\ |\ \internal{x} \}$$
\end{definition}

\subsection{Only If/Only Through}
\begin{figure}[t]
\footnotesize
\begin{mathpar}
\infer
	{}
	{M\ \vdash\ \onlyThrough{A_1}{A_2}{\texttt{true}}}
	\quad(\textsc{True})
	\and
\infer
	{}
	{
	M\ \vdash\ \onlyThrough{A}{\neg A}{\changes{\_}{A}}
	}
	\quad(\textsc{Changes})
	\and
\infer
	{}
	{
	M\ \vdash\ \onlyThrough{\encapsulated{A}}{\changes{\_}{A}}{\changes{I}{A}\ \vee\ \changes{I}{\encapsulated{A}}}
	}
	\quad(\textsc{Encap})
%	\and
%\infer
%	{
%	M\ \vdash\ \onlyThrough{A_1}{A_2}{\exists x.[A_3]}\\
%	y\ \not\in A_1,\ A_2,\ A_3
%	}
%	{
%	M\ \vdash\ \onlyThrough{A_1}{A_2}{[y/x]A_3}
%	}
%	\quad(\exists_3)
	\and
\infer
	{
	M\ \vdash\ A_1 \longrightarrow A_1'\\
	M\ \vdash\ A_2 \longrightarrow A_2'\\
	M\ \vdash\ A_3' \longrightarrow A_3\\
	M\ \vdash\ \onlyThrough{A_1'}{A_2'}{A_3'}
	}
	{M\ \vdash\ \onlyThrough{A_1}{A_2}{A_3}}
	\quad(\textsc{$\longrightarrow$})
	\and
\infer
	{
	M\ \vdash\ \onlyThrough{A_1}{A_2}{A} \\
	M\ \vdash\ \onlyThrough{A_1'}{A_2}{A'}
	}
	{M\ \vdash\ \onlyThrough{A_1\ \vee\ A_1'}{A_2}{A\ \vee\ A'}}
	\quad(\textsc{$\vee$I$_1$})
	\and
\infer
	{
	M\ \vdash\ \onlyThrough{A_1}{A_2}{A} \\
	M\ \vdash\ \onlyThrough{A_1}{A_2'}{A'}
	}
	{M\ \vdash\ \onlyThrough{A_1}{A_2\ \vee\ A_2'}{A\ \vee\ A'}}
	\quad(\textsc{$\vee$I$_2$})
	\and
\infer
	{
	M\ \vdash\ \onlyThrough{A_1}{A'}{\texttt{false}} \\
	M\ \vdash\ \onlyThrough{A_1}{A_2}{A\ \vee\ A'}
	}
	{M\ \vdash\ \onlyThrough{A_1}{A_2}{A}}
	\quad(\textsc{$\vee$E$_1$})
	\and
\infer
	{
	M\ \vdash\ \onlyThrough{A_1}{A'}{\texttt{false}} \\
	M\ \vdash\ \onlyThrough{A_1}{A_2}{A\ \vee\ A'}
	}
	{M\ \vdash\ \onlyThrough{A_1}{A_2}{A}}
	\quad(\textsc{$\vee$E$_2$})
	\and
\infer
	{
	M\ \vdash\ \onlyThrough{A_1}{A_2}{A_3} \\
	M\ \vdash\ \onlyThrough{A_1}{A_3}{A}
	}
	{M\ \vdash\ \onlyThrough{A_1}{A_2}{A}}
	\quad(\textsc{Trans$_1$})
	\and
\infer
	{
	M\ \vdash\ \onlyThrough{A_1}{A_2}{A_3} \\
	M\ \vdash\ \onlyThrough{A_3}{A_2}{A}
	}
	{M\ \vdash\ \onlyThrough{A_1}{A_2}{A}}
	\quad(\textsc{Trans$_2$})
	\and
\infer
	{
	M\ \vdash\ \onlyIf{A_1}{A_2}{A}
	}
	{M\ \vdash\ \onlyThrough{A_1}{A_2}{A}}
	\quad(\textsc{If})
\end{mathpar}
\caption{\emph{Only Through}}
\label{f:only_through}
\footnotesize
\begin{mathpar}
\infer
	{}
	{M\ \vdash\ \onlyIf{A_1}{A_2}{\texttt{true}}}
	\quad(\textsc{If-True})
	\and
\infer
	{
	M\ \vdash\ A_1 \longrightarrow A_1'\\
	M\ \vdash\ A_2 \longrightarrow A_2'\\
	M\ \vdash\ A_3' \longrightarrow A_3\\
	M\ \vdash\ \onlyIf{A_1'}{A_2'}{A_3'}
	}
	{M\ \vdash\ \onlyIf{A_1}{A_2}{A_3}}
	\quad(\textsc{If-$\longrightarrow$})
	\and
\infer
	{
	M\ \vdash\ \onlyIf{A_1}{A_2}{A} \\
	M\ \vdash\ \onlyIf{A_1'}{A_2}{A'}
	}
	{M\ \vdash\ \onlyIf{A_1\ \vee\ A_	1'}{A_2}{A\ \vee\ A'}}
	\quad(\textsc{If-$\vee$I$_1$})
	\and
\infer
	{
	M\ \vdash\ \onlyIf{A_1}{A_2}{A} \\
	M\ \vdash\ \onlyIf{A_1}{A_2'}{A'}
	}
	{M\ \vdash\ \onlyIf{A_1}{A_2\ \vee\ A_2'}{A\ \vee\ A'}}
	\quad(\textsc{If-$\vee$I$_2$})
	\and
\infer
	{
	M\ \vdash\ \onlyIf{A_1}{A_2}{A\ \vee\ A'} \\
	M\ \vdash\ \onlyThrough{A_1}{A'}{\texttt{false}}
	}
	{M\ \vdash\ \onlyIf{A_1}{A_2}{A}}
	\quad(\textsc{If-$\vee$E$_1$})
	\and
\infer
	{
	M\ \vdash\ \onlyIf{A_1}{A_2}{A\ \vee\ A'} \\
	M\ \vdash\ \onlyThrough{A'}{A_2}{\texttt{false}}
	}
	{M\ \vdash\ \onlyIf{A_1}{A_2}{A}}
	\quad(\textsc{If-$\vee$E$_2$})
	\and
\infer
	{}
	{M\ \vdash\ \onlyIf{A_1}{A_2}{A_1}}
	\quad(\textsc{If-Start})
	\and
\infer
	{
	M\ \vdash\ \onlyThrough{A_1}{A_2}{A_3} \\
	M\ \vdash\ \onlyIf{A_1}{A_3}{A}
	}
	{M\ \vdash\ \onlyIf{A_1}{A_2}{A}}
	\quad(\textsc{If-Trans)}
%	\and
%\infer
%	{
%	M\ \vdash\ \onlyThrough{A_1}{A_2}{A_2}
%	}
%	{M\ \vdash\ \onlyIf{A_1}{A_2}{A_2}}
%	\quad(\textsc{If-Ind)}
\end{mathpar}
\caption{\emph{Only if}}
\label{f:only_if}
\end{figure}

\begin{figure}[t]
\footnotesize
\begin{mathpar}
\infer
		{}
		{
		M\ \vdash\ \calls{x}{y}{m}{args}\ \longrightarrow\ \access{x}{y}
		}
		\quad(\textsc{Calls-Recv})
		\and
\infer
		{}
		{
		M\ \vdash\ \calls{x}{y}{m}{\ldots,z,\ldots}\ \longrightarrow\ \access{x}{z}
		}
		\quad(\textsc{Calls-Args})
%		\and
%\infer
%		{C\ \in\ M}
%		{M\ \vdash\ x : C \longrightarrow\ \internal{x}}
%		\quad(\textsc{Class-Int})
		\and
\infer
		{}
		{M\ \vdash\ \changes{\_}{A}\ \longrightarrow\ A}
		\quad(\textsc{Changes}\longrightarrow)
		\and
\infer
		{}
		{M\ \vdash\ \encapsulates{S_1}{S}\ \longrightarrow\ \encapsulates{S_1\ \cup\ S_2}{S}}
		\quad(\textsc{Encap}-\cup)
		\and
\infer
		{
		\oiInternal{A}{\neg A}{M}{A'}
		}
		{
		M\ \vdash\ \changes{I}{A}\ \longrightarrow\ A'
		}
		\quad(\textsc{Int-Changes})
		\and
\infer
		{}
		{M\ \vdash\ \changes{\_}{\encapsulated{x.f\ =\ \_}}\ \wedge\ \internal{x}\ \longleftrightarrow\ \texttt{false}}
		\quad(\textsc{Encap-Int-f})
		\and
\infer
		{}
		{M\ \vdash\ \changes{\_}{\encapsulated{x.f\ =\ \_}}\ \wedge\ \external{x} \longleftrightarrow\ \changes{I}{\encapsulated{x}}}
		\quad(\textsc{Encap-Ext-f})
%		\and
%\infer
%		{}
%		{
%		M\ \vdash\ 
%			\changes {\_}{x.f = y}\ \wedge\ 
%			\encapsulates{S}{x.f} \longrightarrow\ \\\\
%			\exists\ S.[\changes{S}{x.f = y}\ \wedge\ \forall\ z.[z \not\in S\ \vee\ \internal{z}]]
%		}
%		\quad(\textsc{Int-Mut})
%		\and
%\infer
%		{
%		A_\texttt{encap} = \encapsulates{S_1}{S_2}\\
%		S_C = \{x\ |\ x : C\}
%		}
%		{M\ \vdash\ A_\texttt{encap}\ \wedge\ x\ \in\ S_2\ \wedge \changes {\_}{x.f = y}\ \longrightarrow\ \\\\ 
%		\exists\ z,\ C.[z\ :\ C\ \wedge\ z\ \in\ S_1\ \wedge\ \changes{S_C}{x.f = y}]}
%		\quad(\textsc{Mut})
%		\and
%\infer
%		{
%		A_\texttt{encap} = \encapsulates{S_1}{S_2}\\
%		S_C = \{x\ |\ x : C\}
%		}
%		{
%		M\ \vdash\ A_\texttt{encap}\ \wedge\ y\ \in\ S_2\ \wedge\ x\ \not\in\ S_1\ \cup\ S_2\ \vee\ \changes {\_}{\access{x}{y}} \longrightarrow\ \\\\
%		\exists\ x',\ z,\ C.[x'\ \not\in\ S_1\ \cup\ S_2\ \wedge\ z : C\ \wedge\ z\ \in\ S_1\ \wedge\ \changes{S_C}{\access {x'}{z}}]
%		}
%		\quad(\textsc{Gives})
\end{mathpar}
\caption{Chainmail Consequence Proof Rules}
\label{f:consequence}
\end{figure}

\subsection{Internal/External Boundary}

\newpage

\section{Examples}

\subsection{Bank Account (Old)}
\begin{lstlisting}[mathescape=true]
BankSpec $\triangleq$  a : Account $\wedge$ a.balance = b to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ only if $\neg\ \encapsulated{\texttt{a}}$
\end{lstlisting}
We assume that the method \texttt{deposit} conforms to the following 
specification
\begin{lstlisting}[mathescape=true]
DepositSpec $\triangleq$  {a'.balance = b $\wedge$ a' $\neq$ a $\wedge$ a' $\neq$ from}
					a.deposit(from, amt) 
			   {a'.balance = b}
\end{lstlisting}
And all other methods \texttt{m} in \texttt{Account} conform to the 
following spec
\begin{lstlisting}[mathescape=true]
AccountMethSpec $\triangleq$  {a : Account $\wedge$ a.balance = b}
					  a.m(...) 
			       {a.balance = b}
\end{lstlisting}
From \texttt{DepositSpec}, \texttt{AccountMethSpec}, and Definition \ref{def:module_necessary} we can derive \texttt{BASafety}
\begin{lstlisting}[mathescape=true]
BASafety $\triangleq$  a : Account $\wedge$ $\changes{\_}{\texttt{a.balance = b}}$
            onlyIf $\exists$ a'. [a' : Account $\wedge$ $\calls{\_}{\texttt{a'}}{\texttt{deposit}}{\texttt{a, \_}}$ $\vee$ $\calls{\_}{\texttt{a}}{\texttt{deposit}}{\texttt{a'},\_}$
\end{lstlisting}
Then we assume that all methods $m$ in \texttt{Account} observe the following specification:
\begin{lstlisting}[mathescape=true]
AccountEncapsulation $\triangleq$ {a : Account $\wedge$ $\encapsulated{\texttt{a}}$}
				          a.m(...)
				       {$\encapsulated{\texttt{a}}$}
\end{lstlisting}
And thus from \texttt{AccoutnEncapsulation} and Definition \ref{def:module_necessary} we can derive \texttt{BAEncapsulation}
\begin{lstlisting}[mathescape=true]
BAEncapsulation $\triangleq$  a : Account $\wedge$ $\changes{I}{\encapsulated{\texttt{a}}}$
                 onlyIf false
\end{lstlisting}
%\begin{figure}[p]
\begin{minipage}{\linewidth}
\begin{tcolorbox}
\footnotesize
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[mathescape=true, frame = single, rulecolor = \color{blue}]
a : Account $\wedge$ a.balance = b to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ 
  onlyThrough $\changes{\texttt{\_}}{\texttt{a.balance = b}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Changes}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[mathescape=true]
a : Account $\wedge$ a.balance = b $\wedge$ $\encapsulated{\texttt{a.balance\ =\ b}}$ 
  to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ onlyThrough $\changes{\texttt{\_}}{\texttt{a.balance = b}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by $\longrightarrow_1$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[mathescape=true]
a : Account $\wedge$ a.balance = b $\wedge$ $\encapsulated{\texttt{a.balance = b}}$ 
  to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ 
  onlyThrough $\changes{I}{\texttt{a.balance = b}}$ $\vee$ $\changes{I}{\encapsulated{\text{a.balance = b}}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Encap} and \textsc{Trans}$_1$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[mathescape=true]
a : Account $\wedge$ a.balance = b $\wedge$ $\encapsulated{\texttt{a.balance = b}}$ 
  to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ onlyThrough $\changes{I}{\texttt{a.balance = b}}$ $\vee$ false
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Encap-Int-f} and \textsc{Trans}$_3$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\scriptsize
\begin{lstlisting}[mathescape=true]
a : Account $\wedge$ a.balance = b $\wedge$ $\encapsulated{\texttt{a.balance = b}}$ 
  to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ onlyThrough $\changes{I}{\texttt{a.balance = b}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Trans}$_3$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[mathescape=true]
a : Account $\wedge$ a.balance = b $\wedge$ $\encapsulated{\texttt{a.balance = b}}$ 
  to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ onlyThrough $\exists$ o.[$\access{\texttt{o}}{\texttt{a}}$ $\wedge$ $\external{\texttt{o}}$]
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Int-Changes}, \textsc{BASafety}, and $\longrightarrow_3$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[mathescape=true, frame = none]
ResultA $\triangleq$ a : Account $\wedge$ a.balance = b  to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ 
            onlyThrough $\neg\encapsulated{\texttt{a}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by $\longrightarrow_3$
\end{minipage}
\end{tcolorbox}
\begin{tcolorbox}
\footnotesize
\hfill by \textsc{Changes}
\begin{lstlisting}[mathescape=true, rulecolor=\color{blue}]
a : Account $\wedge$ $\encapsulated{\texttt{a}}$ to $\neg\encapsulated{\texttt{a}}$ onlyThrough $\changes{\_}{\encapsulated{\texttt{a}}}$
\end{lstlisting}
\center{$\Downarrow$ by \textsc{Encap}}
\begin{lstlisting}[mathescape=true]
a : Account $\wedge$ $\encapsulated{\texttt{a}}$ to $\neg\encapsulated{\texttt{a}}$ onlyThrough $\changes{I}{\encapsulated{\texttt{a}}}$
\end{lstlisting}
\center{$\Downarrow$ by \textsc{Int-Changes}, \textsc{BAEncapsulation}, and $\longrightarrow_3$}
\begin{lstlisting}[mathescape=true, rulecolor=\color{red}]
ResultB $\triangleq$ a : Account $\wedge$ $\encapsulated{\texttt{a}}$ to $\neg\encapsulated{\texttt{a}}$ onlyThrough false
\end{lstlisting}
\end{tcolorbox}

\begin{tcolorbox}
\footnotesize
\center{by \textsc{If-True}, \textsc{Excluded Middle}, and \textsc{If}-$\longrightarrow_3$}
\begin{lstlisting}[mathescape=true, rulecolor=\color{blue}]
a : Account $\wedge$ a.balance = b $\wedge$ to $\neg\encapsulated{\texttt{a}}$ 
  onlyIf $\encapsulated{\texttt{a}}$ $\vee$ $\neg\encapsulated{\texttt{a}}$
\end{lstlisting}
\center{$\Downarrow$ by \textsc{If}-$\vee$\textsc{E}$_1$ and \texttt{ResultB}}
\begin{lstlisting}[mathescape=true]
a : Account $\wedge$ a.balance = b $\wedge$ to $\neg\encapsulated{\texttt{a}}$  onlyIf $\neg \encapsulated{\texttt{a}}$
\end{lstlisting}
\center{$\Downarrow$ by \texttt{ResultA} and \textsc{If-Trans}}
\begin{lstlisting}[mathescape=true, rulecolor=\color{red}]
Result $\triangleq$ a : Account $\wedge$ a.balance = b $\wedge$ to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ 
           onlyIf $\neg \encapsulated{\texttt{a}}$
\end{lstlisting}
\end{tcolorbox}

\end{minipage}
%\end{figure}



%% Acknowledgments
\begin{acks}                            %% acks environment is optional
                                        %% contents suppressed with 'anonymous'
  %% Commands \grantsponsor{<sponsorID>}{<name>}{<url>} and
  %% \grantnum[<url>]{<sponsorID>}{<number>} should be used to
  %% acknowledge financial support and will be used by metadata
  %% extraction tools.
  This material is based upon work supported by the
  \grantsponsor{GS100000001}{National Science
    Foundation}{http://dx.doi.org/10.13039/100000001} under Grant
  No.~\grantnum{GS100000001}{nnnnnnn} and Grant
  No.~\grantnum{GS100000001}{mmmmmmm}.  Any opinions, findings, and
  conclusions or recommendations expressed in this material are those
  of the author and do not necessarily reflect the views of the
  National Science Foundation.
\end{acks}


%% Bibliography
\bibliography{Case}


%% Appendix
\appendix
\section{Appendix}

Text of appendix \ldots

\end{document}
