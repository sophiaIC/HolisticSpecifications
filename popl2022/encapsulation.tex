%% For double-blind review submission, w/o CCS and ACM Reference (max submission space)
\documentclass[acmsmall,review,anonymous]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For double-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review,anonymous]{acmart}\settopmatter{printfolios=true}
%% For single-blind review submission, w/o CCS and ACM Reference (max submission space)
%\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For single-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true}
%% For final camera-ready submission, w/ required CCS and ACM Reference
%\documentclass[acmsmall]{acmart}\settopmatter{}


%% Journal information
%% Supplied to authors by publisher for camera-ready submission;
%% use defaults for review submission.
\acmJournal{PACMPL}
\acmVolume{1}
\acmNumber{CONF} % CONF = POPL or ICFP or OOPSLA
\acmArticle{1}
\acmYear{2022}
\acmMonth{1}
\acmDOI{} % \acmDOI{10.1145/nnnnnnn.nnnnnnn}
\startPage{1}

%% Copyright information
%% Supplied to authors (based on authors' rights management selection;
%% see authors.acm.org) by publisher for camera-ready submission;
%% use 'none' for review submission.
\setcopyright{none}
%\setcopyright{acmcopyright}
%\setcopyright{acmlicensed}
%\setcopyright{rightsretained}
%\copyrightyear{2018}           %% If different from \acmYear

%% Bibliography style
\bibliographystyle{ACM-Reference-Format}
%% Citation style
%% Note: author/year citations are required for papers published as an
%% issue of PACMPL.
\citestyle{acmauthoryear}   %% For author/year citations


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Note: Authors migrating a paper from PACMPL format to traditional
%% SIGPLAN proceedings format must update the '\documentclass' and
%% topmatter commands above; see 'acmart-sigplanproc-template.tex'.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%% Some recommended packages.
\usepackage{booktabs}   %% For formal tables:
                        %% http://ctan.org/pkg/booktabs
\usepackage{subcaption} %% For complex figures with subfigures/subcaptions
                        %% http://ctan.org/pkg/subcaption
                        

\usepackage{relsize}
\usepackage{mathpartir}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{listings}
\usepackage{tcolorbox}
\usepackage{xspace}

\newtcolorbox{proofBox}[3][]
{
  colframe = #3,
  colback  = #2,
  #1,
}


%constrained reduction
\newcommand{\constrained}{\mathrel{\leadsto\ \!\!\!\!{\raisebox{1pt}{$\mathsmaller{\mathsmaller{\mathsmaller{\mathsmaller\rvert}}}$}}}}
\newcommand{\reduction}[4]{#1\ ;\ #2\ \bullet\ #3\ \leadsto\ #4}
\newcommand{\reductions}[4]{#1\ ;\ #2\ \bullet\ #3\ \leadsto^*\ #4}
\newcommand{\constrainedReduction}[4]{#1\ ;\ #2\ \bullet\ #3\ \constrained\ #4}
\newcommand{\constrainedReductions}[4]{#1\ ;\ #2\ \bullet\ #3\ \constrained^*\ #4}
\newcommand{\satisfies}[4]{#1\ ;\ #2,\ #3 \vDash\ #4}

\newcommand\trans{\mathlarger{\mathlarger \leadsto}}
\newcommand\intstep{\hspace{1.5mm}{\raisebox{3pt}{$\bullet$}}\hspace{-1.5mm}{\hookrightarrow}}
\newcommand\en{\hspace{1.5mm}{\raisebox{0pt}{$\bullet$}}\hspace{-4mm}{\hookrightarrow}}
\newcommand\oi{\hspace{1mm}{\raisebox{1pt}{$\bullet$}}\hspace{-1mm}{\trans}}
\newcommand\ot{\hspace{2mm}{\raisebox{1pt}{$\bullet$}}\hspace{-3mm}{\trans}}
\newcommand\otAlt{\hspace{2mm}{\raisebox{0.5pt}{$\bullet$}}\hspace{-2.75mm}{\trans}}
\newcommand\mut[3]{\langle #1\ \texttt{mut}\ #2.#3 \rangle}
\newcommand\gives[3]{\langle #1\ \texttt{gives}\ #2\ \texttt{to}\ #3 \rangle}
\newcommand\exposes[2]{#1\ \texttt{exposes}\ #2}
\newcommand\univ{U}
\newcommand\onlyIf[3]{#1\ {\color{blue}\texttt{to}}\ #2\ {\color{blue}\texttt{onlyIf}}\ #3}
\newcommand\oiInternal[4]{#1\ {\color{blue}\texttt{to}}\ #2\ {\color{blue}\texttt{through}}\ #3\ {\color{blue}\texttt{onlyIf}}\ #4}
\newcommand\ensures[3]{#1,\ #2\ \en\ #3}
\newcommand\onlyThrough[3]{#1\ {\color{blue}\texttt{to}}\ #2\ {\color{blue}\texttt{onlyThough}}\ #3}
\newcommand\onlyIfProof[4]{#1\ \vdash\ #2,\ #3\ \texttt{only if}\ #4}
\newcommand\onlyThroughProof[4]{#1\ \vdash\ #2,\ #3\ \texttt{only if}\ #4}
\newcommand\hoare[3]{\{#1\}\ #2\ \{#3\}}
\newcommand\hoareIf[4]{#1,\ #2,\ \{#3\}\ \intstep\ #4}
\newcommand\rtrns[3]{\{#1\}\ #2\ \texttt{returns}\ #3}

\newcommand\encapsulated[1]{\langle {\color{blue}\texttt{encapsulated}}\ #1 \rangle}
\newcommand\encapsulates[2]{\langle #1\ {\color{blue}\texttt{encapsulates}}\ #2 \rangle}
\newcommand\bencapsulated[1]{\langle {\color{blue}\texttt{encapsulated}_{\mathcal{B}}}\ #1 \rangle}
\newcommand\bencapsulates[2]{\langle #1\ {\color{blue}\texttt{encapsulates}_{\mathcal{B}}}\ #2 \rangle}
\newcommand\encapsulatesStrong[2]{\langle #1\ \texttt{encapsulates}_\texttt{strong}\ #2 \rangle}
\newcommand\encapsulatesMdl[1]{\langle \texttt{encapsulating}_\texttt{int}\ #1 \rangle}
\newcommand\calls[4]{\langle #1\ {\color{blue}\texttt{calls}}\ #2.#3(#4) \rangle}
\newcommand\changes[2]{\langle #1\ {\color{blue}\texttt{changes}}\ #2 \rangle}
\newcommand\access[2]{\langle #1\ {\color{blue}\texttt{access}}\ #2 \rangle}
\newcommand\internal[1]{\langle #1\ {\color{blue}\texttt{internal}}\rangle}
\newcommand\external[1]{\langle #1\ {\color{blue}\texttt{external}}\rangle}
\newcommand\comprehension[2]{\{#1 | #2\}}
\newcommand\internalStep{\langle \texttt{internal step}\rangle}
\newcommand\I{\textit{Int}\xspace}

\lstset{ % General setup for the package
	language=Java,
	basicstyle=\scriptsize\sffamily\ttfamily,
 	numberstyle=\tiny,
 	frame = bottomline,
	tabsize=4,
	columns=fixed,
	showstringspaces=false,
	showtabs=false,
	keepspaces,
	morekeywords={true, false, field, method, module, presumes, achieves, requires, ensures, PRE, POST, ghost, bool, int, constr},
	commentstyle=\color{red},
	keywordstyle=\color{blue}
}

\lstdefinelanguage{Chainmail}{
  basicstyle=\scriptsize\sffamily\ttfamily,
  morekeywords={calls, external, internal, access, 
                onlyThrough, onlyIf, to, true, false, through},
  sensitive=false,
  morecomment=[l]{//},
  morecomment=[s]{/*}{*/},
  morestring=[b]",
}


\begin{document}

%% Title information
\title[An Inference System for Holisic Specifications]{An Inference System for Holisic Specifications}         %% [Short Title] is optional;
                                        %% when present, will be used in
                                        %% header instead of Full Title.
%\titlenote{with title note}             %% \titlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'
%\subtitle{Subtitle}                     %% \subtitle is optional
%\subtitlenote{with subtitle note}       %% \subtitlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'


%% Author information
%% Contents and number of authors suppressed with 'anonymous'.
%% Each author should be introduced by \author, followed by
%% \authornote (optional), \orcid (optional), \affiliation, and
%% \email.
%% An author may have multiple affiliations and/or emails; repeat the
%% appropriate command.
%% Many elements are not rendered, but should be provided for metadata
%% extraction tools.

%% Author with single affiliation.
\author{First1 Last1}
\authornote{with author1 note}          %% \authornote is optional;
                                        %% can be repeated if necessary
\orcid{nnnn-nnnn-nnnn-nnnn}             %% \orcid is optional
\affiliation{
  \position{Position1}
  \department{Department1}              %% \department is recommended
  \institution{Institution1}            %% \institution is required
  \streetaddress{Street1 Address1}
  \city{City1}
  \state{State1}
  \postcode{Post-Code1}
  \country{Country1}                    %% \country is recommended
}
\email{first1.last1@inst1.edu}          %% \email is recommended

%% Author with two affiliations and emails.
\author{First2 Last2}
\authornote{with author2 note}          %% \authornote is optional;
                                        %% can be repeated if necessary
\orcid{nnnn-nnnn-nnnn-nnnn}             %% \orcid is optional
\affiliation{
  \position{Position2a}
  \department{Department2a}             %% \department is recommended
  \institution{Institution2a}           %% \institution is required
  \streetaddress{Street2a Address2a}
  \city{City2a}
  \state{State2a}
  \postcode{Post-Code2a}
  \country{Country2a}                   %% \country is recommended
}
\email{first2.last2@inst2a.com}         %% \email is recommended
\affiliation{
  \position{Position2b}
  \department{Department2b}             %% \department is recommended
  \institution{Institution2b}           %% \institution is required
  \streetaddress{Street3b Address2b}
  \city{City2b}
  \state{State2b}
  \postcode{Post-Code2b}
  \country{Country2b}                   %% \country is recommended
}
\email{first2.last2@inst2b.org}         %% \email is recommended


%% Abstract
%% Note: \begin{abstract}...\end{abstract} environment must come
%% before \maketitle command
\begin{abstract}
Text of abstract \ldots.
\end{abstract}


%% 2012 ACM Computing Classification System (CSS) concepts
%% Generate at 'http://dl.acm.org/ccs/ccs.cfm'.
\begin{CCSXML}
<ccs2012>
<concept>
<concept_id>10011007.10011006.10011008</concept_id>
<concept_desc>Software and its engineering~General programming languages</concept_desc>
<concept_significance>500</concept_significance>
</concept>
<concept>
<concept_id>10003456.10003457.10003521.10003525</concept_id>
<concept_desc>Social and professional topics~History of programming languages</concept_desc>
<concept_significance>300</concept_significance>
</concept>
</ccs2012>
\end{CCSXML}

\ccsdesc[500]{Software and its engineering~General programming languages}
\ccsdesc[300]{Social and professional topics~History of programming languages}
%% End of generated code


%% Keywords
%% comma separated list
\keywords{keyword1, keyword2, keyword3}  %% \keywords are mandatory in final camera-ready submission


%% \maketitle
%% Note: \maketitle command must come after title commands, author
%% commands, abstract environment, Computing Classification System
%% environment and commands, and keywords command.
\maketitle

\section{Outline}

\subsection{Intro - Bank Account}

\subsubsection{Robustness}

\subsubsection{Only If/Only Through}

\subsection{Chainmail}

\subsection{Encapsulation}

\subsection{Inference System}

\subsection{Examples}

\subsection{Discussion}

\subsection{Related Work}

\subsection{Conclusion}







\section{Chainmail}
	
	\begin{figure}[h]
	\[
	\begin{array}{llr}
	A & ::= & \textit{Assertions}\\  
	| & e & \\
	| & e\ :\ C & \\
	| & e\ \in\ S & \\
	| & A\ \texttt{in}\ S & \\
	| & \access{x}{y} \\
	| & \internal{x} \\
	| & \external{x} \\
%	| & \mut x y f &\\
%	| & \gives x y z &\\
	| & \calls{x}{y}{m}{args} \\
	| & \changes{S}{A} \\
	| & \neg A & \\
	| & A\ \wedge\ A & \\
	| & A\ \vee\ A & \\
	| & A\ \longrightarrow\ A & \\
	| & \forall\ x.\ [A] & \\
	| & \exists\ x.\ [A] & \\
	| & \forall\ S.\ [A] & \\
	| & \exists\ S.\ [A] &
	\end{array}
%	\begin{array}{llr}
%	s & ::= & \textit{Source}\\
%	| & \texttt{int} & \\
%	| & \texttt{ext} & \\
%	| & \_ &
%	\end{array}
	\]
	\caption{Assertions}
	\label{f:assertions_triple2}
	\end{figure}
Formally, $\changes{S}{A}$ the following semantics:
\begin{itemize}
\item
$M_1\ ;\ M_2,\ \sigma\ \vDash\ \changes {S} {A}$ if and only if there exists $\sigma'$ such that 
\begin{itemize}
\item
$\reduction{M}{M'}{\sigma}{\sigma'}$ and
\item
$M_1\ ;\ M_2,\ \sigma\ \vDash\ A$ and
\item
$M_1\ ;\ M_2,\ \sigma'\ \vDash\ \neg A$ and
\begin{itemize}
\item
$M_1\ \circ\ M_2,\ \bullet\ \sigma\ \leadsto \sigma'$ and $\sigma.(\texttt{this})\ \in\ S$ or
\item
$\exists \sigma_1, \ldots, \sigma_n$ such that
\begin{itemize}
\item
$M_1\ \circ\ M_2,\ \bullet\ \sigma\ \leadsto\ \sigma_1\ \leadsto\ \ldots\ \leadsto\ \sigma_n \leadsto \sigma'$ and
\item
$M_1\ ;\ M_2,\ \sigma_i\ \vDash\ \internal{\sigma_i.(\texttt{this})}$ for all $1 \leq i \leq n$ and
\item
$M_1\ ;\ M_2,\ \sigma_j\ \vDash\ A$ and $M_1\ ;\ M_2,\ \sigma_{j + 1}\ \vDash\ \neg A$ for some $1 \leq j < n$ and
\item
$\sigma_j.(\texttt{this})\ \in\ S$
\end{itemize}
\end{itemize}
\end{itemize}
\end{itemize}


\section{Encapsulation}
We define two forms of encapsulation: (1) encapsulation of sets of objects by sets of objects (topological encapsulation), and (2) encapsulation of assertions by sets of objects (behavioral encapsulation).

The first form of encapsulation is easiest to define, is topological in nature, and refers to which 
objects refer to which other objects in the heap. We use the syntax $\encapsulates{B}{I}$
for topological encapsulation. We define this form of encapsulation as a Chainmail predicate in Def. \ref{def:tencap}.
\begin{definition}[Topological Encapsulation]
\label{def:tencap}
$$\encapsulates{B}{I}\ \equiv\ \forall x,\ y.[y\ \in\ I\ \wedge\ 
														(x\ \in\ B \cup I\ \vee\ 
 														\neg\access{x}{y})]\ \wedge\ 
										\texttt{this}\ \not\in\ B \cup I$$
\end{definition}
That is, for any program state where the current 
computation is occurring externally to the subset of the heap defined by $B \cup I$, 
we say $\encapsulates{B}{I}$ if all objects external to $B$ and $I$ do not have access
to any objects in $I$.
We can use Def. \ref{def:tencap} to extend our notion of topological
encapsulation to include objects and field accesses. We do this in Def. \ref{def:oencap} and \ref{def:fencap}.
\begin{definition}[Topological Object Encapsulation]
\label{def:oencap}
$$\encapsulates{B}{x}\ \equiv\ \exists I.[\encapsulates{B}{I}\ \wedge\ x \in I]$$
\end{definition}
\begin{definition}[Topological Field Encapsulation]
\label{def:fencap}
$$\encapsulates{B}{x.f}\ \equiv\ \encapsulates{B}{x}\ \vee\ x \in B$$
\end{definition}

The second form of encapsulation refers to a behavioral property, and has the form 
$\bencapsulates{B}{A}$, and informally means that any computation that results in a 
change to $A$ requires a prior interaction with an object in $B$. Formally we define 
the semantics in Definition Def. \ref{def:bencap}.
\begin{definition}[Behavioral Encapsulation]
\label{def:bencap}
$\forall$ $M$, $M'$, $\sigma$, $B$, and $A$, \\
$M;\ M',\ \sigma\ \vDash\ \bencapsulates{B}{A}$ iff
$\forall$ $\sigma'$ such that
\begin{itemize}
\item
$\sigma = \sigma'$ or $M;\ M',\ \sigma\ \leadsto^*\ \sigma'$ and
\item
$M;\ M',\ \sigma'\ \vDash\ \changes{\_}{A}$
\end{itemize}
then it follows that $\exists$ $\sigma''$ such that
\begin{itemize}
\item
either
\begin{itemize}
\item
$\sigma = \sigma''$ or 
\item
$M \circ M',\ \sigma\ \leadsto^*\ \sigma''$ and
$M \circ M',\ \sigma''\ \leadsto^*\ \sigma'$
\end{itemize}
and
\item
either
\begin{itemize}
\item
$\sigma''$.(\texttt{contn}) = \texttt{\_ := b.m(...)} and $\texttt{b}\ \in\ B$ or
\item
$\sigma''$.(\texttt{contn}) = \texttt{\_ := b.f} and $\texttt{b}\ \in\ B$ or
\item
$\sigma''$.(\texttt{contn}) = \texttt{b.f := \_} and $\texttt{b}\ \in\ B$
\end{itemize}
\end{itemize}
\end{definition}


The connection between our topological and behavioral definitions of encapsulation is
interesting. The assertions that might be behaviorally encapsulated by a set $B$ include
those assertions that are dependent on objects that are either in $B$, or encapsulated 
by $B$. More specifically, $\bencapsulates{B}{A}$ if satisfaction of $A$ is dependent 
on either a read or a write of data that is topologically encapsulated by $B$.
We now formalize this relationship between Behavioral Encapsulation and Topological Encapsulation in Lemma \ref{lem:behaveToTop}.
\begin{lemma}[Topological Encapsulation implies Behavioral Encapsulation]
\label{lem:behaveToTop}
For modules $M$ and $M'$, program configuration $\sigma$, set $B$, and assertion $A$ we have
\begin{itemize}
\item
(\textsc{Read}):
$\forall\ x,\ y$ if $M;\ M,'\ \sigma \vDash\ \changes{\_}{\neg\access{x}{y}}\ \longrightarrow\ \changes{\_}{A}$ then
$$M;\ M,'\ \sigma \vDash\ \encapsulates{B}{y}\ \longrightarrow\ \bencapsulates{B}{A}$$ and
\item
(\textsc{Write}):
$\forall\ x,\ f,\ y$ if $M;\ M',\ \sigma \vDash\ \changes{\_}{x.f = y}\ \longrightarrow\ \changes{\_}{A}$ 
$$M;\ M',\ \sigma \vDash\ \encapsulates{B}{x.f}\ \longrightarrow \bencapsulates{B}{A}$$
\end{itemize}
%or put as a single Chainmail assertion
%$$M;\ M',\ \sigma\ \vDash\ (\encapsulates{B}{x.f} \wedge (x.f = y \longrightarrow A))\ \vee\ 
%(\encapsulates{B}{y} \wedge (\neg \access{x}{y} \longrightarrow A))
%\longrightarrow \bencapsulates{B}{A}$$
\end{lemma}
%\begin{lemma}[Topological Encapsulation implies Behavioral Encapsulation]
%\label{lem:behaveToTop}
%For modules $M$ and $M'$, program configuration $\sigma$, set $B$, and assertion $A$ we have
%\begin{itemize}
%\item
%(\textsc{Read}):
%$\forall\ x,\ y$ $M;\ M,'\ \sigma \vDash\ \encapsulates{B}{y}\ \longleftrightarrow\ \bencapsulates{B}{\neg \access{x}{y}}$ and
%\item
%(\textsc{Write}):
%$\forall\ x,\ f,\ y$ $M;\ M',\ \sigma \vDash\ \encapsulates{B}{x.f}\ \longleftrightarrow \bencapsulates{B}{x.f = y}$
%\end{itemize}
%%or put as a single Chainmail assertion
%%$$M;\ M',\ \sigma\ \vDash\ (\encapsulates{B}{x.f} \wedge (x.f = y \longrightarrow A))\ \vee\ 
%%(\encapsulates{B}{y} \wedge (\neg \access{x}{y} \longrightarrow A))
%%\longrightarrow \bencapsulates{B}{A}$$
%\end{lemma}
That is any write to fields/read from objects encapsulated by 
$B$ implies that any assertion $A$ dependent on that write/read is behaviorally 
encapsulated by $B$, i.e. $\bencapsulates{B}{A}$.
It is important to note that there are assertions that are behaviorally encapsulated
by some set $B$ that are not related to either reads or writes (i.e. the calling of some private but pure method might be dependent on some external call to $B$).

It is also useful to note that if $\encapsulates{B}{I}$, then while we know that 
any operation that reads from/writes to $I$ necessitates an interaction with $B$,
it does not necessarily require computation by an object in $B$. Specifically, 
in $\mathcal{L}_\text{oo}$ this refers to a broader set that includes any objects
that share a class with an object in $B$. Thus, for any boundary set $B$, we are 
able to define a modifying set of objects of which some element of is required to 
perform some computation to read from/write to any object/field encapsulated by 
$B$. In $\mathcal{L}_\text{oo}$ that set is defined in Def. \ref{def:modSet}
\begin{definition}[Modifying Set]
\label{def:modSet}
For set $B$, we define the modifying set of $B$ as
$$X_B \equiv\ \{x\ |\ \exists y,\ C.[y\ \in\ B\ \wedge\ y : C\ \wedge\ x : C]\}$$
\end{definition}
Def \ref{def:modSet} is language dependent. In $\mathcal{L}_\text{oo}$ $X_B$ refers to
those objects that share a class with a member of $B$, 
but other languages, this might refer some other set of objects.

We also define the set of all internal objects in Def. \ref{def:intSet} along with 
the subset relation in Def. \ref{def:subset}
\begin{definition}[Internal Set]
\label{def:intSet}
We define the set of all internal objects as
$$\I \equiv\ \{x\ |\ \internal{x} \}$$
\end{definition}
\begin{definition}[Subset]
\label{def:subset}
We define the subset relation in Chainmail as
$$S_1\ \subseteq\ S_2\ \equiv\ \forall x.[x\ \in\ S_1\ \longrightarrow\ x\ \in\ S_2]$$
\end{definition}


We note in Lemma \ref{lem:setModSet} that any set is a 
subset of it's modifying set, in Lemma \ref{lem:modSetInternal} that 
any modifying set of an internal set, is itself an internal set, 
in Lemma \ref{lem:modInt} that the modifying set of \I is \I,
and in Lemma \ref{lem:subsetTrans} that the subset relation is transitive.
\begin{lemma}[Set $\subseteq$ Modifying Set]
\label{lem:setModSet}
For all modules $M$ and $M'$, program configurations $\sigma$, and object sets $S$, 
if $M;\ M,\ \sigma\ \vDash S\ \subseteq\ X_S$
\end{lemma}
\begin{lemma}[Internal Modifying Set]
\label{lem:modSetInternal}
For all modules $M$ and $M'$, program configurations $\sigma$, and object sets $S$, 
if $M;\ M,\ \sigma\ \vDash S\ \subseteq\ \I\ \longrightarrow X_S\ \subseteq\ \I$
\end{lemma}
\begin{lemma}[\I = $X_{\I}$]
\label{lem:modInt}
For all modules $M$ and $M'$, and program configurations $\sigma$, 
$M;\ M,\ \sigma\ \vDash \I = X_{\I}$
\end{lemma}
\begin{lemma}[$\subseteq$ Transitivity]
\label{lem:subsetTrans}
For all modules $M$ and $M'$, program configurations $\sigma$, and object sets $S_1$, $S_2$, 
and $S_3$, if $M;\ M,\ \sigma\ \vDash S_1\ \subseteq\ S_2\ \wedge\ S_2\ \subseteq\ S_3\ \longrightarrow\ S_1\ \subseteq\ S_3$
\end{lemma}

Finally, for simplicity, we introduce some notation for encapsulation by the 
internal set in Def. \ref{def:intEncap}
\begin{definition}[Internal Encapsulation]
\label{def:intEncap}
$$\encapsulated{S}\ \equiv\ \encapsulates{\I}{S}$$
$$\encapsulated{x}\ \equiv\ \encapsulates{\I}{x}$$
$$\encapsulated{x.f}\ \equiv\ \encapsulates{\I}{x.f}$$
$$\bencapsulated{A}\ \equiv\ \bencapsulates{\I}{A}$$
\end{definition}

\section{Inference System}  

In this Section we provide an inference system for constructing 
proofs of Chainmail specifications. We start by defining several judgments
\begin{definition}[Chainmail Satisfaction]
For all modules $M$ and $M'$, program configuration $\sigma$,
and Chainmail assertion $A$,
$$M;\ M',\ \sigma\ \vdash\ A$$ 
if and only if satisfaction of $A$ is provable in $\sigma$ with internal module $M$ and external module $M'$.
\end{definition}
It is often useful to refer to Chainmail properties that hold for all
possible program configurations and external modules given some internal module. For 
this purpose we provide the following definition:
\begin{definition}[Chainmail Module Satisfaction]
For all modules $M$ and Chainmail assertions $A$,
$M\ \vdash\ A$ holds
iff for all external modules $M'$ and program configurations $\sigma$ we have
$M; M,\ \sigma \vdash\ A$
\end{definition}

Since the core of Chainmail's
reasoning is about the boundary between known, traditionally specified code,
and unknown, unspecified, and potentially malicious code, we first 
present a mechanism for reasoning about changes to program state
due to internal computation. For this we define a form of specification
for internal computation:
\begin{definition}[Internal Necessary Conditions]
For all modules $M$ and Chainmail assertions $A_1$, $A_2$, and $A$, we say $\oiInternal{A_1}{A_2}{M}{A}$ iff
for all possible method calls $\calls{x}{y}{m}{args}$ on $M$, we are able to prove 
$M\ \vdash\ \hoare{A_1\ \wedge\ \neg A}{y.m(args)}{\neg A_2}$
\end{definition}
Informally we express this as $A$ is a necessary precondition to reach $A_2$ from $A_1$ 
through a single internal method call. 
From this we define a core proof rule for constructing proofs in Chainmail.
\begin{mathpar}
\infer
		{
		\oiInternal{A}{\neg A}{M}{A'}\\\\
		M;\ M',\ \sigma\ \vdash\ \changes{\I}{A}
		}
		{
		M;\ M',\ \sigma\ \vdash\ A'
		}
		\quad(\textsc{Changes-Int})
\end{mathpar}
That is, if $A'$ is a necessary precondition to changing $A$, and
we know that the internal module $M$ changes $A$, with external module $M'$, and program configuration $\sigma$, then we can conclude
that $A'$ is true.

In Fig. \ref{f:chainmail_proof_rules} we provide some more proof rules for 
Chainmail that largely provide reasoning about topological encapsulation and 
changing of program state. 

\begin{figure}[t]
\footnotesize
\begin{mathpar}
\infer
		{M;\ M',\ \sigma\ \vdash\ \calls{x}{y}{m}{\ldots}}
		{
		M;\ M',\ \sigma\ \vdash\ \access{x}{y}
		}
		\quad(\textsc{Calls-Recv})
		\and
\infer
		{M;\ M',\ \sigma\ \vdash\ \calls{x}{y}{m}{\ldots,z,\ldots}}
		{
		M;\ M',\ \sigma\ \vdash\ \access{x}{z}
		}
		\quad(\textsc{Calls-Args})
		\and
\infer
		{M;\ M',\ \sigma\ \vdash\ \calls{x}{y}{m}{\ldots}}
		{
		M;\ M',\ \sigma\ \vdash\ (\internal{x}\ \wedge\ \external{y})\ \vee\ (\external{x}\ \wedge\ \internal{y})
		}
		\quad(\textsc{Calls-Ext/Int})
		\and
\infer
		{
		M;\ M',\ \sigma\ \vdash\ \calls{x}{y}{m}{\ldots} \\
		M;\ M',\ \sigma\ \vdash\ \external{x}
		}
		{
		M;\ M',\ \sigma\ \vdash\ x = \texttt{this}
		}
		\quad(\textsc{Calls-}\texttt{this})
		\and
\infer
		{
		M;\ M',\ \sigma\ \vdash\ \exists y.[A]\\
		\textit{fresh}(x)
		}
		{M;\ M',\ \sigma\ \vdash\ [x/y]A}
		\quad(\textsc{Exists})
		\and
\infer
		{M;\ M',\ \sigma\ \vdash\ \changes{\_}{A}}
		{M;\ M',\ \sigma\ \vdash\ A}
		\quad(\textsc{Changes}\longrightarrow)
		\and
\infer
		{
		M\;\ M',\ \sigma \vdash\ \changes{\_}{\encapsulates{B}{I}}
		}
		{M;\ M',\ \sigma\ \vdash\ \changes{X_B}{\encapsulates{B}{I}}}
		\quad(\textsc{Changes-Encap})
		\and
\infer
		{}
		{M;\ M',\ \sigma\ \vdash\ \neg\encapsulated{\texttt{this}}}
		\quad(\textsc{Encap}-\texttt{this})
		\and
\infer
		{
		M;\ M',\ \sigma\ \vdash\ \encapsulates{B}{x} \\
		M;\ M',\ \sigma\ \vdash\ \access{y}{x}
		}
		{M;\ M',\ \sigma\ \vdash\ y \in B\ \vee\ \encapsulates{B}{y}}
		\quad(\textsc{Encap-Access})
		\and
\infer
		{M;\ M',\ \sigma\ \vdash\ \encapsulates{B}{I}}
		{M;\ M',\ \sigma\ \vdash\ \encapsulates{B \cup S}{I}}
		\quad(\textsc{Encap}-\cup)
		\and
\infer
		{M;\ M',\ \sigma\ \vdash\ x \in B}
		{M;\ M',\ \sigma\ \vdash\ \encapsulates{B}{x.f}}
		\quad(\textsc{Encap-f}_1)
		\and
\infer
		{M;\ M',\ \sigma\ \vdash\ \encapsulates{B}{x}}
		{M;\ M',\ \sigma\ \vdash\ \encapsulates{B}{x.f}}
		\quad(\textsc{Encap-f}_2)
		\and
\infer
		{M;\ M',\ \sigma\ \vdash\ \changes{\_}{\encapsulated{x.f}}\ \wedge\ \internal{x}}
		{M;\ M',\ \sigma\ \vdash\ \texttt{false}}
		\quad(\textsc{Change-Encap-Int-f})
		\and
\infer
		{M;\ M',\ \sigma\ \vdash\ \changes{\_}{\encapsulated{x.f}}\ \wedge\ \external{x}}
		{M;\ M',\ \sigma\ \vdash\ \changes{\I}{\encapsulated{x}}}
		\quad(\textsc{Change-Encap-Ext-f}_1)
		\and
\infer
		{M;\ M',\ \sigma\ \vdash\ \changes{\I}{\encapsulated{x}}\ \wedge\ \external{x}}
		{M;\ M',\ \sigma\ \vdash\ \changes{\I}{\encapsulated{x.f}}}
		\quad(\textsc{Change-Encap-Ext-f}_2)
%		\and
%\infer
%		{
%		M\ \vdash\ \encapsulates{B}{y}\\
%		M\ \vdash\ \changes{\_}{\neg\access{x}{y}}\ \longrightarrow\ \changes{\_}{A}
%		}
%		{
%		M\ \vdash\ \bencapsulates{B}{A}
%		}
%		\quad(\textsc{Encap-Read}_1)
%		\and
%\infer
%		{
%		M\ \vdash\ \bencapsulates{B}{y}\\
%		M\ \vdash\ \changes{\_}{\neg\access{x}{y}}\ \longrightarrow\ \changes{\_}{A}
%		}
%		{
%		M\ \vdash\ \encapsulates{B}{A}
%		}
%		\quad(\textsc{Encap-Read}_2)
%		\and
%\infer
%		{
%		M\ \vdash\ \encapsulates{B}{x.f}\\
%		M\ \vdash\ \changes{\_}{x.f = y}\ \longrightarrow\ \changes{\_}{A}
%		}
%		{
%		M\ \vdash\ \bencapsulates{B}{A}
%		}
%		\quad(\textsc{Encap-Write}_1)
%		\and
%\infer
%		{
%		M\ \vdash\ \bencapsulates{B}{x.f}\\
%		M\ \vdash\ \changes{\_}{x.f = y}\ \longrightarrow\ \changes{\_}{A}
%		}
%		{
%		M\ \vdash\ \encapsulates{B}{A}
%		}
%		\quad(\textsc{Encap-Write}_2)
%		\and
%\infer
%		{}
%		{
%		M\ \vdash\ 
%			\changes {\_}{x.f = y}\ \wedge\ 
%			\encapsulates{S}{x.f} \longrightarrow\ \\\\
%			\exists\ S.[\changes{S}{x.f = y}\ \wedge\ \forall\ z.[z \not\in S\ \vee\ \internal{z}]]
%		}
%		\quad(\textsc{Int-Mut})
%		\and
%\infer
%		{
%		A_\texttt{encap} = \encapsulates{S_1}{S_2}\\
%		S_C = \{x\ |\ x : C\}
%		}
%		{M\ \vdash\ A_\texttt{encap}\ \wedge\ x\ \in\ S_2\ \wedge \changes {\_}{x.f = y}\ \longrightarrow\ \\\\ 
%		\exists\ z,\ C.[z\ :\ C\ \wedge\ z\ \in\ S_1\ \wedge\ \changes{S_C}{x.f = y}]}
%		\quad(\textsc{Mut})
%		\and
%\infer
%		{
%		A_\texttt{encap} = \encapsulates{S_1}{S_2}\\
%		S_C = \{x\ |\ x : C\}
%		}
%		{
%		M\ \vdash\ A_\texttt{encap}\ \wedge\ y\ \in\ S_2\ \wedge\ x\ \not\in\ S_1\ \cup\ S_2\ \vee\ \changes {\_}{\access{x}{y}} \longrightarrow\ \\\\
%		\exists\ x',\ z,\ C.[x'\ \not\in\ S_1\ \cup\ S_2\ \wedge\ z : C\ \wedge\ z\ \in\ S_1\ \wedge\ \changes{S_C}{\access {x'}{z}}]
%		}
%		\quad(\textsc{Gives})
\end{mathpar}
\caption{Chainmail Consequence Proof Rules}
\label{f:chainmail_proof_rules}
\end{figure}


\subsection{Only If/Only Through}

\begin{enumerate}
\item
\emph{Only Through} [$\onlyThrough{A_1}{A_2}{A}$]: If a program execution starts at some $A_1$ state, and reaches some $A_2$ state, then program execution must have passed through some $A$ state.\\
e.g.if the balance of the bank account changes over time, then the paths connecting the two states must contain 
an intermediate program state where the balance is changed.
\item
\emph{Only If} [$\onlyIf{A_1}{A_2}{A}$]: If program execution starts at some $A_1$ state, and reaches some $A_2$ state, 
then the original program state must have also satisfied $A$.\\
e.g. if the balance of a bank account changes over time, then there must be some external object in the current 
program state that has access to the account.
\end{enumerate}

\begin{definition}[\textsc{Only Through}]
\label{def:ot}
$M \vDash\ \onlyThrough {A_1}{A_2}{A}$ if and only if
$\forall M',\ \sigma_1,\ \sigma_2,$ such that 
\begin{itemize}
\item
$M ; M', \sigma_1\ \vDash A_1$
\item
$M ; M', \sigma_2\ \vDash\ A_2$ and
\item
$M ; M'\ \bullet\ \sigma_1\ \constrained^*\ \sigma_2$
\end{itemize}
then $\exists\ \sigma,$ such that
\begin{itemize}
\item
$\sigma\ =\ \sigma_1$ or $M ; M'\ \bullet\ \sigma_1\ \constrained^*\ \sigma$
\item
$\sigma\ =\ \sigma_2$ or $M ; M'\ \bullet\ \sigma\ \leadsto^*\ \sigma_2$
\item
$M ; M',\ \sigma\ \vDash\ A$
\end{itemize}
\end{definition}
We give the definition of ``only  through'' in Def. \ref{def:ot}. Note 
that the intermediate state where $A$ is true might be the initial state ($\sigma_1$),
or final state ($\sigma_2$). 

\begin{definition}[\textsc{Only If}]
\label{def:oi}
$M \vDash\ \onlyIf {A_1}{A_2}{A}$ if and only if
$\forall M',\ \sigma_1,\ \sigma_2,$ such that 
\begin{itemize}
\item
$M ; M', \sigma_1\ \vDash A_1$
\item
$M ; M', \sigma_2\ \vDash\ A_2$ and
\item
$M ; M'\ \bullet\ \sigma_1\ \constrained^*\ \sigma_2$
\end{itemize}
then $M ; M',\ \sigma_1\ \vDash\ A$
\end{definition}
\begin{figure}[t]
\footnotesize
\begin{mathpar}
\infer
	{}
	{M\ \vdash\ \onlyThrough{A_1}{A_2}{\texttt{true}}}
	\quad(\textsc{True})
	\and
\infer
	{}
	{
	M\ \vdash\ \onlyThrough{A}{\neg A}{\changes{\_}{A}}
	}
	\quad(\textsc{Changes})
%	\and
%\infer
%	{}
%	{
%	M\ \vdash\ \onlyThrough{\bencapsulates{B}{A}}{\changes{\_}{A}}{\changes{X_B}{A}\ \vee\ \changes{X_B}{\bencapsulates{B}{A}}}
%	}
%	\quad(\textsc{Encap})
	\and
\infer
	{
	A = \encapsulates{B}{y}
	}
	{
	M\ \vdash\ \onlyThrough{A}{\changes{\_}{\neg\access{x}{y}}}{A \wedge\ (\changes{X_B}{\neg\access{x}{y}}\ \vee\ \changes{X_B}{A})}
	}
	\quad(\textsc{Encap-Read})
	\and
\infer
	{
	A = \encapsulates{B}{x.f}
	}
	{
	M\ \vdash\ \onlyThrough{A}{\changes{\_}{x.f=y}}{A \wedge\ (\changes{X_B}{x.f=y}\ \vee\ \changes{X_B}{A})}
	}
	\quad(\textsc{Encap-Write})
%	\and
%\infer
%	{
%	M\ \vdash\ \onlyThrough{A_1}{A_2}{\exists x.[A_3]}\\
%	y\ \not\in A_1,\ A_2,\ A_3
%	}
%	{
%	M\ \vdash\ \onlyThrough{A_1}{A_2}{[y/x]A_3}
%	}
%	\quad(\exists_3)
	\and
\infer
	{
	M\ \vdash\ A_1 \longrightarrow A_1'\\
	M\ \vdash\ A_2 \longrightarrow A_2'\\
	M\ \vdash\ A_3' \longrightarrow A_3\\
	M\ \vdash\ \onlyThrough{A_1'}{A_2'}{A_3'}
	}
	{M\ \vdash\ \onlyThrough{A_1}{A_2}{A_3}}
	\quad(\textsc{$\longrightarrow$})
	\and
\infer
	{
	M\ \vdash\ \onlyThrough{A_1}{A_2}{A} \\\\
	M\ \vdash\ \onlyThrough{A_1'}{A_2}{A'}
	}
	{M\ \vdash\ \onlyThrough{A_1\ \vee\ A_1'}{A_2}{A\ \vee\ A'}}
	\quad(\textsc{$\vee$I$_1$})
	\and
\infer
	{
	M\ \vdash\ \onlyThrough{A_1}{A_2}{A} \\\\
	M\ \vdash\ \onlyThrough{A_1}{A_2'}{A'}
	}
	{M\ \vdash\ \onlyThrough{A_1}{A_2\ \vee\ A_2'}{A\ \vee\ A'}}
	\quad(\textsc{$\vee$I$_2$})
	\and
\infer
	{
	M\ \vdash\ \onlyThrough{A_1}{A'}{\texttt{false}} \\\\
	M\ \vdash\ \onlyThrough{A_1}{A_2}{A\ \vee\ A'}
	}
	{M\ \vdash\ \onlyThrough{A_1}{A_2}{A}}
	\quad(\textsc{$\vee$E$_1$})
	\and
\infer
	{
	M\ \vdash\ \onlyThrough{A_1}{A'}{\texttt{false}} \\\\
	M\ \vdash\ \onlyThrough{A_1}{A_2}{A\ \vee\ A'}
	}
	{M\ \vdash\ \onlyThrough{A_1}{A_2}{A}}
	\quad(\textsc{$\vee$E$_2$})
	\and
\infer
	{
	M\ \vdash\ \onlyThrough{A_1}{A_2}{A_3} \\\\
	M\ \vdash\ \onlyThrough{A_1}{A_3}{A}
	}
	{M\ \vdash\ \onlyThrough{A_1}{A_2}{A}}
	\quad(\textsc{Trans$_1$})
	\and
\infer
	{
	M\ \vdash\ \onlyThrough{A_1}{A_2}{A_3} \\\\
	M\ \vdash\ \onlyThrough{A_3}{A_2}{A}
	}
	{M\ \vdash\ \onlyThrough{A_1}{A_2}{A}}
	\quad(\textsc{Trans$_2$})
	\and
\infer
	{
	M\ \vdash\ \onlyIf{A_1}{A_2}{A}
	}
	{M\ \vdash\ \onlyThrough{A_1}{A_2}{A}}
	\quad(\textsc{If})
\end{mathpar}
\caption{\emph{Only Through}}
\label{f:only_through}
\footnotesize
\begin{mathpar}
\infer
	{}
	{M\ \vdash\ \onlyIf{A_1}{A_2}{\texttt{true}}}
	\quad(\textsc{If-True})
	\and
\infer
	{}
	{M\ \vdash\ \onlyIf{A_1}{A_2}{A_1}}
	\quad(\textsc{If-Start})
	\and
\infer
	{
	M\ \vdash\ A_1 \longrightarrow A_1'\\
	M\ \vdash\ A_2 \longrightarrow A_2'\\
	M\ \vdash\ A_3' \longrightarrow A_3\\
	M\ \vdash\ \onlyIf{A_1'}{A_2'}{A_3'}
	}
	{M\ \vdash\ \onlyIf{A_1}{A_2}{A_3}}
	\quad(\textsc{If-$\longrightarrow$})
	\and
\infer
	{
	M\ \vdash\ \onlyIf{A_1}{A_2}{A} \\\\
	M\ \vdash\ \onlyIf{A_1'}{A_2}{A'}
	}
	{M\ \vdash\ \onlyIf{A_1\ \vee\ A_	1'}{A_2}{A\ \vee\ A'}}
	\quad(\textsc{If-$\vee$I$_1$})
	\and
\infer
	{
	M\ \vdash\ \onlyIf{A_1}{A_2}{A} \\\\
	M\ \vdash\ \onlyIf{A_1}{A_2'}{A'}
	}
	{M\ \vdash\ \onlyIf{A_1}{A_2\ \vee\ A_2'}{A\ \vee\ A'}}
	\quad(\textsc{If-$\vee$I$_2$})
	\and
\infer
	{
	M\ \vdash\ \onlyIf{A_1}{A_2}{A\ \vee\ A'} \\\\
	M\ \vdash\ \onlyThrough{A_1}{A'}{\texttt{false}}
	}
	{M\ \vdash\ \onlyIf{A_1}{A_2}{A}}
	\quad(\textsc{If-$\vee$E$_1$})
	\and
\infer
	{
	M\ \vdash\ \onlyIf{A_1}{A_2}{A\ \vee\ A'} \\\\
	M\ \vdash\ \onlyThrough{A'}{A_2}{\texttt{false}}
	}
	{M\ \vdash\ \onlyIf{A_1}{A_2}{A}}
	\quad(\textsc{If-$\vee$E$_2$})
	\and
\infer
	{
	M\ \vdash\ \onlyThrough{A_1}{A_2}{A_3} \\
	M\ \vdash\ \onlyIf{A_1}{A_3}{A}
	}
	{M\ \vdash\ \onlyIf{A_1}{A_2}{A}}
	\quad(\textsc{If-Trans)}
%	\and
%\infer
%	{
%	M\ \vdash\ \onlyThrough{A_1}{A_2}{A_2}
%	}
%	{M\ \vdash\ \onlyIf{A_1}{A_2}{A_2}}
%	\quad(\textsc{If-Ind)}
\end{mathpar}
\caption{\emph{Only if}}
\label{f:only_if}
\end{figure}

\subsection{Internal/External Boundary}

\newpage

\section{Examples}

\subsection{Bank Account 1 - Simple}
\label{ex:bank1}
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=lines]
BankSpec $\triangleq$  a : Account $\wedge$ a.balance = b to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ only if $\neg\ \encapsulated{\texttt{a}}$
\end{lstlisting}
We assume that the method \texttt{deposit} conforms to the following 
specification
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=lines]
DepositSpec $\triangleq$  {a'.balance = b $\wedge$ a' $\neq$ a $\wedge$ a' $\neq$ from}
					a.deposit(from, amt) 
			   {a'.balance = b}
\end{lstlisting}
And all other methods \texttt{m} in \texttt{Account} conform to the 
following spec
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=lines]
AccountMethSpec $\triangleq$  {a : Account $\wedge$ a.balance = b}
					  a.m(...) 
			       {a.balance = b}
\end{lstlisting}
From \texttt{DepositSpec} and \texttt{AccountMethSpec} we can derive \texttt{BASafety}
\begin{lstlisting}[language = Chainmail, mathescape=true]
BASafety $\triangleq$  a : Account $\wedge$ a.balance = b 
            to a.balance != b
            through Bank
            onlyIf $\exists$ a'. [a' : Account $\wedge$ $\calls{\_}{\texttt{a'}}{\texttt{deposit}}{\texttt{a, \_}}$ $\vee$ $\calls{\_}{\texttt{a}}{\texttt{deposit}}{\texttt{a'},\_}$
\end{lstlisting}
Then we assume that all methods $m$ in \texttt{Account} observe the following specification:
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=lines]
AccountEncapsulation $\triangleq$ {a : Account $\wedge$ $\encapsulated{\texttt{a}}$}
				          a.m(...)
				       {$\encapsulated{\texttt{a}}$}
\end{lstlisting}
And thus from \texttt{AccoutnEncapsulation} and Definition \ref{def:module_necessary} we can derive \texttt{BAEncapsulation}
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=lines]
BAEncapsulation $\triangleq$  a : Account $\wedge$ $\changes{\I}{\encapsulated{\texttt{a}}}$
                 onlyIf false
\end{lstlisting}
%\begin{figure}[p]
\begin{minipage}{\linewidth}
\begin{proofBox}{white}{black}
\footnotesize
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true, frame = single]
a : Account $\wedge$ a.balance = b 
  to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ 
  onlyThrough $\changes{\texttt{\_}}{\texttt{a.balance = b}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Changes}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ a.balance = b $\wedge$ $\encapsulated{\texttt{a.balance}}$ 
  to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ 
  onlyThrough $\changes{\texttt{\_}}{\texttt{a.balance = b}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by $\longrightarrow$ and \textsc{Encap-f}$_1s$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ a.balance = b $\wedge$ $\encapsulated{\texttt{a.balance = b}}$ 
  to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ 
  onlyThrough $\changes{\I}{\texttt{a.balance = b}}$ $\vee$ 
              $\changes{\I}{\encapsulated{\text{a.balance = b}}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Encap-Write} and \textsc{Trans}$_1$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ a.balance = b $\wedge$ $\encapsulated{\texttt{a.balance = b}}$ 
  to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ 
  onlyThrough $\changes{I}{\texttt{a.balance = b}}$ $\vee$ false
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Encap-Int-f} and \textsc{Trans}$_3$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\scriptsize
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ a.balance = b $\wedge$ $\encapsulated{\texttt{a.balance = b}}$ 
  to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ 
  onlyThrough $\changes{I}{\texttt{a.balance = b}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by $\vee$\textsc{E}$_1$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ a.balance = b $\wedge$ $\encapsulated{\texttt{a.balance = b}}$ 
  to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ 
  onlyThrough $\exists$ o.[$\access{\texttt{o}}{\texttt{a}}$ $\wedge$ $\external{\texttt{o}}$]
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Int-Changes}, \textsc{BASafety}, and $\longrightarrow$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true, frame = none]
ResultA $\triangleq$ a : Account $\wedge$ a.balance = b  
            to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ 
            onlyThrough $\neg\encapsulated{\texttt{a}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by $\longrightarrow$
\end{minipage}
\end{proofBox}

\begin{proofBox}{white}{black}
\footnotesize
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=single]
a : Account $\wedge$ $\encapsulated{\texttt{a}}$ 
  to $\neg\encapsulated{\texttt{a}}$
  onlyThrough $\changes{\_}{\encapsulated{\texttt{a}}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Changes}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ $\encapsulated{\texttt{a}}$ 
  to $\neg\encapsulated{\texttt{a}}$
  onlyThrough $\changes{I}{\encapsulated{\texttt{a}}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Encap}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=none]
ResultB $\triangleq$ a : Account $\wedge$ $\encapsulated{\texttt{a}}$ 
  to $\neg\encapsulated{\texttt{a}}$ 
  onlyThrough false
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Int-Changes}, \textsc{BAEncapsulation}, and $\longrightarrow$
\end{minipage}
\end{proofBox}

\begin{proofBox}{white}{black}
\footnotesize
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=single]
a : Account $\wedge$ a.balance = b $\wedge$ 
  to $\neg\encapsulated{\texttt{a}}$ 
  onlyIf $\encapsulated{\texttt{a}}$ $\vee$ $\neg\encapsulated{\texttt{a}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{If-True}, \textsc{Excluded Middle}, and \textsc{If}-$\longrightarrow$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ a.balance = b $\wedge$ 
  to $\neg\encapsulated{\texttt{a}}$  
  onlyIf $\neg \encapsulated{\texttt{a}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{If}-$\vee$\textsc{E}$_1$ and \texttt{ResultB}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=none]
Result $\triangleq$ a : Account $\wedge$ a.balance = b $\wedge$ 
           to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ 
           onlyIf $\neg \encapsulated{\texttt{a}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \texttt{ResultA} and \textsc{If-Trans}
\end{minipage}
%\begin{minipage}{0.75\textwidth}
%\begin{lstlisting}[mathescape=true, frame=none]
%Result $\triangleq$ a : Account $\wedge$ a.balance = b $\wedge$ 
%           to $\langle\ \neg$ a.balance $\neq$ b $\rangle$ 
%           onlyIf $\neg \bencapsulated{\texttt{a}}$
%\end{lstlisting}
%\end{minipage}
%\begin{minipage}{0.24\textwidth}
%\scriptsize
%\hfill by Lemma \ref{lem:behaveToTop}(\textsc{Read}) and $\longrightarrow$
%\end{minipage}
\end{proofBox}
\end{minipage}
%\end{figure} 

\newpage

\subsection{Bank Account 2 - No Leaking} 
\label{ex:bank2}
In this version of the Bank Account, we show that we 
are able to reason about fairly complex forms of encapsulation.
Specifically if some \texttt{Bank} \texttt{b} encapsulates
some \texttt{Account} a, then it must follow that 
the \texttt{Ledger} \texttt{l} that contains \texttt{a}
is also encapsulated by \texttt{b}, and subsequently that any change to
the balance of \texttt{a} requires a call to \texttt{transfer}
on \texttt{b}. This is interesting because, while other examples
do not provide a way to leak access to an account, this example 
does, but only through the \texttt{Ledger} interface, and thus
encapsulation of the \texttt{Ledger} is sufficient to ensure
encapsulation of the account. Note, this example only proves 
that leaking of an account is not possible, it does not prove 
that encapsulation of an account is always assured under all 
program states. Encapsulation of the account is shown in the
example in Section \ref{ex:bank3}.
\begin{lstlisting}[mathescape=true, frame=lines]
module BankMdl
  class Account
    field bal : int
    method transfer(to, amt)
      this.bal := this.bal - amt
      to.bal := to.bal + amt

  class Ledger
    field acc1 : Account
    field acc2 : Account
    method getAcc1()
      return this.acc1
    method getAcc2()
      return this.acc2

  class Bank
    field accs : Ledger
    method transfer(amt)
      this.accs.getAcc1().transfer(this.accs.getAcc2(), amt)
\end{lstlisting}
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=lines]
BankSpec $\triangleq$ a : Account $\wedge$ a.bal = x $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
             to a.bal $\neq$ x
             onlyThrough $\calls{\_}{\texttt{b}}{\texttt{transfer}}{\_}$
\end{lstlisting}
As with the example in Section \ref{ex:bank1}, we require 
the \verb|Bank| module to prove several invariants:
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=lines]
AccAccess $\triangleq$ a : Account $\wedge$ $\encapsulates{\texttt{B}}{\texttt{a}}$
              to $\neg\encapsulates{\texttt{B}}{\texttt{a}}$
              through BankMdl
              onlyIf $\exists$ o, l. [ l : Ledger $\wedge$ ($\calls{\texttt{o}}{\texttt{l}}{\texttt{getAcc1}}{}$ $\wedge$ l.acc1 = a $\vee$ 
                                                 $\calls{\texttt{o}}{\texttt{l}}{\texttt{getAcc2}}{}$ $\wedge$ l.acc2 = a)]
\end{lstlisting}
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=lines]
BalChange $\triangleq$ a : Account $\wedge$ a.bal = x
              to a.bal $\neq$ x
              through BankMdl
              onlyIf $\exists$ a' o. [a' : Account $\wedge$ $\external{\texttt{o}}$ $\wedge$ 
                            ($\calls{\_}{\texttt{a}}{\texttt{transfer}}{\texttt{a'}, \_}$ $\vee$ $\calls{\_}{\texttt{a'}}{\texttt{transfer}}{\texttt{a}, \_}$)] $\vee$
                     $\exists$ b. [b : Bank $\wedge$ $\calls{\_}{\texttt{b}}{\texttt{transfer}}{\_}$ $\wedge$ 
                            (b.accs.acc1 = a $\vee$ b.accs.acc2 = a)])]
\end{lstlisting}
%We also need to prove a more general property of the encapsulation of account objects by bank objects.
%\begin{lstlisting}[language = Chainmail, mathescape=true, frame=lines]
%AccEncap1 $\triangleq$ b : Bank $\wedge$ ($\encapsulates{\texttt{b}}{\texttt{b.accs.acc1}}$ $\vee$ $\encapsulates{\texttt{b}}{\texttt{b.accs.acc2}}$)
%              $\longrightarrow$ $\encapsulates{\texttt{b}}{\texttt{b.accs}}$
%\end{lstlisting}
Finally we need to prove the following property:
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=lines]
BankEncapUnique $\triangleq$ a : Account $\wedge$ b b' : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$
                    (b'.accs.acc1 = a || b'.accs.acc2 = a)
                    $\longrightarrow$ b' = b
\end{lstlisting}



\begin{proofBox}{white}{black}
\footnotesize
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=single]
a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ 
  $\changes{\_}{\encapsulates{\texttt{b}}{\texttt{a}}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ 
  $\changes{X_\texttt{\{b\}}}{\encapsulates{\texttt{b}}{\texttt{a}}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Changes}-$\longrightarrow$ and \textsc{Changes-Encap}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$ 
  ($\calls{\texttt{x}}{\texttt{l}}{\texttt{getAcc1}}{}$ $\wedge$ l.acc1 = a $\vee$ 
   $\calls{\texttt{x}}{\texttt{l}}{\texttt{getAcc2}}{}$ $\wedge$ l.acc2 = a)
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \texttt{AccAccess}, \textsc{Changes-Int}, and \textsc{Exists}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$ 
  ($\calls{\texttt{x}}{\texttt{l}}{\texttt{getAcc1}}{}$ $\wedge$ l.acc1 = a $\vee$ 
   $\calls{\texttt{x}}{\texttt{l}}{\texttt{getAcc2}}{}$ $\wedge$ l.acc2 = a) $\wedge$ $\external{\texttt{x}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Calls-Ext/Int}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$ 
  x = this $\wedge$ $\access{\texttt{x}}{\texttt{l}}$ $\wedge$ $\access{\texttt{l}}{\texttt{a}}$ $\wedge$ $\external{\texttt{x}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Calls-}\texttt{this} and \textsc{Calls-Recv}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ b : Bank $\wedge$ $\encapsulated{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$
  $\external{\texttt{this}}$ $\wedge$ $\neg \encapsulated{\texttt{this}}$ $\wedge$ $\access{\texttt{this}}{\texttt{l}}$ $\wedge$ 
  ($\encapsulated{\texttt{l}}$ $\vee$ l $\in$ {b})
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Encap-}\texttt{this}, \textsc{Encap-Access}, and \textsc{Encap-}$\cup$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ b : Bank $\wedge$ $\encapsulated{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$ 
  $\external{\texttt{this}}$ $\wedge$ $\neg \encapsulated{\texttt{this}}$ $\wedge$ $\access{\texttt{this}}{\texttt{l}}$ $\wedge$ $\encapsulated{\texttt{l}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by $\vee$\textsc{E}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ b : Bank $\wedge$ $\encapsulated{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$
  $\external{\texttt{this}}$ $\wedge$ $\neg \encapsulated{\texttt{this}}$ $\wedge$ $\encapsulated{\texttt{l}}$ $\wedge$
  ($\encapsulated{\texttt{this}}$ $\vee$ this $\in$ $\I$)
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Encap-Access}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ b : Bank $\wedge$ $\encapsulated{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$
  $\external{\texttt{this}}$ $\wedge$ $\neg \encapsulated{\texttt{this}}$ $\wedge$ $\encapsulated{\texttt{l}}$ $\wedge$
  false
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by $\longrightarrow$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=none]
ResultA $\triangleq$ a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ 
            $\changes{\_}{\encapsulates{\texttt{b}}{\texttt{a}}}$ $\longrightarrow$ false
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\end{minipage}
\end{proofBox}


%\begin{proofBox}{white}{black}
%\footnotesize
%\begin{minipage}{0.75\textwidth}
%\begin{lstlisting}[language = Chainmail, mathescape=true, frame=single]
%a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
%  to $\neg \encapsulates{\texttt{b}}{\texttt{a}}$
%  onlyThrough $\changes{\_}{\encapsulates{\texttt{b}}{\texttt{a}}}$
%\end{lstlisting}
%\end{minipage}
%\begin{minipage}{0.24\textwidth}
%\scriptsize
%\hfill by \textsc{Changes}
%\end{minipage}
%\begin{minipage}{0.75\textwidth}
%\begin{lstlisting}[language = Chainmail, mathescape=true]
%a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
%  to $\neg\encapsulates{\texttt{b}}{\texttt{a}}$
%  onlyThrough $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ $\changes{X_\texttt{\{b\}}}{\encapsulates{\texttt{b}}{\texttt{a}}}$
%\end{lstlisting}
%\end{minipage}
%\begin{minipage}{0.24\textwidth}
%\scriptsize
%\hfill by \textsc{Changes}-$\longrightarrow$, \textsc{Changes-Encap} and $\longrightarrow$
%\end{minipage}
%\begin{minipage}{0.75\textwidth}
%\begin{lstlisting}[language = Chainmail, mathescape=true]
%a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
%  to $\neg\encapsulates{\texttt{b}}{\texttt{a}}$
%  onlyThrough $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$ 
%                  ($\calls{\texttt{x}}{\texttt{l}}{\texttt{getAcc1}}{}$ $\wedge$ l.acc1 = a $\vee$ 
%                   $\calls{\texttt{x}}{\texttt{l}}{\texttt{getAcc2}}{}$ $\wedge$ l.acc2 = a)
%\end{lstlisting}
%\end{minipage}
%\begin{minipage}{0.24\textwidth}
%\scriptsize
%\hfill by \texttt{AccAccess}, \textsc{Changes-Int}, \textsc{Exists}, and $\longrightarrow$
%\end{minipage}
%\begin{minipage}{0.75\textwidth}
%\begin{lstlisting}[language = Chainmail, mathescape=true]
%a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
%  to $\neg\encapsulates{\texttt{b}}{\texttt{a}}$
%  onlyThrough $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$ 
%                  ($\calls{\texttt{x}}{\texttt{l}}{\texttt{getAcc1}}{}$ $\wedge$ l.acc1 = a $\vee$ 
%                   $\calls{\texttt{x}}{\texttt{l}}{\texttt{getAcc2}}{}$ $\wedge$ l.acc2 = a) $\wedge$ $\external{\texttt{x}}$
%\end{lstlisting}
%\end{minipage}
%\begin{minipage}{0.24\textwidth}
%\scriptsize
%\hfill by \textsc{Calls-Ext/Int} and $\longrightarrow$
%\end{minipage}
%\begin{minipage}{0.75\textwidth}
%\begin{lstlisting}[language = Chainmail, mathescape=true]
%a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
%  to $\neg\encapsulates{\texttt{b}}{\texttt{a}}$
%  onlyThrough $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$ x = this $\wedge$
%                  $\access{\texttt{x}}{\texttt{l}}$ $\wedge$ $\access{\texttt{l}}{\texttt{a}}$ $\wedge$ $\external{\texttt{x}}$
%\end{lstlisting}
%\end{minipage}
%\begin{minipage}{0.24\textwidth}
%\scriptsize
%\hfill by \textsc{Calls-}\texttt{this}, \textsc{Calls-Recv} and $\longrightarrow$
%\end{minipage}
%\begin{minipage}{0.75\textwidth}
%\begin{lstlisting}[language = Chainmail, mathescape=true]
%a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
%  to $\neg\encapsulates{\texttt{b}}{\texttt{a}}$
%  onlyThrough $\encapsulated{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$ $\external{\texttt{this}}$ $\wedge$
%                  $\neg \encapsulated{\texttt{this}}$ $\wedge$ $\access{\texttt{this}}{\texttt{l}}$ $\wedge$ 
%                  ($\encapsulated{\texttt{l}}$ $\vee$ l $\in$ {b})
%\end{lstlisting}
%\end{minipage}
%\begin{minipage}{0.24\textwidth}
%\scriptsize
%\hfill by \textsc{Encap-}\texttt{this}, \textsc{Encap-Access}, \textsc{Encap-}$\cup$, and $\longrightarrow$
%\end{minipage}
%\begin{minipage}{0.75\textwidth}
%\begin{lstlisting}[language = Chainmail, mathescape=true]
%a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
%  to $\neg\encapsulates{\texttt{b}}{\texttt{a}}$
%  onlyThrough $\encapsulated{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$ $\external{\texttt{this}}$ $\wedge$
%                  $\neg \encapsulated{\texttt{this}}$ $\wedge$ $\access{\texttt{this}}{\texttt{l}}$ $\wedge$ 
%                  $\encapsulated{\texttt{l}}$
%\end{lstlisting}
%\end{minipage}
%\begin{minipage}{0.24\textwidth}
%\scriptsize
%\hfill by $\longrightarrow$
%\end{minipage}
%\begin{minipage}{0.75\textwidth}
%\begin{lstlisting}[language = Chainmail, mathescape=true]
%a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
%  to $\neg\encapsulates{\texttt{b}}{\texttt{a}}$
%  onlyThrough $\encapsulated{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$ $\external{\texttt{this}}$ $\wedge$
%                  $\neg \encapsulated{\texttt{this}}$ $\wedge$ $\encapsulated{\texttt{l}}$ $\wedge$
%                  ($\encapsulated{\texttt{this}}$ $\vee$ this $\in$ $\I$)
%\end{lstlisting}
%\end{minipage}
%\begin{minipage}{0.24\textwidth}
%\scriptsize
%\hfill by \textsc{Encap-Access} and $\longrightarrow$
%\end{minipage}
%\begin{minipage}{0.75\textwidth}
%\begin{lstlisting}[language = Chainmail, mathescape=true, frame=none]
%ResultA $\triangleq$ a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
%  to $\neg\encapsulates{\texttt{b}}{\texttt{a}}$
%  onlyThrough false
%\end{lstlisting}
%\end{minipage}
%\begin{minipage}{0.24\textwidth}
%\scriptsize
%\hfill by $\longrightarrow$
%\end{minipage}
%\end{proofBox}


\begin{proofBox}{white}{black}
\footnotesize
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=single]
a : Account $\wedge$ a.bal = x $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
  to a.bal $\neq$ x
  onlyThrough $\changes{\_}{\texttt{a.bal = x}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Changes} and $\longrightarrow$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ a.bal = x $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
  to a.bal $\neq$ x
  onlyThrough $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ 
     ($\changes{X_{\{\texttt{b}\}}}{\texttt{a.bal = x}}$ $\vee$ $\changes{X_{\{\texttt{b}\}}}{\encapsulates{\texttt{b}}{\texttt{a}}}$)
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Encap-Write} and $\longrightarrow$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ a.bal = x $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
  to a.bal $\neq$ x
  onlyThrough $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ $\changes{\I}{\texttt{a.bal = x}}$ $\vee$ false
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \texttt{ResultA}, \textsc{Encap-}$\cup$, and $\longrightarrow$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ a.bal = x $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
  to a.bal $\neq$ x
  onlyThrough $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ 
              $\exists$ a' o. [a' : Account $\wedge$ $\external{\texttt{o}}$ $\wedge$ 
                          ($\calls{\texttt{o}}{\texttt{a}}{\texttt{transfer}}{\texttt{a'}, \_}$ $\vee$ 
                           $\calls{\texttt{o}}{\texttt{a'}}{\texttt{transfer}}{\texttt{a}, \_}$)] $\vee$
              $\exists$ b'. [b' : Bank $\wedge$ $\calls{\_}{\texttt{b'}}{\texttt{transfer}}{\_}$ $\wedge$ 
                      (b'.accs.acc1 = a $\vee$ b'.accs.acc2 = a)])]
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \texttt{BalChange}, \textsc{Changes-Int}, and $\longrightarrow$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ a.bal = x $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
  to a.bal $\neq$ x
  onlyThrough $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ 
              ($\external{\texttt{this}}$ $\wedge$ $\access{\texttt{this}}{\texttt{a}}$) $\vee$
              b' : Bank $\wedge$ $\calls{\_}{\texttt{b'}}{\texttt{transfer}}{\_}$ $\wedge$ 
              (b'.accs.acc1 = a $\vee$ b'.accs.acc2 = a)])
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Exists}, \textsc{Calls-Recv}, \textsc{Calls-Args}, \textsc{Calls-}\texttt{this}, and $\longrightarrow$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ a.bal = x $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
  to a.bal $\neq$ x
  onlyThrough $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ 
              ($\encapsulates{\texttt{b}}{\texttt{this}}$ $\vee$ this $\in$ {b}) $\vee$
              b' : Bank $\wedge$ $\calls{\_}{\texttt{b'}}{\texttt{transfer}}{\_}$ $\wedge$ 
              (b'.accs.acc1 = a $\vee$ b'.accs.acc2 = a)])
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Encap-Access}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ a.bal = x $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
  to a.bal $\neq$ x
  onlyThrough $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$
              b' : Bank $\wedge$ $\calls{\_}{\texttt{b'}}{\texttt{transfer}}{\_}$ $\wedge$ 
              (b'.accs.acc1 = a $\vee$ b'.accs.acc2 = a)])
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Encap-}\texttt{this} and $\longrightarrow$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ a.bal = x $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
  to a.bal $\neq$ x
  onlyThrough $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$
              b' : Bank $\wedge$ $\calls{\_}{\texttt{b'}}{\texttt{transfer}}{\_}$ $\wedge$ 
              b' = b
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \texttt{BankEncapUnique} and $\longrightarrow$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
Result $\triangleq$ a : Account $\wedge$ a.bal = x $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
           to a.bal $\neq$ x
           onlyThrough $\calls{\_}{\texttt{b}}{\texttt{transfer}}{\_}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by $\longrightarrow$
\end{minipage}
\end{proofBox}

\newpage

\subsection{Bank Account 3 - General Encapsulation  of Accounts}
\label{ex:bank3}
Ideally we would like the encapsulation of accounts to arise from the definition of \texttt{Bank},
and not have to provide it as a precondition to our robustness property. A preferable holistic 
specification to \texttt{Bank} would be:
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=lines]
BankSpec $\triangleq$ b : Bank $\wedge$ b.accs.acc1.bal = x $\wedge$ b : Bank
             to b.accs.acc1.bal $\neq$ x
             onlyThrough $\calls{\_}{\texttt{b}}{\texttt{transfer}}{\_}$
\end{lstlisting}
That is, under all possible program configurations, the balance of an 
account can only be modified using the \texttt{Bank} interface, i.e.
encapsulation of the \texttt{Account} by the \texttt{Bank} is implicit.
Unfortunately this proof is not possible using the \texttt{Bank} as defined
in Section \ref{ex:bank2} because there is no way to ensure encapsulation
of the \texttt{Account} by the \texttt{Bank} when the \texttt{Bank} is 
created. For this we need to specify how \texttt{Bank}s and \texttt{Account}s are created.
\begin{lstlisting}[mathescape=true, frame=lines]
class Account {
  field bal : int
  constr (amt)
    this.bal := amt
  method transfer(to, amt)
    this.bal := this.bal - amt
    to.bal := to.bal + amt
}
class Ledger {
  field acc1 : Account
  field acc2 : Account
  constr (amt1, amt2)
    this.acc1 := new Account(amt1)
    this.acc2 := new Account(amt2)
  method getAcc1()
    return this.acc1
  method getAcc2()
    return this.acc2
}
class Bank {
  field accs : Ledger
  constr (amt1, amt2)
    this.accs := new Ledger(amt1, amt2)
  method transfer(amt){
    this.accs.getAcc1().transfer(this.accs.getAcc2(), amt)
  }
}
\end{lstlisting}
We also need to a proof rule that allows us to prove program invariants.
\begin{mathpar}
\infer
		{
		M;\ M',\ \sigma\ \vdash\ \exists o.[o : \texttt{Object}\ \wedge\ \forall o'.[o' = o]]\ \longrightarrow\ A\\
		M;\ M',\ \sigma\ \vdash\ \onlyThrough{A}{\neg A}{\texttt{false}}
		}
		{
		M;\ M',\ \sigma\ \vdash\ A
		}
		\quad(\textsc{Invariant})
\end{mathpar}
It is quite simple to prove the following property:
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=single]
$\exists$ o.[o : Object $\wedge$ $\forall$ o'.[o' = o]] $\longrightarrow$ $\forall$ b.[b : Bank $\longrightarrow$ $\encapsulates{\texttt{b}}{\texttt{b.accs.acc1}}$]
\end{lstlisting}
Now we can use the above rule to demonstrate that given the appropriate
traditional specifications on the methods on \texttt{BankMdl} (including the constructors), 
$\encapsulates{\texttt{b}}{\texttt{b.accs.acc1}}$ and $\encapsulates{\texttt{b}}{\texttt{b.accs.acc2}}$ 
are program invariants. i.e. \texttt{BankMdl} must use traditional specifications to 
prove the following about all methods in \texttt{Bank}, \texttt{Ledger}, and \texttt{Account}:
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=lines]
{$\forall$ b.[b : Bank $\longrightarrow$ $\encapsulates{\texttt{b}}{\texttt{b.accs.acc1}}$ $\wedge$ $\encapsulates{\texttt{b}}{\texttt{b.accs.acc2}}$]}
  _.m(...)
{$\forall$ b.[b : Bank $\longrightarrow$ $\encapsulates{\texttt{b}}{\texttt{b.accs.acc1}}$ $\wedge$ $\encapsulates{\texttt{b}}{\texttt{b.accs.acc2}}$]}
\end{lstlisting}
With this we can prove the following internal module invariant for \texttt{BankMdl}
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=lines]
BankEncap $\triangleq$ $\forall$ b.[b : Bank $\longrightarrow$ $\encapsulates{\texttt{b}}{\texttt{b.accs.acc1}}$ $\wedge$ $\encapsulates{\texttt{b}}{\texttt{b.accs.acc2}}$
              to $\neg\forall$ b.[b : Bank $\longrightarrow$ $\encapsulates{\texttt{b}}{\texttt{b.accs.acc1}}$ $\wedge$ $\encapsulates{\texttt{b}}{\texttt{b.accs.acc2}}$
              through BankMdl
              onlyIf false
\end{lstlisting}

Now we can construct a proof of \texttt{BankSpec}. We will re-use the results from Section \ref{ex:bank2} 
as the proofs are much the same.

\begin{proofBox}{white}{black}
\footnotesize
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=single]
b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{b.accs.acc1}}$
  to $\neg$ $\encapsulates{\texttt{b}}{\texttt{b.accs.acc1}}$
  onlyThrough $\changes{\_}{\encapsulates{\texttt{b}}{\texttt{b.accs.acc1}}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{b.accs.acc1}}$
  to $\neg$ $\encapsulates{\texttt{b}}{\texttt{b.accs.acc1}}$
  onlyThrough false
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \texttt{ResultA} (from Section \ref{ex:bank1}) and \textsc{Trans}$_1$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
EncapInv $\triangleq$ $\forall$ b.[b : Bank $\longrightarrow$ $\encapsulates{\texttt{b}}{\texttt{b.accs.acc1}}$]
             to $\neg$ $\forall$ b.[b : Bank $\longrightarrow$ $\encapsulates{\texttt{b}}{\texttt{b.accs.acc1}}$]
             onlyThrough false
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by {\color{red}Julian: We need some rule to extend quantification across the whole statement. Shouldn't be too hard ...}
\end{minipage}
\end{proofBox}

\begin{proofBox}{white}{black}
\footnotesize
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=single]
b : Bank $\wedge$ a : Account $\wedge$ b.acc.acc1 = a $\wedge$ a.bal = x $\wedge$ 
  $\encapsulates{\texttt{b}}{\texttt{a}}$
  to a.bal $\neq$ x
  onlyThrough $\calls{\_}{\texttt{b}}{\texttt{transfer}}{\_}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \texttt{Result}(Section \ref{ex:bank2}) and $\longrightarrow$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
b : Bank $\wedge$ b.acc.acc1.bal = x $\wedge$ $\encapsulates{\texttt{b}}{\texttt{b.acc.acc1}}$
  to b.acc.acc1.bal $\neq$ x
  onlyThrough $\calls{\_}{\texttt{b}}{\texttt{transfer}}{\_}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by $\longrightarrow$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
Bank3Result $\triangleq$ b : Bank $\wedge$ b.acc.acc1.bal = x
                to b.acc.acc1.bal $\neq$ x
                onlyThrough $\calls{\_}{\texttt{b}}{\texttt{transfer}}{\_}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Invariant}, \texttt{EncapInv}, and $\longrightarrow$
\end{minipage}
\end{proofBox}

\newpage



\subsection{Bank Account 4 - Ghost Field Balance {\color{red}(Julian: still working on this)}} 
\label{ex:bank4}
In this version of the Bank Account, we show that we 
are able to reason about fairly complex forms of encapsulation.
Specifically if some \texttt{Bank} \texttt{b} encapsulates
some \texttt{Account} a, then it must follow that 
the \texttt{Ledger} \texttt{l} that contains \texttt{a}
is also encapsulated by \texttt{b}, and subsequently that any change to
the balance of \texttt{a} requires a call to \texttt{transfer}
on \texttt{b}. This is interesting because, while other examples
do not provide a way to leak access to an account, this example 
does, but only through the \texttt{Ledger} interface, and thus
encapsulation of the \texttt{Ledger} is sufficient to ensure
encapsulation of the account. Note, this example only proves 
that leaking of an account is not possible, it does not prove 
that encapsulation of an account is always assured under all 
program states. Encapsulation of the account is shown in the
example in Section \ref{ex:bank3}.
\begin{lstlisting}[mathescape=true, frame=lines]
module BankMdl
  class Account

  class Ledger
    field acc : Account
    field balance : int
    field tail : Ledger
    method addToBalance(amt)
      if a == this.acc
        this.balance := this.balance + amt
    method find(a)
      if a == this.acc
        return this
      else if this.tail == null
        return null
      else
        return this.tail.find(a)
    ghost balance(a)
      if this.acc == a
        return balance
      else if this.tail == null
        return -1
      else 
        return tail.balance(a)

  class Bank
    field accs : Ledger
    
    method transfer(from, to, amt)
      dest := this.accs.find(from);
      src := this.accs.find(to);
      if dest != null && src != null && amt >= 0
        dest.addToBalance(amt)
        src.addToBalance(-1 * amt)
        
    ghost balance(acc) 
      this.accs.balance(acc)
      
\end{lstlisting}
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=lines]
BankSpec $\triangleq$ a : Account $\wedge$ a.bal = x $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
             to a.bal $\neq$ x
             onlyThrough $\calls{\_}{\texttt{b}}{\texttt{transfer}}{\_}$
\end{lstlisting}
As with the example in Section \ref{ex:bank1}, we require 
the \verb|Bank| module to prove several invariants:
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=lines]
AccAccess $\triangleq$ a : Account $\wedge$ $\encapsulates{\texttt{B}}{\texttt{a}}$
              to $\neg\encapsulates{\texttt{B}}{\texttt{a}}$
              through BankMdl
              onlyIf $\exists$ o, l. [ l : Ledger $\wedge$ ($\calls{\texttt{o}}{\texttt{l}}{\texttt{getAcc1}}{}$ $\wedge$ l.acc1 = a $\vee$ 
                                                 $\calls{\texttt{o}}{\texttt{l}}{\texttt{getAcc2}}{}$ $\wedge$ l.acc2 = a)]
\end{lstlisting}
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=lines]
BalChange $\triangleq$ a : Account $\wedge$ a.bal = x
              to a.bal $\neq$ x
              through BankMdl
              onlyIf $\exists$ a' o. [a' : Account $\wedge$ $\external{\texttt{o}}$ $\wedge$ 
                            ($\calls{\_}{\texttt{a}}{\texttt{transfer}}{\texttt{a'}, \_}$ $\vee$ $\calls{\_}{\texttt{a'}}{\texttt{transfer}}{\texttt{a}, \_}$)] $\vee$
                     $\exists$ b. [b : Bank $\wedge$ $\calls{\_}{\texttt{b}}{\texttt{transfer}}{\_}$ $\wedge$ 
                            (b.accs.acc1 = a $\vee$ b.accs.acc2 = a)])]
\end{lstlisting}
%We also need to prove a more general property of the encapsulation of account objects by bank objects.
%\begin{lstlisting}[language = Chainmail, mathescape=true, frame=lines]
%AccEncap1 $\triangleq$ b : Bank $\wedge$ ($\encapsulates{\texttt{b}}{\texttt{b.accs.acc1}}$ $\vee$ $\encapsulates{\texttt{b}}{\texttt{b.accs.acc2}}$)
%              $\longrightarrow$ $\encapsulates{\texttt{b}}{\texttt{b.accs}}$
%\end{lstlisting}
Finally we need to prove the following property:
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=lines]
BankEncapUnique $\triangleq$ a : Account $\wedge$ b b' : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$
                    (b'.accs.acc1 = a || b'.accs.acc2 = a)
                    $\longrightarrow$ b' = b
\end{lstlisting}



\begin{proofBox}{white}{black}
\footnotesize
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=single]
a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ 
  $\changes{\_}{\encapsulates{\texttt{b}}{\texttt{a}}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ 
  $\changes{X_\texttt{\{b\}}}{\encapsulates{\texttt{b}}{\texttt{a}}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Changes}-$\longrightarrow$ and \textsc{Changes-Encap}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$ 
  ($\calls{\texttt{x}}{\texttt{l}}{\texttt{getAcc1}}{}$ $\wedge$ l.acc1 = a $\vee$ 
   $\calls{\texttt{x}}{\texttt{l}}{\texttt{getAcc2}}{}$ $\wedge$ l.acc2 = a)
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \texttt{AccAccess}, \textsc{Changes-Int}, and \textsc{Exists}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$ 
  ($\calls{\texttt{x}}{\texttt{l}}{\texttt{getAcc1}}{}$ $\wedge$ l.acc1 = a $\vee$ 
   $\calls{\texttt{x}}{\texttt{l}}{\texttt{getAcc2}}{}$ $\wedge$ l.acc2 = a) $\wedge$ $\external{\texttt{x}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Calls-Ext/Int}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$ 
  x = this $\wedge$ $\access{\texttt{x}}{\texttt{l}}$ $\wedge$ $\access{\texttt{l}}{\texttt{a}}$ $\wedge$ $\external{\texttt{x}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Calls-}\texttt{this} and \textsc{Calls-Recv}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ b : Bank $\wedge$ $\encapsulated{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$
  $\external{\texttt{this}}$ $\wedge$ $\neg \encapsulated{\texttt{this}}$ $\wedge$ $\access{\texttt{this}}{\texttt{l}}$ $\wedge$ 
  ($\encapsulated{\texttt{l}}$ $\vee$ l $\in$ {b})
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Encap-}\texttt{this}, \textsc{Encap-Access}, and \textsc{Encap-}$\cup$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ b : Bank $\wedge$ $\encapsulated{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$ 
  $\external{\texttt{this}}$ $\wedge$ $\neg \encapsulated{\texttt{this}}$ $\wedge$ $\access{\texttt{this}}{\texttt{l}}$ $\wedge$ $\encapsulated{\texttt{l}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by $\vee$\textsc{E}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ b : Bank $\wedge$ $\encapsulated{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$
  $\external{\texttt{this}}$ $\wedge$ $\neg \encapsulated{\texttt{this}}$ $\wedge$ $\encapsulated{\texttt{l}}$ $\wedge$
  ($\encapsulated{\texttt{this}}$ $\vee$ this $\in$ $\I$)
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Encap-Access}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ b : Bank $\wedge$ $\encapsulated{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$
  $\external{\texttt{this}}$ $\wedge$ $\neg \encapsulated{\texttt{this}}$ $\wedge$ $\encapsulated{\texttt{l}}$ $\wedge$
  false
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by $\longrightarrow$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=none]
ResultA $\triangleq$ a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ 
            $\changes{\_}{\encapsulates{\texttt{b}}{\texttt{a}}}$ $\longrightarrow$ false
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\end{minipage}
\end{proofBox}


%\begin{proofBox}{white}{black}
%\footnotesize
%\begin{minipage}{0.75\textwidth}
%\begin{lstlisting}[language = Chainmail, mathescape=true, frame=single]
%a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
%  to $\neg \encapsulates{\texttt{b}}{\texttt{a}}$
%  onlyThrough $\changes{\_}{\encapsulates{\texttt{b}}{\texttt{a}}}$
%\end{lstlisting}
%\end{minipage}
%\begin{minipage}{0.24\textwidth}
%\scriptsize
%\hfill by \textsc{Changes}
%\end{minipage}
%\begin{minipage}{0.75\textwidth}
%\begin{lstlisting}[language = Chainmail, mathescape=true]
%a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
%  to $\neg\encapsulates{\texttt{b}}{\texttt{a}}$
%  onlyThrough $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ $\changes{X_\texttt{\{b\}}}{\encapsulates{\texttt{b}}{\texttt{a}}}$
%\end{lstlisting}
%\end{minipage}
%\begin{minipage}{0.24\textwidth}
%\scriptsize
%\hfill by \textsc{Changes}-$\longrightarrow$, \textsc{Changes-Encap} and $\longrightarrow$
%\end{minipage}
%\begin{minipage}{0.75\textwidth}
%\begin{lstlisting}[language = Chainmail, mathescape=true]
%a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
%  to $\neg\encapsulates{\texttt{b}}{\texttt{a}}$
%  onlyThrough $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$ 
%                  ($\calls{\texttt{x}}{\texttt{l}}{\texttt{getAcc1}}{}$ $\wedge$ l.acc1 = a $\vee$ 
%                   $\calls{\texttt{x}}{\texttt{l}}{\texttt{getAcc2}}{}$ $\wedge$ l.acc2 = a)
%\end{lstlisting}
%\end{minipage}
%\begin{minipage}{0.24\textwidth}
%\scriptsize
%\hfill by \texttt{AccAccess}, \textsc{Changes-Int}, \textsc{Exists}, and $\longrightarrow$
%\end{minipage}
%\begin{minipage}{0.75\textwidth}
%\begin{lstlisting}[language = Chainmail, mathescape=true]
%a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
%  to $\neg\encapsulates{\texttt{b}}{\texttt{a}}$
%  onlyThrough $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$ 
%                  ($\calls{\texttt{x}}{\texttt{l}}{\texttt{getAcc1}}{}$ $\wedge$ l.acc1 = a $\vee$ 
%                   $\calls{\texttt{x}}{\texttt{l}}{\texttt{getAcc2}}{}$ $\wedge$ l.acc2 = a) $\wedge$ $\external{\texttt{x}}$
%\end{lstlisting}
%\end{minipage}
%\begin{minipage}{0.24\textwidth}
%\scriptsize
%\hfill by \textsc{Calls-Ext/Int} and $\longrightarrow$
%\end{minipage}
%\begin{minipage}{0.75\textwidth}
%\begin{lstlisting}[language = Chainmail, mathescape=true]
%a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
%  to $\neg\encapsulates{\texttt{b}}{\texttt{a}}$
%  onlyThrough $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$ x = this $\wedge$
%                  $\access{\texttt{x}}{\texttt{l}}$ $\wedge$ $\access{\texttt{l}}{\texttt{a}}$ $\wedge$ $\external{\texttt{x}}$
%\end{lstlisting}
%\end{minipage}
%\begin{minipage}{0.24\textwidth}
%\scriptsize
%\hfill by \textsc{Calls-}\texttt{this}, \textsc{Calls-Recv} and $\longrightarrow$
%\end{minipage}
%\begin{minipage}{0.75\textwidth}
%\begin{lstlisting}[language = Chainmail, mathescape=true]
%a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
%  to $\neg\encapsulates{\texttt{b}}{\texttt{a}}$
%  onlyThrough $\encapsulated{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$ $\external{\texttt{this}}$ $\wedge$
%                  $\neg \encapsulated{\texttt{this}}$ $\wedge$ $\access{\texttt{this}}{\texttt{l}}$ $\wedge$ 
%                  ($\encapsulated{\texttt{l}}$ $\vee$ l $\in$ {b})
%\end{lstlisting}
%\end{minipage}
%\begin{minipage}{0.24\textwidth}
%\scriptsize
%\hfill by \textsc{Encap-}\texttt{this}, \textsc{Encap-Access}, \textsc{Encap-}$\cup$, and $\longrightarrow$
%\end{minipage}
%\begin{minipage}{0.75\textwidth}
%\begin{lstlisting}[language = Chainmail, mathescape=true]
%a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
%  to $\neg\encapsulates{\texttt{b}}{\texttt{a}}$
%  onlyThrough $\encapsulated{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$ $\external{\texttt{this}}$ $\wedge$
%                  $\neg \encapsulated{\texttt{this}}$ $\wedge$ $\access{\texttt{this}}{\texttt{l}}$ $\wedge$ 
%                  $\encapsulated{\texttt{l}}$
%\end{lstlisting}
%\end{minipage}
%\begin{minipage}{0.24\textwidth}
%\scriptsize
%\hfill by $\longrightarrow$
%\end{minipage}
%\begin{minipage}{0.75\textwidth}
%\begin{lstlisting}[language = Chainmail, mathescape=true]
%a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
%  to $\neg\encapsulates{\texttt{b}}{\texttt{a}}$
%  onlyThrough $\encapsulated{\texttt{a}}$ $\wedge$ l : Ledger $\wedge$ $\external{\texttt{this}}$ $\wedge$
%                  $\neg \encapsulated{\texttt{this}}$ $\wedge$ $\encapsulated{\texttt{l}}$ $\wedge$
%                  ($\encapsulated{\texttt{this}}$ $\vee$ this $\in$ $\I$)
%\end{lstlisting}
%\end{minipage}
%\begin{minipage}{0.24\textwidth}
%\scriptsize
%\hfill by \textsc{Encap-Access} and $\longrightarrow$
%\end{minipage}
%\begin{minipage}{0.75\textwidth}
%\begin{lstlisting}[language = Chainmail, mathescape=true, frame=none]
%ResultA $\triangleq$ a : Account $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
%  to $\neg\encapsulates{\texttt{b}}{\texttt{a}}$
%  onlyThrough false
%\end{lstlisting}
%\end{minipage}
%\begin{minipage}{0.24\textwidth}
%\scriptsize
%\hfill by $\longrightarrow$
%\end{minipage}
%\end{proofBox}


\begin{proofBox}{white}{black}
\footnotesize
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=single]
a : Account $\wedge$ a.bal = x $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
  to a.bal $\neq$ x
  onlyThrough $\changes{\_}{\texttt{a.bal = x}}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Changes} and $\longrightarrow$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ a.bal = x $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
  to a.bal $\neq$ x
  onlyThrough $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ 
     ($\changes{X_{\{\texttt{b}\}}}{\texttt{a.bal = x}}$ $\vee$ $\changes{X_{\{\texttt{b}\}}}{\encapsulates{\texttt{b}}{\texttt{a}}}$)
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Encap-Write} and $\longrightarrow$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ a.bal = x $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
  to a.bal $\neq$ x
  onlyThrough $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ $\changes{\I}{\texttt{a.bal = x}}$ $\vee$ false
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \texttt{ResultA}, \textsc{Encap-}$\cup$, and $\longrightarrow$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ a.bal = x $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
  to a.bal $\neq$ x
  onlyThrough $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ 
              $\exists$ a' o. [a' : Account $\wedge$ $\external{\texttt{o}}$ $\wedge$ 
                          ($\calls{\texttt{o}}{\texttt{a}}{\texttt{transfer}}{\texttt{a'}, \_}$ $\vee$ 
                           $\calls{\texttt{o}}{\texttt{a'}}{\texttt{transfer}}{\texttt{a}, \_}$)] $\vee$
              $\exists$ b'. [b' : Bank $\wedge$ $\calls{\_}{\texttt{b'}}{\texttt{transfer}}{\_}$ $\wedge$ 
                      (b'.accs.acc1 = a $\vee$ b'.accs.acc2 = a)])]
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \texttt{BalChange}, \textsc{Changes-Int}, and $\longrightarrow$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ a.bal = x $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
  to a.bal $\neq$ x
  onlyThrough $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ 
              ($\external{\texttt{this}}$ $\wedge$ $\access{\texttt{this}}{\texttt{a}}$) $\vee$
              b' : Bank $\wedge$ $\calls{\_}{\texttt{b'}}{\texttt{transfer}}{\_}$ $\wedge$ 
              (b'.accs.acc1 = a $\vee$ b'.accs.acc2 = a)])
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Exists}, \textsc{Calls-Recv}, \textsc{Calls-Args}, \textsc{Calls-}\texttt{this}, and $\longrightarrow$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ a.bal = x $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
  to a.bal $\neq$ x
  onlyThrough $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$ 
              ($\encapsulates{\texttt{b}}{\texttt{this}}$ $\vee$ this $\in$ {b}) $\vee$
              b' : Bank $\wedge$ $\calls{\_}{\texttt{b'}}{\texttt{transfer}}{\_}$ $\wedge$ 
              (b'.accs.acc1 = a $\vee$ b'.accs.acc2 = a)])
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Encap-Access}
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ a.bal = x $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
  to a.bal $\neq$ x
  onlyThrough $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$
              b' : Bank $\wedge$ $\calls{\_}{\texttt{b'}}{\texttt{transfer}}{\_}$ $\wedge$ 
              (b'.accs.acc1 = a $\vee$ b'.accs.acc2 = a)])
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \textsc{Encap-}\texttt{this} and $\longrightarrow$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
a : Account $\wedge$ a.bal = x $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
  to a.bal $\neq$ x
  onlyThrough $\encapsulates{\texttt{b}}{\texttt{a}}$ $\wedge$
              b' : Bank $\wedge$ $\calls{\_}{\texttt{b'}}{\texttt{transfer}}{\_}$ $\wedge$ 
              b' = b
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by \texttt{BankEncapUnique} and $\longrightarrow$
\end{minipage}
\begin{minipage}{0.75\textwidth}
\begin{lstlisting}[language = Chainmail, mathescape=true]
Result $\triangleq$ a : Account $\wedge$ a.bal = x $\wedge$ b : Bank $\wedge$ $\encapsulates{\texttt{b}}{\texttt{a}}$
           to a.bal $\neq$ x
           onlyThrough $\calls{\_}{\texttt{b}}{\texttt{transfer}}{\_}$
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.24\textwidth}
\scriptsize
\hfill by $\longrightarrow$
\end{minipage}
\end{proofBox}



%% Acknowledgments
\begin{acks}                            %% acks environment is optional
                                        %% contents suppressed with 'anonymous'
  %% Commands \grantsponsor{<sponsorID>}{<name>}{<url>} and
  %% \grantnum[<url>]{<sponsorID>}{<number>} should be used to
  %% acknowledge financial support and will be used by metadata
  %% extraction tools.
  This material is based upon work supported by the
  \grantsponsor{GS100000001}{National Science
    Foundation}{http://dx.doi.org/10.13039/100000001} under Grant
  No.~\grantnum{GS100000001}{nnnnnnn} and Grant
  No.~\grantnum{GS100000001}{mmmmmmm}.  Any opinions, findings, and
  conclusions or recommendations expressed in this material are those
  of the author and do not necessarily reflect the views of the
  National Science Foundation.
\end{acks}


%% Bibliography
\bibliography{Case}


%% Appendix
\appendix
\section{Appendix}

Text of appendix \ldots

\end{document}
