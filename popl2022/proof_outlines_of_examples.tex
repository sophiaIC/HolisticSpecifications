%% For double-blind review submission, w/o CCS and ACM Reference (max submission space)
\documentclass[acmsmall,review,anonymous]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For double-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review,anonymous]{acmart}\settopmatter{printfolios=true}
%% For single-blind review submission, w/o CCS and ACM Reference (max submission space)
%\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For single-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true}
%% For final camera-ready submission, w/ required CCS and ACM Reference
%\documentclass[acmsmall]{acmart}\settopmatter{}


%% Journal information
%% Supplied to authors by publisher for camera-ready submission;
%% use defaults for review submission.
\acmJournal{PACMPL}
\acmVolume{1}
\acmNumber{CONF} % CONF = POPL or ICFP or OOPSLA
\acmArticle{1}
\acmYear{2022}
\acmMonth{1}
\acmDOI{} % \acmDOI{10.1145/nnnnnnn.nnnnnnn}
\startPage{1}

%% Copyright information
%% Supplied to authors (based on authors' rights management selection;
%% see authors.acm.org) by publisher for camera-ready submission;
%% use 'none' for review submission.
\setcopyright{none}
%\setcopyright{acmcopyright}
%\setcopyright{acmlicensed}
%\setcopyright{rightsretained}
%\copyrightyear{2018}           %% If different from \acmYear

%% Bibliography style
\bibliographystyle{ACM-Reference-Format}
%% Citation style
%% Note: author/year citations are required for papers published as an
%% issue of PACMPL.
\citestyle{acmauthoryear}   %% For author/year citations


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Note: Authors migrating a paper from PACMPL format to traditional
%% SIGPLAN proceedings format must update the '\documentclass' and
%% topmatter commands above; see 'acmart-sigplanproc-template.tex'.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%% Some recommended packages.
\usepackage{booktabs}   %% For formal tables:
                        %% http://ctan.org/pkg/booktabs
\usepackage{subcaption} %% For complex figures with subfigures/subcaptions
                        %% http://ctan.org/pkg/subcaption
                        

\usepackage{relsize}
\usepackage{mathpartir}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{listings}
\usepackage{xspace}
\usepackage{definitions}
\usepackage{multirow,bigdelim}
\usepackage{pbox}
\usepackage{courier}

\newcommand\multibrace[3]{\rdelim\}{#1}{3mm}[\pbox{#2}{#3}]}

\newcommand{\kjx}[1]{{\color{orange}{#1}}}
\newcommand{\scd}[1]{{\color{blue}{#1}}}
%\newcommand{\sdN}[1]{{\color{dkgreen}{#1}}}
%\newcommand{\jm}[1]{{\color{magenta}{JM: #1}}}
\newcommand{\sdcomment}[1]{{\ensuremath{\blacksquare}}\footnote{\color{dkgreen}{SD: #1}}}
\newcommand{\secomment}[1]{{\ensuremath{\blacksquare}}\footnote{\se{#1}}}
\newcommand{\jncomment}[1]{{\ensuremath{\blacksquare}}\footnote{\kjx{#1}}}

\newcommand{\sd}[1]{{\color{blue}{#1}}}
 \newcommand{\tobyM}[1]{#1} %[1]{{\color{purple}{Toby: #1}}}
\newcommand{\se}[1]{{\color{green}{#1}}}


\newcommand{\ponders}[3]{\marginpar{\tiny\itshape\raggedright\textcolor{#2}{\textbf{#1:} #3}}\ignorespaces}
\marginparwidth=1.6cm \marginparsep=0cm
\newcommand{\TODO}[1]{} % {{\color{red}#1}}
\newcommand{\sophia}[1]{{\color{blue}#1}}
\newcommand{\toby}[1]{} % {\ponders{Toby}{purple}{#1}}
\newcommand{\susan}[2][]{\ponders{Susan}{brown}{#1} \textcolor{brown}{#2}\xspace}
\newcommand{\james}[1]{\ponders{James}{orange}{#1}}
\newcommand{\jm}[2][]{\ponders{Julian}{magenta}{#1} \textcolor{magenta}{#2}\xspace}
\newcommand{\mrr}[2][]{\ponders{Matthew Ross}{offblue}{{#1}} \textcolor{offblue}{{#2}}\xspace}
\newcommand{\mrrz}[1]{\textcolor{offblue}{{#1}}\xspace}
\newcommand{\Mrr}[2][]{\ponders{Matthew Ross}{teal}{{#1}} \textcolor{teal}{{#2}}\xspace}
\newcommand{\Mrrz}[1]{\textcolor{teal}{{#1}}\xspace}

\newcommand{\sophiaPonder}[2][]{\ponders{Sophia}{blue}{#1} \textcolor{blue}{#2}\xspace}
\renewcommand{\sophia}[2][]


\begin{document}

%% Title information
%\title[Specification and Proof of Necessary Conditions]{Specification
%and Proof of Necessary Conditions}         %% [Short Title] is
%optional;
%\title{Necessity Specifications are Necessary}
\title{\Nec Specifications are Necessary for Robustness}
                                        %% when present, will be used in
                                        %% header instead of Full Title.
%\titlenote{with title note}             %% \titlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'
%\subtitle{Subtitle}                     %% \subtitle is optional
%\subtitlenote{with subtitle note}       %% \subtitlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'


%% Author information
%% Contents and number of authors suppressed with 'anonymous'.
%% Each author should be introduced by \author, followed by
%% \authornote (optional), \orcid (optional), \affiliation, and
%% \email.
%% An author may have multiple affiliations and/or emails; repeat the
%% appropriate command.
%% Many elements are not rendered, but should be provided for metadata
%% extraction tools.

%% Author with single affiliation.
\author{First1 Last1}
\authornote{with author1 note}          %% \authornote is optional;
                                        %% can be repeated if necessary
\orcid{nnnn-nnnn-nnnn-nnnn}             %% \orcid is optional
\affiliation{
  \position{Position1}
  \department{Department1}              %% \department is recommended
  \institution{Institution1}            %% \institution is required
  \streetaddress{Street1 Address1}
  \city{City1}
  \state{State1}
  \postcode{Post-Code1}
  \country{Country1}                    %% \country is recommended
}
\email{first1.last1@inst1.edu}          %% \email is recommended

%% Author with two affiliations and emails.
\author{First2 Last2}
\authornote{with author2 note}          %% \authornote is optional;
                                        %% can be repeated if necessary
\orcid{nnnn-nnnn-nnnn-nnnn}             %% \orcid is optional
\affiliation{
  \position{Position2a}
  \department{Department2a}             %% \department is recommended
  \institution{Institution2a}           %% \institution is required
  \streetaddress{Street2a Address2a}
  \city{City2a}
  \state{State2a}
  \postcode{Post-Code2a}
  \country{Country2a}                   %% \country is recommended
}
\email{first2.last2@inst2a.com}         %% \email is recommended
\affiliation{
  \position{Position2b}
  \department{Department2b}             %% \department is recommended
  \institution{Institution2b}           %% \institution is required
  \streetaddress{Street3b Address2b}
  \city{City2b}
  \state{State2b}
  \postcode{Post-Code2b}
  \country{Country2b}                   %% \country is recommended
}
\email{first2.last2@inst2b.org}         %% \email is recommended


%% Abstract
%% Note: \begin{abstract}...\end{abstract} environment must come
%% before \maketitle command
\begin{abstract}
\end{abstract}


%% 2012 ACM Computing Classification System (CSS) concepts
%% Generate at 'http://dl.acm.org/ccs/ccs.cfm'.
\begin{CCSXML}
<ccs2012>
<concept>
<concept_id>10011007.10011006.10011008</concept_id>
<concept_desc>Software and its engineering~General programming languages</concept_desc>
<concept_significance>500</concept_significance>
</concept>
<concept>
<concept_id>10003456.10003457.10003521.10003525</concept_id>
<concept_desc>Social and professional topics~History of programming languages</concept_desc>
<concept_significance>300</concept_significance>
</concept>
</ccs2012>
\end{CCSXML}

\ccsdesc[500]{Software and its engineering~General programming languages}
%\ccsdesc[300]{Social and professional topics~History of programming languages}
%% End of generated code


%% Keywords
%% comma separated list
%%%%%%%%%%%%%%%%%%%%%\keywords{keyword1, keyword2, keyword3}  %% \keywords are mandatory in final camera-ready submission


%% \maketitle
%% Note: \maketitle command must come after title commands, author
%% commands, abstract environment, Computing Classification System
%% environment and commands, and keywords command.
\maketitle
 
\section{More Bank Specifications}
 
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=lines]
NecessityBankSpec$_a$  $\triangleq$  from a:Account $\wedge$ a.balance==bal  next a.balance < bal
                       onlyIf $\exists$ o.[$\external{\prg{o}}$ $\wedge$ $\access{\prg{o}}{\prg{a.pwd}}$]                                           

NecessityBankSpec$_b$  $\triangleq$  from a:Account $\wedge$ a.balance==bal  next a.balance < bal
                       onlyIf $\exists$ o.[$\external{\prg{o}}$ $\wedge$ $\calls{\prg{o}}{\prg{a}}{\prg{transfer}}{\prg{\_, \_, \_}}$]
                       
NecessityBankSpec$_c$  $\triangleq$  from a:Account $\wedge$ a.balance==bal to a.balance < bal
                       onlyIf $\exists$ o.[$\external{\prg{o}}$ $\wedge$ $\calls{\prg{o}}{\prg{a}}{\prg{transfer}}{\prg{\_, \_, \_}}$]
                       
NecessityBankSpec$_d$  $\triangleq$  from a:Account $\wedge$ a.balance==bal to a.balance < bal
                       onlyThrough $\exists$ o.[$\external{\prg{o}}$ $\wedge$ $\calls{\prg{o}}{\prg{a}}{\prg{transfer}}{\prg{\_, \_, \_}}$]
\end{lstlisting}

\subsection{\prg{NecessityBankSpec}$_a$}

\begin{description}
\item[Prove Encapsulation (Part 1):]
We start by proving that \prg{a.balance} is encapsulated, and subsequently that \prg{a.balance = bal} is encapsulated (since \prg{bal} is an integer and thus also encapsulated).
\item[Per-Method \Nec Specifications (Part 2):]
We use a Hoare logic to prove the following classcial spec for the \prg{transfer} 
method
\begin{lstlisting}[language = Chainmail, mathescape = true, frame = lines]
{ a : Account $\wedge$ a.balance == bal $\wedge$ $\neg$ (a' == a $\wedge$ pass == a.pwd) }
  a'.transfer(pass, _, _)
{$\neg$ a.balance < bal}
\end{lstlisting}
We then use \textsc{If1-Classical} and the above specification to arrive at
\begin{lstlisting}[language = Chainmail, mathescape = true, frame = lines]
from a : Account $\wedge$ a.balance == bal $\wedge$ _ calls a'.transfer(pass, _, _) 
next balance < bal
onlyIf a' == a $\wedge$ pass == a.pwd
\end{lstlisting}
Then we use the Hoare logic to prove each other method in \prg{Mdl} satisfies the following 
classical spec:
\begin{lstlisting}[language = Chainmail, mathescape = true, frame = lines]
{ a : Account $\wedge$ a.balance == bal }
  x.m($\overline{\prg{y}}$)
{$\neg$ a.balance < bal}
\end{lstlisting}
where \prg{x} is some object of class $\prg{C}\ \in\ \prg{Mdl}$. 
We subsequently use \textsc{If1-Classical} to prove
\begin{lstlisting}[language = Chainmail, mathescape = true, frame = lines]
from a : Account $\wedge$ a.balance == bal $\wedge$ _ calls x.m($\overline{\prg{y}}$)
next a.balance < bal
onlyIf false
\end{lstlisting}

\item[Per-Step \Nec Specification (Part 3):]
Next we use the result from Parts 1 and 2 and \textsc{Nxt-Internal} to 
prove the following \Nec specification:
\begin{lstlisting}[language = Chainmail, mathescape = true, frame = lines]
from a:Account $\wedge$ a.balance == bal
next a.balance < bal
onlyIf _ calls a.transfer(a.pwd, _, _)
\end{lstlisting}
\prg{NecessityBankSpec$_a$} follows easily from above.
\end{description}

\subsection{\prg{NecessityBankSpec}$_b$}
The proof of \prg{NecssitiyBankSpec$_b$} is an intermediate result of \prg{NecessityBankSpec$_a$}.

\subsection{\prg{NecessityBankSpec}$_c$}
This is not true!!!!!

\subsection{\prg{NecessityBankSpec}$_d$}


\section{Proof Outline of The DOM}

\begin{lstlisting}[language = Chainmail, mathescape=true, frame=lines]
DOMSpec $\triangleq$ from nd : Node $\wedge$ nd.property = p  to nd.property != p
          onlyIf $\exists$ o.[ $\external {\prg{o}}$ $\wedge$ 
                       $( \  \exists$ nd':Node.[ $\access{\prg{o}}{\prg{nd'}}$ ]  $\vee$ 
                         $\exists$ pr:Proxy,k:$\mathbb{N}$.[$\, \access{\prg{o}}{\prg{pr}}$ $\wedge$ nd.parent$^{\prg{k}}$=pr.node.parent$^{\prg{pr.height}}$ ] $\,$ ) $\,$ ]
\end{lstlisting}

\begin{description}
\item[Part 1:]

\item[Part 2:]
\item[Part 3:]
\item[Part 4:]
\end{description}

\section{ERC20}
\begin{lstlisting}[language = Chainmail, mathescape=true, frame=lines]
ERC20Spec1 $\triangleq$ from e : ERC20 $\wedge$ e.balance(p) = m + m' $\wedge$ m > 0
              next e.balance(p) = m'
              onlyIf $\exists$ p' p''.[$\calls{\prg{p'}}{\prg{e}}{\prg{transfer}}{\prg{p, m}}$ $\vee$ 
                     e.allowed(p, p'') $\geq$ m $\wedge$ $\calls{\prg{p''}}{\prg{e}}{\prg{transferFrom}}{\prg{p', m}}$]
\end{lstlisting}
The proof of \prg{ERC20Spec1} follows much the same format as that of \prg{NecessityBankSpec},
except adding a case where an authorized participant may transfer money from another's account.

\begin{lstlisting}[language = Chainmail, mathescape=true, frame=lines]
ERC20Spec2 $\triangleq$ from e : ERC20 $\wedge$ p : Object $\wedge$ p' : Object $\wedge$ m : Nat
              next e.allowed(p, p') = m
              onlyIf $\calls{\prg{p}}{\prg{e}}{\prg{approve}}{\prg{p', m}}$ $\vee$ 
                     (e.allowed(p, p') = m $\wedge$ 
                      $\neg$ ($\calls{\prg{p'}}{\prg{e}}{\prg{transferFrom}}{\prg{p, \_}}$ $\vee$ 
                              $\calls{\prg{p}}{\prg{e}}{\prg{allowed}}{\prg{p, \_}}$)) $\vee$
                     $\exists$ p''. [e.allowed(p, p') = m + m' $\wedge$ $\calls{\prg{p'}}{\prg{e}}{\prg{transferFrom}}{\prg{p'', m'}}$]
\end{lstlisting}
As with \prg{ERC20Spec1}, the proof of \prg{ERC20Spec2} is similar to that of \prg{NecessityBankSpec}, 
where we first show that $\neg$ \prg{e.allowed(p, p') = m} is encapsulated by the internal \prg{ERC} module.

\section{DAO}

\begin{lstlisting}[language = Chainmail, mathescape=true, frame=lines]
DAOSpec1 $\triangleq$ from d : DAO $\wedge$ p : Object
            to d.balance(p) > d.ether
            onlyIf false
\end{lstlisting}

\begin{lstlisting}[language = Chainmail, mathescape=true, frame=lines]
DAOSpec2 $\triangleq$ from d : DAO $\wedge$ p : Object
            next d.balance(p) = m
            onlyIf $\calls{\prg{p}}{\prg{d}}{\prg{repay}}{\prg{\_}}$ $\wedge$ m = 0 $\vee$ $\calls{\prg{p}}{\prg{d}}{\prg{join}}{\prg{m}}$ $\vee$ d.balance(p) = m
\end{lstlisting}
The proof of \prg{DAOSpec2} starts by proving that \prg{d.balance(p)} is encapsulated.
Using a Hoare logic and \textsc{If1-Classical}, we prove that if \prg{d.balance(p)} changes,
then either \prg{d.repay(\_)} or \prg{d.join(m)} was called, and in both cases 
\prg{p} being the caller was a necessary precondition. For all other methods in the DAO module, we prove that \prg{false} is a necessary precondition to changing \prg{d.balance(p)}.
We then use \textsc{If1-Classical} to raise these per-method \Nec specifications to per-step specifications. We then use \textsc{Excluded-Middle} and \Nec logic rules to prove 
\prg{DAOSpec2}.

\section{The Safe}

\begin{lstlisting}[language = Chainmail, mathescape=true, frame=lines]
SafeSpec $\triangleq$ from s : Safe $\wedge$ s.treasure != null
            to s.treasure == null
            onlyIf $\neg$ inside(s.secret)
\end{lstlisting}

The module  \prg{SafeModule} described  below satisfies  \prg{SafeSpec}.

\begin{lstlisting}[frame=lines]
module SafeModule
     class Secret{}
     class Treasure{}
     class Safe{
         field treasure : Treasure
         field secret : Secret
         method take(scr : Secret){
              if (this.secret==scr) then {
                   t=treasure
                   this.treasure = null
                   return t } 
          }
 }
\end{lstlisting}
The proof of \prg{SafeModule}'s satisfaction of \prg{SafeSpec} 
starts by proving that $inside (s.secret)$ is encapsulated. Then
using Hoare logic and \textsc{If1-Inside}, we show that \prg{take} can only expose 
\prg{s.treasure} if \prg{s} is the reciever of the call, and \prg{s.secret}
is the argument. We then raise that \emph{per-method} \Nec specification
to a \emph{per-step} \Nec specification using \textsc{If1-Internal} to prove 
that exposing \prg{s.treasure} in a single step requires a call \prg{s.take(s.secret)}.
Then using \textsc{Changes} we raise the \emph{per-step} \Nec specification to
a general \Nec specification for all executions. Finally it is enough to show 
that it is not possible to expose \prg{s.secret} to get the desired result.

 





%% Acknowledgments
\begin{acks}                            %% acks environment is optional
                                        %% contents suppressed with 'anonymous'
  %% Commands \grantsponsor{<sponsorID>}{<name>}{<url>} and
  %% \grantnum[<url>]{<sponsorID>}{<number>} should be used to
  %% acknowledge financial support and will be used by metadata
  %% extraction tools.
  This material is based upon work supported by the
  \grantsponsor{GS100000001}{National Science
    Foundation}{http://dx.doi.org/10.13039/100000001} under Grant
  No.~\grantnum{GS100000001}{nnnnnnn} and Grant
  No.~\grantnum{GS100000001}{mmmmmmm}.  Any opinions, findings, and
  conclusions or recommendations expressed in this material are those
  of the author and do not necessarily reflect the views of the
  National Science Foundation.
\end{acks}


%% Bibliography
\bibliography{Case,more}


\end{document}
