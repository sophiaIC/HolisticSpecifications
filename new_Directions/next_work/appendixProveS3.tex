\newcommand{\SThree}{S_3}
\newcommand{\SThreeStrong}{S_{3,strong}}

\subsection{Demonstrating that $M_{good} \vdash \SThree$, and that $M_{fine} \vdash \SThree$}
 \label{s:app:example:proofs}


 \subsection{Extending the specification $\SThree$}
\label{s:extend:spec:three}

As in \S \ref{s:extend:spec}, we redefine $\SThree$ so that it also describes the behaviour of method \prg{send}. and have:
\\
%{\sprepost
%		{\strut \ \ \ \ \ \ \ \ \ S_{3a}} 
%		{ \prg{a}:\prg{Account}, \prg{e}:\prg{external}, \prg{b}:\prg{int} \ \wedge \protectedFrom{\prg{a.key}} {\prg{e} }\ \wedge\ \prg{a}.\balance \geq\prg{b}\  } % \wedge \prg{a.blnce}=\prg{b} }
%		 {\prg{private Shop}}
%		 {\prg{send}}
%		 {\prg{buyer}:\prg{external},\prg{anItem}:\prg{Item} }
%		 { \protectedFrom{\prg{a.key}} {e} \wedge   \prg{a}.\balance \geq\prg{b}\ } 
%		 { \protectedFrom{\prg{a.key}} {e}\wedge   \prg{a}.\balance \geq\prg{b}\ } 
%}
%\\
%{\sprepost
%		{\strut \ \ \ \ \ \ \ \ \ S_{2b}} 
%		{ \prg{a}:\prg{Account} \wedge \prg{a.blnce} =\prg{b} }
%		 {\prg{private Shop}}
%		 {\prg{send}}
%		 {\prg{buyer}:\prg{external}, \prg{anItem}:\prg{Item} }
%		 { \prg{a.blnce} =\prg{b} }
%		{   \prg{a.blnce} =\prg{b} }
%}
\\
$\strut  \SPSP  \SThreeStrong \ \  \triangleq \ \ \ \SThree \ \wedge \ S_{2a} \ \wedge \ S_{2b} $

%$\strut  \SPSP  \STwo\ \  \triangleq \ \ \TwoStatesN   \ \wedge\  
%{ \mprepostN {\prg{a:Account}\wedge \protectedFrom{\prg{a.key}} {\prg{buyer}}}
%                     {A_2} {A_3} }\ $ 


  

\begin{lemma}
\label{lemma:S3}
\label{l:Mgood:S3}
$M_{good} \vdash \SThreeStrong$
\end{lemma}
\begin{proofO}
%We construct our proof tree using a top down approach.  
In order to prove that 
$$M_{good} \vdash \TwoStatesN {\prg{a}:\prg{Account}, b:\prg{int} }{\  \inside{\prg{\prg{a.key}}} \wedge \prg{a.\balance}\geq b\ }$$
we have to apply  \textsc{Invariant} from Fig. \ref{f:wf}.
 That is, for each  class $C$  defined in $M_{good}$, and for each public method $m$ in $C$, with parameters $\overline{y:D}$, we have to prove that they satisfy the corresponding quadruples.
 

% \small
%\begin{align*}
%M_{good}\ \vdash \ \ &   \{ \ \prg{this}:\prg{C},\, \overline{y:D},\, \prg{a}:\prg{Account}\, \wedge\,
%		             {\inside{\prg{a.key}}}\ \wedge\       \protectedFrom {\prg{a.key}} {(\prg{this},\overline y)} \  \} \\
%		& \SPT  \prg{C}::\prg{m}.\prg{body}\  \\
%		&
%                   \{\ {\inside{\prg{a.key}}}\ \wedge\ \ \protectedFrom {\prg{a.key}} {\prg{res}}   \ \}\ ||\ \{\ {\inside{\prg{a.key} } } \ \} \\
%\end{align*}


\normalsize
Thus, we need to prove  three Hoare quadruples: one for \prg{Shop::buy}, one for  \prg{Account::transfer}, and one for  \prg{Account::set}.  That is, we have to prove that
 \small
\begin{align*}
\text{(31?)}  \ \ \ \ M_{good}\ \vdash  \  \ 
		&	\{  \ \Alocals, \, \prg{a}:\prg{Account}, b:\prg{int} \, \wedge\, {\inside{\prg{a.key}}} \, \wedge \, \protectedFrom {\prg{a.key}} {\Ids} \wedge \prg{a.\balance}\geq b \  \} \\
		& \SPT \prg{Shop}::\prg{buy}.\prg{body}\ \\  
		& \{ {\inside{\prg{a.key}}}\ \wedge\ {\PushASLong {\prg{res}} {\inside{\prg{a.key}}}}  \wedge \prg{a.\balance}\geq b \} \ \ \  || \ \ \ 
		   \{ {\inside{\prg{a.key}}}  \wedge \prg{a.\balance}\geq b \}
\\
\text{(32?)}  \ \ \ \ M_{good} \vdash \ 
		&	\{  \ \Alocalstr, \, \prg{a}:\prg{Account}\, , b:\prg{int} \, \wedge\,  {\inside{\prg{a.key}}} \, \wedge \, \protectedFrom {\prg{a.key}} {\Idstr}  \ \wedge \prg{a.\balance}\geq b \  \} \\
		& \SPT \prg{Account}::\prg{transfer}.\prg{body}\ \\  
		& \{ {\inside{\prg{a.key}}}\ \wedge\ {\PushASLong {\prg{res}} {\inside{\prg{a.key}}} } \wedge \prg{a.\balance}\geq b \  \} \ \ \  || \ \ \ 
		   \{ {\inside{\prg{a.key}}} \wedge \prg{a.\balance}\geq b \  \}
\\
\text{(33?)}  \ \ \ \ M_{good} \vdash \ 
		&	\{  \ \Alocalsset, \, \prg{a}:\prg{Account}\, , b:\prg{int} \, \wedge\,  {\inside{\prg{a.key}}} \, \wedge \, \protectedFrom {\prg{a.key}} {\Idsset}  \ \wedge \prg{a.\balance}\geq b \  \} \\
		& \SPT \prg{Account}::\prg{set}.\prg{body}\ \\  
 		& \{ {\inside{\prg{a.key}}}  \wedge\ {\PushASLong {\prg{res}} {\inside{\prg{a.key}}}}   \wedge \prg{a.\balance}\geq b \  \}\ \ \  || \ \ \ 
		   \{ {\inside{\prg{a.key}}} \wedge \prg{a.\balance}\geq b \  \} 
\end{align*}
\normalsize
where we are using ? to indicate that this needs to be proven, and 
where we are using the shorthands $\Alocals$,   $\Ids$, $\Alocalstr$, $\Idstr$, $\Alocalsset$ as defined earlier.

 \end{proofO}
 
The proofs for $M_{fine}$ are similar.

%
 We outline the proof of (31?) in Lemma \ref{l:buy:sat:S3}  in \S \ref{s:buy:sat:S3}.

\subsubsection{Proving that \prg{Shop::buy} from $M_{good}$ satisfies $\SThreeStrong$}
\label{s:buy:sat:S3}

\begin{lemma}
\label{l:buy:sat:S3}
 
\begin{align*}
\text{(31)}  \ \ \ \ M_{good}\ \vdash  \  \ 
		&	\{  \ \Alocals, \, \prg{a}:\prg{Account}, b:\prg{int}, \, \wedge\, {\inside{\prg{a.key}}} \, \wedge \, \protectedFrom {\prg{a.key}} {\Ids} \wedge \prg{a.\balance}\geq b \  \} \\
		& \SPT \prg{Shop}::\prg{buy}.\prg{body}\ \\  
		& \{ {\inside{\prg{a.key}}}\ \wedge\ {\PushASLong {\prg{res}} {\inside{\prg{a.key}}}}  \wedge \prg{a.\balance}\geq b \} \ \ \  || \ \ \ 
		   \{ {\inside{\prg{a.key}}}  \wedge \prg{a.\balance}\geq b \}
\end{align*}

\end{lemma}

\begin{proofO}
This proof is similar to the proof of lemma \ref{l:buy:sat}.
We will use the shorthand $\Alocalsb \triangleq \Alocals, \,\prg{a}:\prg{Account}, b:\prg{int}$.
We will split the proof into 1) proving that statements 10, 11, 12 preserve the protection of \prg{a.key} from the \prg{buyer}, 2) proving that the external call 

\step{1st Step: proving statements 10, 11, 12}

We apply the underlying Hoare logic and prove that the statements on lines 10, 11, 12 do not affect the value of \prg{a.key} nor that of \prg{a.\balance}.  Therefore, for a $z,z'\notin \{ \prg{price}, \prg{myAccnt}, \prg{oldBalance} \}$, we have 

\begin{align*}
\text{(40)}  \ \ \ \ {M_{good} \vdash_{ul}} 
		&	\{  \ \Alocalsb\  \wedge\ z=\prg{a.key} \wedge\ z'=\prg{a.\balance}  \} \\
		&   \SPT \prg{price:=anItem.price}; \\  
		&   \SPT \prg{myAccnt:=this.accnt}; \\  
                 &   \SPT \prg{oldBalance := myAccnt.blnce};\\
		& \{ z=\prg{a.key} \wedge\ z'=\prg{a.\balance} \}
\end{align*}

We then apply {\sc{Embed\_UL}}, {\sc{Prot-1}} and {\sc{Prot-2}} and {\sc{Combine}} and and {\sc{Types-2}} on (10) and use the shorthand $\stmtsP$ for the statements on lines 10, 11 and 12, and obtain: 
\\
\begin{align*}
\text{(41)}  \ \ \ \ M_{good} \vdash 
		&	\{  \ \Alocalsb\  \wedge\ {\inside{\prg{a.key}}} \, \wedge\, \protectedFrom{\prg{buyer}} {\prg{a.key}} \wedge\ z'=\prg{a.\balance}  \} \\
		& \SPT \stmtsP\ \\  
		& \{ \ {\inside{\prg{a.key}}}  \, \wedge\, \protectedFrom{\prg{buyer}} {\prg{a.key}} \wedge\ z'=\prg{a.\balance}   \}
\end{align*}



We apply  {\sc{Mid}}  on (11) and obtain 
\begin{align*}
\text{(42)}  \ \ \ \ M_{good} \vdash 
		&	\{  \ \Alocalsb\, \wedge\, \protectedFrom {\prg{a.key}} {\prg{buyer}}\ \wedge\ z'=\prg{a.\balance}  \} \\
		& \SPT \stmtsP\ \\  
		& \{ \ \Alocalsb\, \wedge \  {\inside{\prg{a.key}}} \, \wedge\, \protectedFrom{\prg{buyer}} {\prg{a.key}}  \ \wedge\ z'=\prg{a.\balance}  \} \ \ || \\
		& \{ \ {\inside{\prg{a.key}}}\  \wedge\ z'=\prg{a.\balance} \}
\end{align*}

\step{2nd Step: Proving the External Call}

 

We now need to prove that the external method call \prg{buyer.pay(this.accnt, price)} protects the \prg{key}, and does nit decrease the balance, i.e.
\small
\begin{align*}
\text{(43?)} \ \ \ M_{good} \vdash & \{ \ \Alocalsb \   \wedge\    {\inside{\prg{a.key}}} \, \wedge\, \protectedFrom {\prg{a.key}} {\prg{buyer}} \wedge\ z'= \prg{a.\balance}  \} \\
		  		& \SPT  \prg{tmp := buyer.pay(myAccnt, price)}\ \\  
		  		& \{ \ \ \ \Alocalsb \ \wedge\ {\inside{\prg{a.key}}} \, \wedge\, \protectedFrom{\prg{buyer}} {\prg{a.key}} \wedge \ \prg{a.\balance}\geq z'\  \} \ \ \  || \ \ \  \\
		  		&   \{ \   {\inside{\prg{a.key}}}\ \wedge \  \prg{a.\balance}\geq z'  \}
\end{align*}
\normalsize

We use that $M \vdash \TwoStatesN  {\prg{a}:\prg{Account},\prg{b}:\prg{int}, }  {\inside{\prg{a.key}} \wedge \prg{a.\balance}\geq z'}   $
 and  obtain
 \\
 \small
\begin{align*}
\text{(44)} \ \ \ M_{good} \vdash & \{ \ \prg{buyer}:\prg{external},\,  {\inside{\prg{a.key}}} \, \wedge\, 
\protectedFrom {\prg{a.key}} {(\prg{buyer},\prg{myAccnt},\prg{price})} \  \wedge\ z'\geq \prg{a.\balance}  \} \\
		  		& \SPT  \prg{tmp := buyer.pay(myAccnt, price)}\ \\  
		  		& \{ \ \inside{\prg{a.key}} \, \wedge\, 
\protectedFrom {\prg{a.key}} {(\prg{buyer},\prg{myAccnt},\prg{price})}\ \wedge\ z'\geq \prg{a.\balance}  \} \ \ \  || \ \ \  \\
		  		&   \{ \   {\inside{\prg{a.key}}}\  \wedge\ z'\geq \prg{a.\balance}  \}
\end{align*}
\normalsize 
 
In order to obtain (43?) out of (44), we apply \textsc{Prot-Intl} and \textsc{Prot-Int}$_1$,   which gives us\\
$
\begin{array}{llll}
& (45) & & M_{good} \vdash \Alocalsb \wedge  {\inside{\prg{a.key}}}\  \longrightarrow\ \protectedFrom {\prg{a.key}} {\prg{myAccnt}} 
\\
& (46) & & M_{good} \vdash \Alocalsb \wedge  {\inside{\prg{a.key}}}\  \longrightarrow\ \protectedFrom {\prg{a.key}} {\prg{price}} 
\\
& (47) & & M_{good} \vdash \Alocalsb \wedge  z'= \prg{a.\balance}\   \longrightarrow\  z'\geq \prg{a.\balance} 
\end{array}
$

We apply {\textsc{Consequ}} on (44), (45), (46) and (47) and obtain (43)!

\normalsize

\step{3nd Step: Proving the Remainder of the Body}

 We now need to prove that lines 15-19 of the method preserve the protection of \prg{a.key}, and do not decrease \prg{a.balance}.
 We outline the  remaining proof in less detail.
 
 We prove the internal call on line 16, using the method specification for \prg{send}, using $S_{2a}$ and $S_{2b}$, and applying rule {\sc{[Call\_Int]}}, and obtain

 \small
\begin{align*}
\text{(48)} \ \ \ M_{good}\  \vdash \ & \{ \ \prg{buyer}:\prg{external},\, \prg{item}:\prg{Intem} \wedge {\inside{\prg{a.key}}} \, \wedge\, 
\protectedFrom {\prg{a.key}} {(\prg{buyer}}  \  \wedge\ z'= \prg{a.\balance}  \} \\
		  		& \SPT  \prg{tmp := this.send(buyer,Item)}\ \\  
		  		& \{ \ \inside{\prg{a.key}} \, \wedge\, 
\protectedFrom {\prg{a.key}} {\prg{buyer}} \ \wedge\ z'= \prg{a.\balance}  \} \ \ \  || \ \ \  \\
		  		&   \{ \   {\inside{\prg{a.key}}}\  \wedge\ z'= \prg{a.\balance}  \}
\end{align*}
\normalsize  
 

We now need to prove that the external method call \prg{buyer.tell("You have not paid me")} also protects the \prg{key}, and does nit decrease the balance. We can do this by applying the rule about protection from strings  {\sc{[Pror\_Str]}}, the fact that $M_{good} \vdash S_{3}$, and rule  {\sc{[Call\_Extl\_Adapt]}} and obtain:


 \small
\begin{align*}
\text{(50)} \ \ \ M_{good}\  \vdash \ & \{ \ \prg{buyer}:\prg{external},\, \prg{item}:\prg{Intem} \wedge {\inside{\prg{a.key}}} \, \wedge\, 
\protectedFrom {\prg{a.key}} {(\prg{buyer}}  \  \wedge\ z'/geq  \prg{a.\balance}  \} \\
		  		& \SPT  \prg{tmp:=buyer.tell("You have not paid me")}\ \\  
		  		& \{ \ \inside{\prg{a.key}} \, \wedge\, 
\protectedFrom {\prg{a.key}} {\prg{buyer}} \ \wedge\ z'\geq \prg{a.\balance}  \} \ \ \  || \ \ \  \\
		  		&   \{ \   {\inside{\prg{a.key}}}\  \wedge\ z'\geq  \prg{a.\balance}  \}
\end{align*}
\normalsize 

We can now apply  {\sc{[If\_Rule}}, and {\sc{[Conseq}}, and obtain

 \small
\begin{align*}
\text{(50)} \ \ \ M_{good}\  \vdash \ & \{ \ \prg{buyer}:\prg{external},\, \prg{item}:\prg{Intem} \wedge {\inside{\prg{a.key}}} \, \wedge\, 
\protectedFrom {\prg{a.key}} {(\prg{buyer}}  \  \wedge\ z'/geq  \prg{a.\balance}  \} \\
		  		& \SPT  \prg{if} ... \prg{then}\\
				& \SPT \SPT  \prg{tmp:=this.send(buyer,anItem)}\ \\  
				& \SPT  \prg{else}\\
				& \SPT \SPT  \prg{tmp:=buyer.tell("You have not paid me")}\ \\  
		  		& \{ \ \inside{\prg{a.key}} \, \wedge\, 
\protectedFrom {\prg{a.key}} {\prg{buyer}} \ \wedge\ z'\geq \prg{a.\balance}  \} \ \ \  || \ \ \  \\
		  		&   \{ \   {\inside{\prg{a.key}}}\  \wedge\ z'\geq  \prg{a.\balance}  \}
\end{align*}
\normalsize 

The rest follows through application of {\sc{[Prot\_Int}}, and {\sc{[Seq]}}.



\end{proofO}

