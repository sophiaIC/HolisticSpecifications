\section{Appendix to Section \ref{sect:sound:proofSystem} -- Soundness of the Hoare Logics}

\subsubsection{Deep adherence of assertions}
\label{s:deep:mean}{

\begin{definition}% [State Restriction, and Multi-level Sartisfaction]
\label{def:restrict}
For a state $\sigma$, and a number $i\in \mathbb{N}$ with $i \leq \DepthSt {\sigma}$,   module $M$, and assertions $A$, $A'$ we define: % $\RestictTo {\sigma} {i}$:
\begin{itemize}
\item
 $\RestictTo {(\phi_1...\phi_i...\phi_n,\chi)} {i}\ \ \ \triangleq \ \ \ (\phi_1...\phi_i,\chi)$
%\end{itemize} 
%
%\noindent
%And for module  $M$, state $\sigma$, and $k\in \mathbb{N}$ with $k\leq \DepthSt {\sigma}$, and assertions $A$, $A'$:
%\begin{itemize}
\item
$  \satDAssertFrom M  \sigma k   A  \ \  \ \triangleq \  \ \  
  k\leq  \DepthSt {\sigma} \ \wedge \  \forall i\geq k.[\ M,{\RestictTo {\sigma}{i}} \models A[\overline{ {{\interpret \sigma z}/ z}}]\ ] \ \  \mbox{where} \ \
  \overline z=\fv(A).$ 
\end{itemize}
\end{definition}
 
  
 
\begin{lemma}
\label{l:shallow:deep}
For a states $\sigma$, $\sigma'$, numbers $k,k'\in \mathbb{N}$, assertions  $A$, $A'$, frame $\phi$ and variables $\overline z$, $\overline u$:
\begin{enumerate}
\item
$ \satDAssertFrom M  \sigma { \DepthSt \sigma}   A \ \ \Longleftrightarrow\ \ M,\sigma \models A\ $
\item
$ M,\sigma \models A \ \wedge\  k\leq k'\  \  \   \Longrightarrow \ \ \satDAssertFrom M  \sigma {k'} A$ 
\item 
\label{shallow:to:deep}
$ M,\sigma \models A \ \wedge\ \Stable A \  \ \Longrightarrow \  \  \forall k  \leq  \DepthSt \sigma.[ \ \satDAssertFrom M  \sigma k   A \ ]$
\item
\label{fourSD}
$ M  \models A \rightarrow A'\  \  \   \Longrightarrow \ \ \forall \sigma. \forall k\leq  { \DepthSt \sigma}.[ \ \satDAssertFrom M  \sigma {k} A
\ \Longrightarrow \  \satDAssertFrom M  \sigma {k} A'\ ]$
\item
\label{fiveSD}
$\fv(A)=\overline z\ \wedge\ \sigma'=\sigma  \pushSymbol \phi\ \wedge\   \overline {\interpret \sigma z= {\interpret {\sigma'} u}}\ \ \Longrightarrow\ \ 
[\ \satDAssertFrom M  \sigma {k} A  
\ \ \Longleftrightarrow \ \ \satDAssertFrom M  {\sigma'} {k+1} {A[{\overline{u/z}}]}\ ]$
\end{enumerate}
\end{lemma}
 

\noindent
{The proof of \ref{l:shallow:deep}.\ref{fourSD} is by contradiction: Find a $\sigma$, a $k$ and   such that  
$\forall i\geq k.[M,{\RestictTo {\sigma}{i}} \models A[[\overline{ {{\interpret \sigma z}/ z}}]$, and
$\exists j\geq k.[M,{\RestictTo {\sigma}{j}} \not\models A'[[\overline{ {{\interpret \sigma z}/ z}}]$
 such that $\overline z = \fv(A)$.
 Take $\sigma''\triangleq \sigma \RestictTo {\sigma}{j}$, and then we have that
 $M, \sigma'' \models A[[\overline{ {{\interpret \sigma z}/ z}}]$ and  $M,  \sigma'' \not\models A'[[\overline{ {{\interpret \sigma z}/ z}}]$.
 This contradicts $ M  \models A \rightarrow A'$.
 Here we are also using the property that $M \models A$  and $u\notin \fv(A)$ implies $M \models A[u/z]$ -- this is needed because we have free variables in $A$ which are not free in $A[...]$}
 {\footnoteSD{NOTE TO AUTHORS  proof hinges on the fact that we consider the "restricted" state, $\sigma''$ a "dully-fledged" state, and the fact that we no longer require "Arising".}}
 {\footnoteSD{SD  wondered whether  \ref{l:shallow:deep}.\ref{four} would still hold if we allowed the assertions to "reflect" on the frame, to say things eg like "this and x are the only local variables". But such assertions would not have the property \ref{l:shallow:deep}.\ref{fiveSD}}}


 
 
\subsubsection{Deep adherence of specifications} 
%\subsection{Deep satisfaction of specifications -- \red{better term than deep?}}  
\label{sect:HLmeans}

{
\begin{definition} 
\label{def:restrict}
For modules $\Mtwo$, $M$, state $\sigma$, and $k\in \mathbb{N}$ with $k\leq \DepthSt {\sigma}$, and assertions $A$, $A'$ and  $A''$
\begin{itemize}
\item
$ {\satDAssertQuadrupleFrom \Mtwo  M  \sigma   {A} {A'} {A''} } \ \ \triangleq \ \ $  \\
$\strut \hspace{.5cm} \forall k,\overline{\alpha}, \overline{z}, \sigma',\sigma''.[
\    %\ \fv(A)=\overline x \, \wedge\,    {\GRelevant {\overline \alpha}  \sigma}
  \satDAssertFrom M  \sigma k   {A[\overline{\alpha/x}]} \   \, \wedge\,  k \leq  \DepthSt {\sigma}\   \ \Longrightarrow$\\
$\strut \hspace{4.5cm}    [ \ {\leadstoBoundedStarFin {M\madd \Mtwo}{\sigma}  {\sigma'} }\  \Rightarrow \    \satDAssertFrom M  {\sigma'} k   {A'[\overline{\alpha/x}}]\ ]  \ \wedge$\\
$\strut \hspace{4.5cm}    [ \ {\leadstoBoundedStar  {M\madd \Mtwo}{\sigma}  {\sigma''} }\  \Rightarrow\      \satDAssertFrom M  {\sigma''}  k  {(\externalexec \rightarrow A''[\overline{\alpha/x}])} \ ] $\\
$\strut \hspace{2.3cm}\ \ \  \ \ \ \mbox{where } \overline z={{\fv(A)\setminus\vs(\sigma.\prg{cont})}}\ \ \ ]$
\end{itemize}
\end{definition}
}

\begin{lemma} 
For all $M$, $\Mtwo$ $A$, $A'$, $A''$ and $\sigma$:
\begin{itemize}
\item
$ {\satDAssertQuadrupleFrom \Mtwo  M  \sigma   {A} {A'} {A''} } \ \Longrightarrow \ \
  {\satAssertQuadruple  \Mtwo  M   {A}  \sigma  {A'} {A''} } $
\end{itemize}
\end{lemma}

We now give a deeper meaning to specifications: 

\begin{definition} [Deep Semantics of  Specifications]

We define $\satisfiesD{M}{{S}}$ by cases: %  over the three possible syntactic forms.

\label{def:necessity-semantics:strong}

\begin{enumerate}
\item
{ 
$\satisfiesD{M}{\TwoStatesN {\overline {x:C}} {A}} \ \  \ \triangleq   \ \ \ 
\forall \sigma.[\  \satisfiesD {M} {\quadruple {\externalexec \wedge \overline {x:C} \wedge A} {\sigma} {A} {A} } \ ] $
}
  \item
 {$\satisfiesD{M} { \mprepostN {A_1}{p\ D}{m}{y}{D}{A_2} {A_3}    }\  \ \ \   \triangleq  \ \ \ $}\\ 
 {
$\strut  \ \ \   \ \ \ \ \ \ \ \ \   \    \forall   y_0,\overline y, \sigma[ \ \ \ \sigma\txteq {u:=y_0.m(y_1,..y_n)} \ \ \Longrightarrow \ \ 
\satisfiesD {M} {\quadruple  {A_1'} }   {\sigma}   {A_2' } {A_3' }  \  \ \  ]$ } \\
$\strut \ \ \   \ \ \ \ \ \ \ \ \   \  \mbox{where}$\\
$\strut  \ \ \   \ \ \ \ \ \ \ \ \   \  \ A_1' \triangleq   y_0:D,{\overline {y:D}}   \wedge   A[y_0/\prg{this}],\  \  A_2' \triangleq A_2[u/res,y_0/\prg{this}],\ \ A_3' \triangleq A_3[y_0/\prg{this}] $
 \item
 $\satisfiesD{M}{S\, \wedge\, S'}$\ \ \  \ \ \  $\triangleq$  \  \ \  \   $\satisfiesD{M}{S}\ \wedge \ \satisfiesD{M}{S'}$
\end{enumerate}
\end{definition}

 \begin{definition}[Deep Semantics of Hoare tuples]
\label{def:hoare:sem}
 
For modules $M$, and assertions $A$, $A'$   we define:
%  the semantics of Hoare-triples,   $M\ \models\  \{\, A \,  \}\ stmt\  \{\, A' \, \}$ as follows:
\begin{itemize}
\item
\label{def:hoare:sem:one}
$\satisfies  {M} {  \{\, A \,  \}\ stmt\  \{\, A' \, \} }\ \ \ \triangleq$\\
{$\strut  \ \ \ \forall    \Mtwo. \forall  \sigma.[ \ \   %\arising{\sigma}{M\madd \Mtwo }\   \wedge\  
 \sigma.\prg{cont}\txteq stmt\   \Longrightarrow \ 
{\satAssertQuadruple  \Mtwo  M   {\  A\ }  \sigma  { A'  } {true} } \ \ ]$%  \ \ \  ]  $
}
 \item
 \label{def:hoare:sem:two}
$\satisfies {M} {\quadruple {A} {stmt} {A'} {A''}}  \ \ \  \triangleq$ \\
{$\strut  \ \ \  \forall    \Mtwo. \forall  \sigma.[ \  \  \sigma.\prg{cont}\txteq stmt\   \Longrightarrow \ 
{\satAssertQuadruple  \Mtwo  M    {\  A\ }  \sigma  { A'  } {A''} } \ \ ]$%  \ \ \  ]  $
}
\item
\label{def:hoare:sem:three}
$\satisfiesD {M} {  \{\, A \,  \}\ stmt\  \{\, A' \, \} }\ \ \ \triangleq$\\
{$\strut  \ \ \ \forall    \Mtwo. \forall  \sigma.[ \ \   %\arising{\sigma}{M\madd \Mtwo }\   \wedge\  
 \sigma.\prg{cont}\txteq stmt\   \Longrightarrow \ 
{\satDAssertQuadrupleFrom \Mtwo  M  \sigma   {\  A\ } { A'  } {true} } \ \ ]$%  \ \ \  ]  $
}
 
 \item
 \label{def:hoare:sem:four}
$\satisfiesD {M} {\quadruple {A} {stmt} {A'} {A''}}  \ \ \  \triangleq$ \\
{$\strut  \ \ \  \forall    \Mtwo. \forall  \sigma.[ \ \    \sigma.\prg{cont}\txteq stmt\   \Longrightarrow \ 
{\satDAssertQuadrupleFrom \Mtwo  M  \sigma   {\  A\ } { A'  } {A''} } \ \ ]$%  \ \ \  ]  $
}

\end{itemize}
\end{definition}
 
 \begin{lemma}[Deep   vs Shallow Semantics of Quadruples]
For all $M$, $A$, $A'$, $stmt$, and $S''$
\begin{itemize}
\item
$\satisfiesD {M} {\quadruple {A} {stmt} {A'} {A''}}   \ \ \ \Longrightarrow \ \ \ \satisfies  {M} {\quadruple {A} {stmt} {A'} {A''}} $
\end{itemize}
\end{lemma}
