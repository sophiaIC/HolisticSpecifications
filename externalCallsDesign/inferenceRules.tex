We discussed a lot of variations of inference rules. But in the end, 
Sophia thinks that we need no more than a way to argue that a sequence of "known" code and calls to   unknown code  satisfies a Hoare triple. And I now think we do not need to "go beyond" Hoare triple notation. :-)

Note that here, the code about which we are reasoning (ie creating Hoare triples) does not need to be coming from the "safe" module. Instead, we may be reasoning about  code which is a client of the "safe" module. That is, we have three "views": the code being checked, i.e., $stmts_1;\ stmts_2$ below, the "unknown" code (here the calls in $stmts_2$), and the "safe" module, $\Mod{}$, which satisfies the specification \SpecB{}. it is possible that in $stmts_1$ we have calls to function from $\Mod{}$, and we could reason about them using their pre- and post-conditions. \footnote{The above should address the question that was raised by Peter Mueller when he read section 2.3.1. I fear it is not that crisp... HELP.}

\subsection{Rule-1}
\label{sect:rone}

We believe that the current rule would be sound:

\begin{mathpar}
\infer
	{
	\ \ \ \ \ \ \ \ \ \ \ \Mod{},\,  \SpecB{} \ \vdash\  \hoare{A_1}{stms_1} {A_2} \ \
	 \ \ \ \ \ \ \ \ \ \\
	stmts_2 \   \mbox{ consists exclusively of calls to "unknown" objects}\ \ 
 \\
	\overline{z} \mbox{ are all the variables passed as arguments in }  stmts_2
	\\
	\Out{A_2}{\overline{z}}=A_3\ \ \ \ \ \ \ \ \ {\Preserve{A_3} {\SpecB{}} {\Mod{}}  = {A_4}}
	}
	{
	\Mod{}, \, \SpecB{} \ \vdash\  \hoare
		{A_1}
		{stmts_1; \ stmts_2}
		{A_4}
	}
\end{mathpar} 


In the above, the term $\Out{A}{\overline{z}}$ returns an assertion $A'$ which is essentially $A$, with the difference that all elements from ${\overline{z}}$ are considered as $\outside{\_}$. 
Moreover,   ${\Preserve{A} {\SpecB{}} {\Mod{}} }$, contains the parts of $A$ that are preserved through  $\SpecB{}$.\footnote{needs better explanation.}

\begin{definition}
We define the  function \Out{\_}{\_}  below:

$\begin{array}{llll}
\Out{A}{\epsilon} & \triangleq & A
\\
\Out{A}{(z,\overline{z})} & \triangleq & \Out{\Out{A}{z}} {\overline{z}} 
\\
\Out{true}{z} & \triangleq & true \wedge \outside{z}
\\
\Out{false}{z} & \triangleq & false \wedge \outside{z}
\\
\Out{\inside{u}}{z} & \triangleq & (u\neq z \wedge  {\inside{u}} \vee u=z) \wedge  \outside{z}
\\
\Out{\outside{u}}{z} & \triangleq &  {\outside{u}}   \wedge  \outside{z}
\\
\Out{p=p'}{z} & \triangleq &  {p=p'}   \wedge  \outside{z}& \mbox{where }p, p' \mbox{ are paths}
\\
\Out{A \wedge A'}{z} & \triangleq &  \Out{A}{z}   \wedge \Out{A'}{z}
\\
\Out{A \vee A'}{z} & \triangleq &  \Out{A}{z}   \vee \Out{A'}{z}
\\
\Out{\neg A}{z} & \triangleq &???
\\
\Out{\forall u.A}{z} & \triangleq &\forall u. \Out{A}{z}
\\
\Out{\exists u.A}{z} & \triangleq &\exists u. \Out{A}{z}\footnote{here we also need a $\Mod{}$}
\\
\Out{Q(u)}{z} & \triangleq & \Out{Qbody[x/u]}{z} & \mbox{ where } Q \mbox{ is inductively defined }
\end{array}
$
\end{definition}

 \begin{lemma}
 If $\Out {A} {z}$=$A'$, then $A \rightarrow A'$, and $A' \rightarrow \outside{z}$. \footnote{here we also need a $\Mod{}$}
 \end{lemma}
 
 We will now define the preservation function:
 
 \begin{definition}
We define ${\Preserve{A} {\SpecB{}} {\Mod{}}}$ by cases over $\SpecB{}$ and its relation 
to $A$  below:

 
\[
\Preserve{A} {\onlyIf{A_1}{A_2}{A_3}} {\Mod{}}   \  \triangleq \   \begin{dcases*}
\neg A_3 
   & if  $\Mod {} \vdash  A\ \rightarrow \ A_1 \wedge \neg A_3$\,, \\[1ex]
true 
   & otherwise\,.
\end{dcases*} 
\]
 
$\begin{array}{lll}
 \Preserve{A} {\onlyIf{A_1}{A_2}{A_3};\SpecB{}} {\Mod{}}   & \triangleq &   \Preserve{A} {\onlyIf{A_1}{A_2}{A_3}} {\Mod{}}  \ \wedge \  \\
 & &  \Preserve{A} {\SpecB{}} {\Mod{}}
  \\
 \Preserve{A} {\onlyThrough{A_1}{A_2}{A_3};\SpecB{}} {\Mod{}}   & \triangleq &   \Preserve{A} {\SpecB{}} {\Mod{}}
 \\
  \Preserve{A} {\onlyIfSingle{A_1}{A_2}{A_3};\SpecB{}} {\Mod{}}   & \triangleq &   \Preserve{A} {\SpecB{}} {\Mod{}}
 \\

\end{array}
$
\end{definition}

\subsection{Rule-2}

The current rule is not sound (because of \prg{Blackadder}), unless we change even more stuff. Sophia is hopeful, though

\begin{mathpar}
\infer
	{
	\ \ \ \ \ \ \ \ \ \ \ \Mod{},\,  \SpecB{} \ \vdash\  \hoare{A_1}{stms_1} {A_2} \ \
	 \ \ \ \ \ \ \ \ \ 	\\
	\ \ \ \ \ x \ \ \ \mbox{is external} \ \ \
	\OutTwo{A_2}{x,\overline{z}}=A_3\ \ \ \ \ \ \ \ \ {\Preserve{A_3} {\SpecB{}} {\Mod{}}  = {A_4}}
	}
	{
	\Mod{}, \, \SpecB{} \ \vdash\  \hoare
		{A_1}
		{stmts_1; \ x.m(\overline{z})}
		{A_4}
	}
\end{mathpar} 


This rule is similar to that from \ref{sect:rone}, with the only difference that we use $\OutTwo{A_2}{\overline{x,z}}$, 
rather than $\Out{A_2}{\overline{x,z}}$. $\OutTwo{A_2}{\overline{x,z}}$ is meant to restrict visibility to only the objects 
that are transitively accessible from ${\overline{x,z}}$, and then also turns the external $\overline{z}$s into ousiders.
 This assumes that we went with \textbf{From\_Current}. And is breaks down with the
\prg{Blackadder}'s \prg{Box}.


 
